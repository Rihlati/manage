<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta name="theme-color" content="#1a237e">
    <meta name="description" content="Rihlati — Fleet Management">
    <title>Rihlati</title>
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary-color: #1a237e;
            --secondary-color: #3949ab;
            --accent-color: #ff5722;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --text-color: #333;
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --shadow: 0 6px 16px rgba(0,0,0,0.1);
            --sidebar-width: 280px;
            --header-height: 70px;
            --font-en: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-ar: 'Cairo', 'Tajawal', 'Segoe UI', Tahoma, sans-serif;
        }

        body {
            font-family: var(--font-en);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ===== FULL ARABIC / RTL TYPOGRAPHY OVERRIDE ===== */
        body.lang-ar,
        body.lang-ar * {
            font-family: 'Cairo', 'Tajawal', 'Segoe UI', Tahoma, sans-serif !important;
            letter-spacing: 0 !important;
        }

        /* Arabic numbers and monospace exceptions */
        body.lang-ar input[type="number"],
        body.lang-ar input[type="date"],
        body.lang-ar input[type="email"],
        body.lang-ar .recovery-key-box {
            font-family: 'Cairo', 'Segoe UI', Tahoma, sans-serif !important;
            direction: ltr;
            text-align: right;
        }

        /* Login page in Arabic */
        body.lang-ar .login-container {
            direction: rtl;
        }
        body.lang-ar .login-header {
            direction: rtl;
        }
        body.lang-ar .login-form .form-group label {
            text-align: right;
            display: block;
        }
        body.lang-ar .login-form input {
            text-align: right;
        }
        body.lang-ar #tabLoginBtn,
        body.lang-ar #tabSignupBtn {
            font-size: 15px;
            font-weight: 700;
        }

        /* Sidebar in Arabic */
        body.lang-ar .sidebar-header {
            text-align: right;
        }
        body.lang-ar .sidebar-header h2 {
            font-size: 20px;
            font-weight: 800;
        }
        body.lang-ar .nav-item {
            border-left: none !important;
            border-right: 3px solid transparent;
            text-align: right;
            flex-direction: row-reverse;
        }
        body.lang-ar .nav-item:hover,
        body.lang-ar .nav-item.active {
            border-right-color: var(--accent-color) !important;
            border-left-color: transparent !important;
        }
        body.lang-ar .nav-item i {
            margin-left: 10px;
            margin-right: 0;
        }
        body.lang-ar .user-profile {
            flex-direction: row-reverse;
            text-align: right;
        }

        /* Top bar in Arabic */
        body.lang-ar .top-bar {
            direction: rtl;
        }
        body.lang-ar .top-bar h1 {
            font-size: 18px;
            font-weight: 700;
        }
        body.lang-ar .top-bar-actions {
            flex-direction: row-reverse;
        }
        body.lang-ar .sync-status {
            flex-direction: row-reverse;
        }

        /* Tables in Arabic */
        body.lang-ar th,
        body.lang-ar td {
            text-align: right;
        }
        body.lang-ar .table-header {
            direction: rtl;
            flex-direction: row-reverse;
        }
        body.lang-ar .table-header h3 {
            text-align: right;
        }
        body.lang-ar .action-buttons {
            justify-content: flex-end;
            flex-direction: row-reverse;
        }

        /* Cards and stats in Arabic */
        body.lang-ar .stat-header {
            flex-direction: row-reverse;
        }
        body.lang-ar .stat-value,
        body.lang-ar .stat-label {
            text-align: right;
        }
        body.lang-ar .stats-grid {
            direction: rtl;
        }
        body.lang-ar .summary-grid {
            direction: rtl;
        }

        /* Modals in Arabic */
        body.lang-ar .modal-content {
            direction: rtl;
        }
        body.lang-ar .modal-header {
            flex-direction: row-reverse;
        }
        body.lang-ar .modal-header h3 {
            font-size: 17px;
            font-weight: 700;
        }
        body.lang-ar .form-grid {
            direction: rtl;
        }
        body.lang-ar .form-section-divider {
            text-align: right;
            font-size: 14px;
            font-weight: 700;
        }
        body.lang-ar .form-group label {
            text-align: right;
            font-weight: 600;
            font-size: 13px;
        }
        body.lang-ar .form-group input,
        body.lang-ar .form-group select,
        body.lang-ar .form-group textarea {
            text-align: right;
            font-size: 14px;
        }
        body.lang-ar select {
            background-position: left 12px center;
            padding-right: 14px;
            padding-left: 32px;
        }

        /* Buttons in Arabic */
        body.lang-ar .btn {
            font-size: 14px;
            font-weight: 700;
            letter-spacing: 0;
        }

        /* Badges in Arabic */
        body.lang-ar .badge {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0;
        }

        /* Main content margin flip for RTL sidebar */
        body.lang-ar .main-content {
            margin-left: 0;
            margin-right: var(--sidebar-width);
        }

        /* Sidebar position flip */
        body.lang-ar .sidebar {
            left: auto;
            right: 0;
            transform: translateX(100%);
            box-shadow: -5px 0 20px rgba(0,0,0,0.1);
            border-right: none;
            border-left: 1px solid rgba(255,255,255,0.08);
        }
        body.lang-ar .sidebar.show,
        body.lang-ar .sidebar.mobile-open {
            transform: translateX(0);
        }

        /* Toast in Arabic */
        body.lang-ar .toast {
            right: auto;
            left: 30px;
            direction: rtl;
        }

        /* Permissions panel */
        body.lang-ar .perm-row {
            flex-direction: row-reverse;
        }
        body.lang-ar .perm-row-label,
        body.lang-ar .perm-row-desc {
            text-align: right;
        }

        /* Ticket rows */
        body.lang-ar .ticket-row-maintenance td:first-child {
            border-left: none;
            border-right: 4px solid #ff9800;
        }
        body.lang-ar .ticket-row-fuel td:first-child {
            border-left: none;
            border-right: 4px solid #2196f3;
        }
        body.lang-ar .ticket-row-leave td:first-child {
            border-left: none;
            border-right: 4px solid #e91e63;
        }

        /* Step indicator */
        body.lang-ar .step-indicator {
            direction: rtl;
        }

        /* Ticket detail rows */
        body.lang-ar .ticket-detail-row {
            flex-direction: row-reverse;
            text-align: right;
        }

        /* Chart */
        body.lang-ar .chart-container {
            direction: rtl;
        }
        body.lang-ar .chart-title {
            text-align: right;
            font-weight: 700;
        }

        /* H tags in Arabic */
        body.lang-ar h1,
        body.lang-ar h2,
        body.lang-ar h3,
        body.lang-ar h4 {
            font-weight: 800;
            letter-spacing: 0;
        }

        /* Empty state in Arabic */
        body.lang-ar .empty-state {
            direction: rtl;
        }

        /* Mobile responsive Arabic sidebar */
        @media (max-width: 768px) {
            body.lang-ar .sidebar {
                transform: translateX(100%);
            }
            body.lang-ar .sidebar.mobile-open {
                transform: translateX(0);
            }
            body.lang-ar .main-content {
                margin-right: 0;
            }
        }

        /* ===== END ARABIC STYLES ===== */

        [dir="rtl"] .sidebar {
            left: auto;
            right: 0;
            transform: translateX(100%);
            box-shadow: -5px 0 20px rgba(0,0,0,0.1);
            border-right: none;
            border-left: 1px solid rgba(255,255,255,0.08);
        }

        [dir="rtl"] .sidebar.mobile-open {
            transform: translateX(0);
        }

        [dir="rtl"] .main-content {
            margin-left: 0;
            margin-right: var(--sidebar-width);
        }

        [dir="rtl"] .nav-item {
            border-left: none;
            border-right: 3px solid transparent;
            text-align: right;
        }

        [dir="rtl"] .nav-item:hover,
        [dir="rtl"] .nav-item.active {
            border-right-color: var(--accent-color);
            border-left-color: transparent;
        }

        [dir="rtl"] .top-bar {
            direction: rtl;
        }

        [dir="rtl"] .table-header {
            direction: rtl;
            text-align: right;
        }

        [dir="rtl"] th,
        [dir="rtl"] td {
            text-align: right;
        }

        [dir="rtl"] .stat-header {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .modal-header {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .form-grid {
            direction: rtl;
        }

        [dir="rtl"] .form-section-divider {
            text-align: right;
        }

        [dir="rtl"] .badge {
            font-family: var(--font-ar);
        }

        [dir="rtl"] .ticket-row-maintenance td:first-child {
            border-left: none;
            border-right: 4px solid #ff9800;
        }
        [dir="rtl"] .ticket-row-fuel td:first-child {
            border-left: none;
            border-right: 4px solid #2196f3;
        }
        [dir="rtl"] .ticket-row-leave td:first-child {
            border-left: none;
            border-right: 4px solid #e91e63;
        }

        [dir="rtl"] .action-buttons {
            justify-content: flex-end;
        }

        [dir="rtl"] .user-profile {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .step-indicator {
            direction: rtl;
        }

        [dir="rtl"] .ticket-detail-row {
            flex-direction: row-reverse;
            text-align: right;
        }

        [dir="rtl"] .perm-row {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .perm-row-label,
        [dir="rtl"] .perm-row-desc {
            text-align: right;
        }

        [dir="rtl"] .sync-status {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .top-bar-actions {
            flex-direction: row-reverse;
        }

        [dir="rtl"] .login-container {
            direction: rtl;
        }

        [dir="rtl"] .login-form label {
            text-align: right;
        }

        [dir="rtl"] .summary-grid {
            direction: rtl;
        }

        [dir="rtl"] .stats-grid {
            direction: rtl;
        }

        [dir="rtl"] .toast {
            right: auto;
            left: 30px;
        }

        /* Arabic typography refinements */
        [dir="rtl"] h1, [dir="rtl"] h2, [dir="rtl"] h3, [dir="rtl"] h4 {
            font-family: var(--font-ar);
            font-weight: 700;
            letter-spacing: 0;
        }

        [dir="rtl"] .btn {
            font-family: var(--font-ar);
            letter-spacing: 0;
        }

        [dir="rtl"] input, [dir="rtl"] select, [dir="rtl"] textarea {
            font-family: var(--font-ar);
            text-align: right;
        }

        [dir="rtl"] select {
            background-position: left 12px center;
        }

        [dir="rtl"] .nav-item i {
            order: 1;
        }

        [dir="rtl"] .nav-item span {
            order: 0;
            flex: 1;
        }

        /* Login page RTL adjustments */
        [dir="rtl"] #loginPage .login-header {
            direction: rtl;
        }

        [dir="rtl"] #loginPage .form-group label {
            text-align: right;
        }

        [dir="rtl"] #loginPage input {
            text-align: right;
        }

        [dir="rtl"] #loginPage .login-form > div:first-child {
            text-align: left;
        }

        /* Fix auth tab text */
        [dir="rtl"] #tabLoginBtn,
        [dir="rtl"] #tabSignupBtn {
            font-family: var(--font-ar);
        }

        /* Stat cards RTL */
        [dir="rtl"] .stat-value,
        [dir="rtl"] .stat-label {
            text-align: right;
        }

        /* Table improvements in RTL */
        [dir="rtl"] .table-header h3 {
            text-align: right;
        }

        [dir="rtl"] .badge {
            font-family: var(--font-ar);
            font-size: 11px;
        }

        /* Modal improvements in RTL */
        [dir="rtl"] .modal-content {
            direction: rtl;
        }

        [dir="rtl"] .modal-header h3 {
            font-family: var(--font-ar);
        }

        [dir="rtl"] .form-group label {
            text-align: right;
        }

        [dir="rtl"] .form-group input,
        [dir="rtl"] .form-group select,
        [dir="rtl"] .form-group textarea {
            text-align: right;
            font-family: var(--font-ar);
        }

        /* Empty state RTL */
        [dir="rtl"] .empty-state {
            direction: rtl;
        }

        /* Ticket type cards RTL */
        [dir="rtl"] .ticket-type-card {
            direction: rtl;
        }

        /* Chart in RTL */
        [dir="rtl"] .chart-container {
            direction: rtl;
        }

        [dir="rtl"] .chart-title {
            text-align: right;
        }

        /* Progress bar RTL */
        [dir="rtl"] .progress-fill {
            background: linear-gradient(270deg, var(--success-color), var(--info-color));
        }

        /* Sidebar bottom logout fix for RTL */
        [dir="rtl"] .sidebar > .nav-item:last-of-type {
            margin: 0 20px;
        }

        /* User profile details RTL */
        [dir="rtl"] .user-details {
            text-align: right;
        }

        /* Top bar title center-ish in RTL */
        [dir="rtl"] #currentPageTitle {
            font-family: var(--font-ar);
        }

        /* Settings section RTL */
        [dir="rtl"] .settings-section {
            direction: rtl;
            text-align: right;
        }

        /* Step indicator RTL */
        [dir="rtl"] .step-dot {
            font-family: var(--font-ar);
        }

        /* Perm section title RTL */
        [dir="rtl"] .perm-section-title {
            text-align: right;
        }

        /* Role form header RTL */
        [dir="rtl"] .role-form-header {
            flex-direction: row-reverse;
            border-left: none;
            border-right: 4px solid;
        }

        [dir="rtl"] .form-section-divider {
            letter-spacing: 0;
        }

        @media (min-width: 769px) {
            [dir="rtl"] .sidebar {
                transform: translateX(0);
            }
        }

        @media (max-width: 768px) {
            [dir="rtl"] .main-content {
                margin-right: 0;
            }
            [dir="rtl"] .sidebar {
                right: 0;
                left: auto;
                transform: translateX(100%);
            }
            [dir="rtl"] .sidebar.mobile-open {
                transform: translateX(0);
            }
        }

        /* Loading Spinner */
        #globalLoader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== PREMIUM LOGIN PAGE ===== */

        /* Full-page split layout */
        #loginPage {
            display: flex;
            min-height: 100vh;
            width: 100%;
            font-family: var(--font-en);
        }

        /* ── Brand / Left Panel ── */
        .login-brand-panel {
            flex: 0 0 42%;
            background: linear-gradient(155deg, #0d1b4b 0%, #1a237e 45%, #283593 70%, #1565c0 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 40px;
            position: relative;
            overflow: hidden;
        }

        /* Decorative rings */
        .login-brand-panel::before,
        .login-brand-panel::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            border: 1.5px solid rgba(255,255,255,0.07);
        }
        .login-brand-panel::before {
            width: 500px; height: 500px;
            top: -180px; right: -180px;
        }
        .login-brand-panel::after {
            width: 320px; height: 320px;
            bottom: -100px; left: -100px;
        }

        .login-brand-inner {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .login-brand-orb {
            width: 110px; height: 110px;
            background: rgba(255,255,255,0.12);
            backdrop-filter: blur(10px);
            border: 1.5px solid rgba(255,255,255,0.2);
            border-radius: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 52px;
            margin: 0 auto 28px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25),
                        inset 0 1px 0 rgba(255,255,255,0.2);
            animation: floatOrb 4s ease-in-out infinite;
        }

        @keyframes floatOrb {
            0%, 100% { transform: translateY(0); }
            50%       { transform: translateY(-10px); }
        }

        .login-brand-name {
            font-size: 42px;
            font-weight: 800;
            color: #fff;
            letter-spacing: -1px;
            line-height: 1;
            margin-bottom: 12px;
        }

        .login-brand-tagline {
            font-size: 14px;
            font-weight: 400;
            color: rgba(255,255,255,0.6);
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-bottom: 40px;
        }

        .login-brand-dots {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        .login-brand-dots span {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
        }
        .login-brand-dots span:first-child {
            background: rgba(255,255,255,0.9);
            width: 24px;
            border-radius: 4px;
        }

        .login-brand-footer {
            position: absolute;
            bottom: 24px;
            left: 0; right: 0;
            text-align: center;
            font-size: 11px;
            color: rgba(255,255,255,0.3);
            letter-spacing: 1px;
        }

        /* ── Form / Right Panel ── */
        .login-form-panel {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f7f8fc;
            padding: 40px 24px;
            position: relative;
        }

        .lang-toggle-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            background: #fff;
            border: 1.5px solid #e8eaf0;
            border-radius: 50px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            color: #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            font-family: inherit;
        }
        .lang-toggle-btn:hover {
            border-color: var(--secondary-color);
            color: var(--secondary-color);
            box-shadow: 0 4px 14px rgba(57,73,171,0.15);
            transform: translateY(-1px);
        }

        .login-form-inner {
            width: 100%;
            max-width: 400px;
        }

        /* ── Tabs ── */
        .login-tabs {
            position: relative;
            display: flex;
            background: #eceef5;
            border-radius: 14px;
            padding: 4px;
            margin-bottom: 32px;
        }
        .login-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #888;
            cursor: pointer;
            border-radius: 10px;
            transition: color 0.2s;
            font-family: inherit;
            position: relative;
            z-index: 1;
        }
        .login-tab.active { color: var(--primary-color); }
        .login-tab-slider {
            position: absolute;
            top: 4px; bottom: 4px;
            left: 4px;
            width: calc(50% - 4px);
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.25s cubic-bezier(.4,0,.2,1);
        }
        .login-tab-slider.right {
            transform: translateX(100%);
        }

        /* ── Welcome text ── */
        .login-welcome {
            margin-bottom: 28px;
        }
        .login-welcome h2 {
            font-size: 26px;
            font-weight: 800;
            color: #1a1a2e;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }
        .login-welcome p {
            font-size: 14px;
            color: #888;
            font-weight: 400;
        }

        /* ── Input groups ── */
        .lf-group {
            position: relative;
            margin-bottom: 16px;
        }
        .lf-icon {
            position: absolute;
            top: 50%; left: 16px;
            transform: translateY(-50%);
            font-size: 16px;
            pointer-events: none;
            opacity: 0.5;
        }
        .lf-group input {
            width: 100%;
            padding: 15px 46px 15px 46px;
            border: 1.5px solid #e2e5f0;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            background: #fff;
            color: #1a1a2e;
            transition: all 0.2s;
            box-sizing: border-box;
            -webkit-appearance: none;
        }
        .lf-group input::placeholder { color: #bbb; }
        .lf-group input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 4px rgba(57,73,171,0.1);
            background: #fff;
        }
        .lf-eye {
            position: absolute;
            top: 50%; right: 14px;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.4;
            transition: opacity 0.2s;
            padding: 0;
            min-height: unset;
        }
        .lf-eye:hover { opacity: 0.8; }

        /* ── Forgot password row ── */
        .lf-forgot-row {
            text-align: right;
            margin: -6px 0 20px;
        }
        .lf-forgot-btn {
            background: none;
            border: none;
            font-size: 13px;
            font-weight: 600;
            color: var(--secondary-color);
            cursor: pointer;
            padding: 0;
            font-family: inherit;
            transition: color 0.2s;
        }
        .lf-forgot-btn:hover { color: var(--primary-color); text-decoration: underline; }

        /* ── Submit button ── */
        .lf-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #3949ab, #1a237e);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.25s;
            box-shadow: 0 8px 24px rgba(26,35,126,0.25);
            letter-spacing: 0.3px;
            margin-top: 4px;
        }
        .lf-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 14px 32px rgba(26,35,126,0.35);
        }
        .lf-submit:active:not(:disabled) { transform: translateY(0); }
        .lf-submit:disabled { opacity: 0.6; cursor: not-allowed; }

        /* ── Signup note ── */
        .lf-note {
            font-size: 12px;
            color: #aaa;
            text-align: center;
            margin-top: 14px;
            line-height: 1.6;
        }

        /* ── ARABIC LOGIN OVERRIDES ── */
        body.lang-ar #loginPage { direction: rtl; }

        body.lang-ar .login-brand-name {
            font-family: 'Cairo', sans-serif;
            font-size: 46px;
            letter-spacing: 0;
        }
        body.lang-ar .login-brand-tagline {
            font-family: 'Tajawal', sans-serif;
            letter-spacing: 1px;
        }
        body.lang-ar .lang-toggle-btn {
            right: auto;
            left: 24px;
        }
        body.lang-ar .lf-icon {
            left: auto;
            right: 16px;
        }
        body.lang-ar .lf-group input {
            padding: 15px 46px 15px 46px;
            text-align: right;
        }
        body.lang-ar .lf-eye {
            right: auto;
            left: 14px;
        }
        body.lang-ar .lf-forgot-row {
            text-align: left;
        }
        body.lang-ar .login-welcome h2,
        body.lang-ar .login-welcome p {
            text-align: right;
        }
        body.lang-ar .lf-note { text-align: right; }
        body.lang-ar .login-footer { display: none !important; }

        /* ── MOBILE LOGIN ── */
        @media (max-width: 768px) {
            #loginPage {
                flex-direction: column;
                min-height: 100vh;
            }
            .login-brand-panel {
                flex: 0 0 auto;
                padding: 36px 24px 32px;
                border-radius: 0 0 32px 32px;
            }
            .login-brand-orb {
                width: 80px; height: 80px;
                font-size: 38px;
                border-radius: 24px;
                margin-bottom: 16px;
                animation: none;
            }
            .login-brand-name { font-size: 32px; }
            .login-brand-tagline { font-size: 11px; margin-bottom: 20px; }
            .login-brand-dots { display: none; }
            .login-brand-footer { position: static; margin-top: 16px; font-size: 11px; }
            .login-form-panel {
                flex: 1;
                padding: 28px 20px 40px;
                background: #f7f8fc;
                align-items: flex-start;
            }
            .lang-toggle-btn {
                position: fixed;
                top: 16px;
                right: 16px;
                z-index: 999;
                padding: 7px 13px;
                font-size: 12px;
            }
            body.lang-ar .lang-toggle-btn {
                right: auto;
                left: 16px;
            }
            .login-form-inner { max-width: 100%; }
            .login-tabs { margin-bottom: 24px; }
            .login-welcome { margin-bottom: 20px; }
            .login-welcome h2 { font-size: 22px; }
            .lf-group input { padding: 14px 44px; font-size: 16px; }
            .lf-submit { padding: 15px; font-size: 16px; }
        }

        @media (max-width: 400px) {
            .login-brand-panel { padding: 28px 16px 24px; }
            .login-brand-name  { font-size: 28px; }
            .login-form-panel  { padding: 22px 16px 32px; }
        }

        /* ===== END PREMIUM LOGIN ===== */

        /* Main App Layout */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-container.show {
            display: flex;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, #1a237e 0%, #0d1b3e 100%);
            color: white;
            padding: 25px 0 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 5px 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .nav-menu {
            flex: 1;
            margin-top: 10px;
            overflow-y: auto;
        }

        .sidebar-logout {
            padding: 0 0 20px;
            flex-shrink: 0;
        }

        .sidebar-logout .nav-item {
            margin: 0 5px;
            border-radius: 10px;
        }

        .sidebar-logout .nav-item:hover {
            background: rgba(244, 67, 54, 0.2);
            border-left-color: #f44336;
        }

        [dir="rtl"] .sidebar-logout .nav-item:hover {
            border-right-color: #f44336;
            border-left-color: transparent;
        }

        .sidebar-header {
            padding: 0 25px 25px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-header h2 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .user-profile {
            padding: 20px 25px;
            background: rgba(255,255,255,0.05);
            margin: 20px 15px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-color), #ff7043);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        .user-details h4 {
            font-size: 15px;
            margin-bottom: 3px;
        }

        .user-details p {
            font-size: 12px;
            opacity: 0.7;
        }

        .nav-item {
            padding: 15px 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            min-height: 44px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            border-left-color: var(--accent-color);
        }

        .nav-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: var(--accent-color);
        }

        .nav-item i {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            min-height: 100vh;
            background: var(--bg-color);
        }

        .top-bar {
            background: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            height: var(--header-height);
        }

        .top-bar h1 {
            font-size: 28px;
            color: var(--primary-color);
        }

        .top-bar-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
            min-width: 44px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.2);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(26, 35, 126, 0.3);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: var(--text-color);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Content Sections */
        .content-section {
            padding: 40px;
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        /* Report Form */
        .form-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            max-width: 800px;
            margin: 0 auto;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-weight: 600;
            font-size: 14px;
        }

        .form-group label .required {
            color: var(--danger-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 4px rgba(57, 73, 171, 0.1);
        }

        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: var(--danger-color);
        }

        .error-message {
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .table-header {
            padding: 20px 30px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-box {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            width: 300px;
            background: rgba(255,255,255,0.2);
            color: white;
            min-height: 44px;
        }

        .search-box::placeholder {
            color: rgba(255,255,255,0.7);
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            padding: 15px 20px;
            text-align: left;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Mobile Table */
        @media (max-width: 768px) {
            .table-responsive table,
            .table-responsive thead,
            .table-responsive tbody,
            .table-responsive th,
            .table-responsive td,
            .table-responsive tr {
                display: block;
            }

            .table-responsive thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            .table-responsive td {
                border: none;
                position: relative;
                padding-left: 50%;
                min-height: 44px;
            }

            .table-responsive td:before {
                position: absolute;
                left: 12px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                font-weight: bold;
                content: attr(data-label);
            }
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }

        .badge-approved {
            background: #d4edda;
            color: #155724;
        }

        .badge-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-icon {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            min-height: 36px;
            min-width: 36px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideInUp 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h3 {
            color: var(--primary-color);
            font-size: 22px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            min-height: 44px;
            min-width: 44px;
        }

        .close-btn:hover {
            color: var(--danger-color);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--success-color);
            color: white;
            padding: 18px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 3000;
            animation: slideInRight 0.3s ease;
        }

        .toast.show {
            display: flex;
        }

        .toast.error {
            background: var(--danger-color);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
            }
            to {
                transform: translateX(0);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #666;
        }

        /* Chart Container */
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .chart-title {
            color: var(--primary-color);
            font-size: 18px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .chart-grid {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            height: 200px;
            padding: 20px 0;
        }

        .chart-bar-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .chart-bar {
            width: 60px;
            background: linear-gradient(180deg, var(--secondary-color), var(--primary-color));
            border-radius: 8px 8px 0 0;
            transition: height 0.3s ease;
        }

        .chart-label {
            font-size: 12px;
            color: #666;
        }

        .chart-value {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--info-color));
            transition: width 0.3s ease;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 1001;
            }

            .sidebar.mobile-open {
                transform: translateX(0);
            }

            [dir="rtl"] .sidebar {
                transform: translateX(100%);
            }

            [dir="rtl"] .sidebar.mobile-open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .top-bar {
                padding: 15px 20px;
            }

            .top-bar h1 {
                font-size: 20px;
            }

            .content-section {
                padding: 20px;
            }

            .modal-content {
                padding: 20px;
                margin: 10px;
                width: 95%;
            }

            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }

            .table-header {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                width: 100%;
            }
        }

        /* Hamburger Menu */
        .hamburger-menu {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--primary-color);
            min-height: 44px;
            min-width: 44px;
        }

        @media (max-width: 768px) {
            .hamburger-menu {
                display: block;
            }
        }

        .menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .menu-overlay.show {
            display: block;
        }

        .sidebar-close-btn {
            display: none;
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            border-radius: 8px;
            padding: 6px 10px;
            margin-top: 12px;
            transition: background 0.2s;
        }

        .sidebar-close-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        @media (max-width: 768px) {
            .sidebar-close-btn {
                display: inline-block;
            }
        }

        /* ===== TICKET SYSTEM ===== */
        .ticket-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .ticket-type-card {
            border: 2px solid #e0e0e0;
            border-radius: 14px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s;
            background: #fafafa;
        }
        .ticket-type-card:hover { border-color: var(--secondary-color); background: #f0f4ff; }
        .ticket-type-card.selected {
            border-color: var(--secondary-color);
            background: linear-gradient(135deg, #e8eaf6, #f3e5f5);
            box-shadow: 0 4px 14px rgba(57,73,171,0.18);
        }
        .ticket-type-card .ticket-icon { font-size: 36px; margin-bottom: 8px; }
        .ticket-type-card .ticket-label { font-size: 13px; font-weight: 600; color: var(--primary-color); }

        .ticket-form-step { display: none; }
        .ticket-form-step.active { display: block; }

        .badge-maintenance { background: #fff3e0; color: #e65100; }
        .badge-fuel        { background: #e3f2fd; color: #1565c0; }
        .badge-leave       { background: #fce4ec; color: #ad1457; }
        .badge-new         { background: #e8f5e9; color: #2e7d32; }

        .ticket-row-maintenance td:first-child { border-left: 4px solid #ff9800; }
        .ticket-row-fuel        td:first-child { border-left: 4px solid #2196f3; }
        .ticket-row-leave       td:first-child { border-left: 4px solid #e91e63; }

        .priority-badge {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .priority-low    { background: #e8f5e9; color: #388e3c; }
        .priority-medium { background: #fff8e1; color: #f57f17; }
        .priority-high   { background: #fff3e0; color: #e65100; }
        .priority-urgent { background: #ffebee; color: #c62828; }

        .step-indicator {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 22px;
        }
        .step-dot {
            width: 28px; height: 28px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700;
            background: #e0e0e0; color: #888;
            transition: all 0.3s;
        }
        .step-dot.active  { background: var(--secondary-color); color: white; }
        .step-dot.done    { background: var(--success-color);   color: white; }
        .step-line { flex: 1; height: 2px; background: #e0e0e0; border-radius: 2px; }
        .step-line.done { background: var(--success-color); }

        .ticket-detail-row { display: flex; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .ticket-detail-row:last-child { border-bottom: none; }
        .ticket-detail-label { font-weight: 600; color: #555; min-width: 140px; font-size: 13px; }
        .ticket-detail-value { color: #333; font-size: 13px; flex: 1; }

        @media (max-width: 768px) {
            .ticket-type-grid { grid-template-columns: 1fr; }
        }

        /* ===== GOOGLE SHEETS SYNC ===== */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 7px;
            font-size: 13px;
            padding: 7px 13px;
            border-radius: 8px;
            font-weight: 600;
            cursor: default;
            border: 1.5px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .sync-status.connected    { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }
        .sync-status.syncing      { background: #e3f2fd; color: #1565c0; border-color: #90caf9; }
        .sync-status.offline      { background: #fff3e0; color: #e65100; border-color: #ffcc80; }
        .sync-status.not-linked   { background: #f5f5f5; color: #757575; border-color: #e0e0e0; cursor: pointer; }
        .sync-status.not-linked:hover { background: #eeeeee; }
        .sync-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .connected  .sync-dot { background: #4caf50; box-shadow: 0 0 0 3px rgba(76,175,80,0.25); }
        .syncing    .sync-dot { background: #2196f3; animation: pulse-dot 1s infinite; }
        .offline    .sync-dot { background: #ff9800; }
        .not-linked .sync-dot { background: #9e9e9e; }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%       { opacity: 0.5; transform: scale(0.7); }
        }

        /* Settings Modal */
        .settings-section { margin-bottom: 24px; }
        .settings-section h4 {
            color: var(--primary-color);
            font-size: 15px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
        }
        .sheet-url-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }
        .sheet-url-input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 4px rgba(57,73,171,0.1);
        }
        .sheet-url-input.valid   { border-color: var(--success-color); }
        .sheet-url-input.invalid { border-color: var(--danger-color); }

        .sync-info-box {
            background: #f0f4ff;
            border: 1px solid #c5cae9;
            border-radius: 10px;
            padding: 14px 16px;
            font-size: 13px;
            color: #37474f;
            line-height: 1.7;
        }
        .sync-info-box ol { margin: 8px 0 0 18px; }
        .sync-info-box code {
            background: #e8eaf6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }
        .sync-last-time {
            font-size: 12px;
            color: #888;
            margin-top: 8px;
        }

        /* ===== RTL / ARABIC SUPPORT ===== */
        body[dir="rtl"] .sidebar {
            left: auto;
            right: 0;
            box-shadow: -5px 0 20px rgba(0,0,0,0.1);
        }

        body[dir="rtl"] .main-content {
            margin-left: 0;
            margin-right: var(--sidebar-width);
        }

        body[dir="rtl"] .nav-item {
            border-left: none;
            border-right: 3px solid transparent;
        }

        body[dir="rtl"] .nav-item:hover,
        body[dir="rtl"] .nav-item.active {
            border-right-color: var(--accent-color);
        }

        body[dir="rtl"] .top-bar-actions {
            flex-direction: row-reverse;
        }

        body[dir="rtl"] .sidebar {
            transform: translateX(100%);
        }

        body[dir="rtl"] .sidebar.mobile-open {
            transform: translateX(0);
        }

        @media (min-width: 769px) {
            body[dir="rtl"] .sidebar {
                transform: none;
            }
        }

        .lang-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            min-height: 36px;
        }

        .lang-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        /* Login page RTL */
        body[dir="rtl"] .login-form input,
        body[dir="rtl"] .login-form button {
            text-align: right;
        }

        /* Financial specific styles */
        .financial-row td:first-child { border-left: 4px solid #4caf50; }
        .financial-highlight { background: rgba(76, 175, 80, 0.05); }
        .financial-badge { background: #e8f5e9; color: #2e7d32; }
        .amount-pending { color: #f57f17; font-weight: 600; }
        .amount-approved { color: #2e7d32; font-weight: 600; }
        .amount-rejected { color: #c62828; font-weight: 600; }
        .amount-total { font-size: 18px; font-weight: 700; color: var(--primary-color); }
        
        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary-color);
        }
        .summary-card h4 {
            color: #666;
            font-size: 13px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .summary-card .amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }
        .summary-card .sub {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        /* Admin-only approval buttons */
        .admin-only {
            display: none;
        }
        .admin-visible {
            display: inline-flex;
        }

        /* ===== PERMISSION CONTROL PANEL — Mobile-First Redesign ===== */

        /* User cards in the panel */
        .perm-user-card {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: box-shadow 0.2s;
            border: 1px solid #e8eaf6;
        }
        .perm-user-card:hover { box-shadow: 0 8px 28px rgba(0,0,0,0.13); }

        .perm-card-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            flex-wrap: wrap;
        }
        .perm-avatar {
            width: 48px; height: 48px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 22px; font-weight: bold; color: white;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            flex-shrink: 0;
        }
        .perm-user-name { font-weight: 700; font-size: 15px; color: var(--primary-color); }
        .perm-user-meta { font-size: 12px; color: #888; margin-top: 3px; }
        .perm-card-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Permission chips summary inside card */
        .perm-chips-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 12px 20px;
            background: #fafbff;
            border-bottom: 1px solid #f0f0f0;
            min-height: 48px;
            align-items: center;
        }
        .perm-chip {
            font-size: 11px; font-weight: 700;
            padding: 3px 10px;
            border-radius: 20px;
            white-space: nowrap;
        }
        .perm-chip.allow { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .perm-chip.deny  { background: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
        .perm-chip.custom-chip { background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; }

        .custom-badge {
            font-size: 10px; font-weight: 700;
            background: #fff3e0; color: #e65100;
            border: 1px solid #ffcc80;
            border-radius: 6px; padding: 2px 7px;
            margin-left: 4px;
            vertical-align: middle;
        }
        .perm-users-grid { display: flex; flex-direction: column; gap: 14px; margin-top: 10px; }

        /* Section title inside modal */
        .perm-section-title {
            font-size: 11px; font-weight: 800;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Permission row — the core new design */
        .perm-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid #f5f5f5;
        }
        .perm-row:last-child { border-bottom: none; }
        .perm-row-info { flex: 1; min-width: 0; }
        .perm-row-label {
            font-size: 13px; font-weight: 700;
            color: #333;
            display: flex; align-items: center; gap: 6px;
        }
        .perm-row-desc { font-size: 11px; color: #999; margin-top: 2px; }

        /* The Allow / Deny toggle pill */
        .perm-toggle-pill {
            display: flex;
            border-radius: 10px;
            overflow: hidden;
            border: 1.5px solid #e0e0e0;
            flex-shrink: 0;
            background: white;
        }
        .perm-pill-btn {
            padding: 7px 14px;
            font-size: 12px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.18s;
            background: white;
            color: #aaa;
            min-width: 68px;
            text-align: center;
            touch-action: manipulation;
        }
        .perm-pill-btn.allow-btn:hover { background: #e8f5e9; color: #2e7d32; }
        .perm-pill-btn.deny-btn:hover  { background: #ffebee; color: #c62828; }
        .perm-pill-btn.allow-btn.selected {
            background: #4caf50; color: white;
        }
        .perm-pill-btn.deny-btn.selected {
            background: #f44336; color: white;
        }
        .perm-pill-sep { width: 1px; background: #e0e0e0; flex-shrink: 0; }

        /* Quick action bar inside modal */
        .perm-quick-bar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 10px 0 4px;
        }
        .perm-quick-btn {
            font-size: 12px; font-weight: 700;
            padding: 6px 14px;
            border-radius: 8px;
            border: 1.5px solid;
            cursor: pointer;
            transition: all 0.15s;
        }
        .perm-quick-allow { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }
        .perm-quick-allow:hover { background: #4caf50; color: white; }
        .perm-quick-deny  { background: #ffebee; color: #c62828; border-color: #ef9a9a; }
        .perm-quick-deny:hover  { background: #f44336; color: white; }
        .perm-quick-reset { background: #f5f5f5; color: #555; border-color: #ddd; }
        .perm-quick-reset:hover { background: #e0e0e0; }

        /* Modal overrides for mobile */
        @media (max-width: 600px) {
            #permissionModal .modal-content {
                padding: 16px;
                margin: 0;
                width: 100%;
                max-width: 100% !important;
                border-radius: 20px 20px 0 0;
                position: fixed;
                bottom: 0;
                left: 0;
                max-height: 92vh;
                overflow-y: auto;
            }
            #permissionModal {
                align-items: flex-end;
            }
            .perm-pill-btn { padding: 8px 12px; min-width: 56px; font-size: 11px; }
            .perm-row { gap: 8px; }
            .perm-card-header { flex-wrap: wrap; }
            .perm-card-actions { margin-left: 0; width: 100%; }
            .perm-card-actions .btn { flex: 1; justify-content: center; }
        }

        /* ===== ROLE-SPECIFIC REPORT FORMS ===== */
        .role-form-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            font-weight: 700;
            font-size: 15px;
        }
        .form-section-divider {
            font-size: 13px;
            font-weight: 700;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 0 8px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 16px;
            grid-column: 1 / -1;
        }
        .role-report-form { display: none; }
        .role-report-form.active { display: block; }

        /* ===== PASSWORD RECOVERY ===== */
        .recovery-step { display: none; }
        .recovery-step.active { display: block; }
        .recovery-key-box {
            font-family: monospace;
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 3px;
            background: #f5f5f5;
            border: 2px dashed #bbb;
            border-radius: 10px;
            padding: 14px;
            text-align: center;
            color: var(--primary-color);
            margin: 12px 0;
            user-select: all;
        }
        .recovery-pin-inputs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 16px 0;
        }
        .recovery-pin-inputs input {
            width: 52px; height: 56px;
            text-align: center;
            font-size: 22px;
            font-weight: 700;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.2s;
        }
        .recovery-pin-inputs input:focus { border-color: var(--secondary-color); }
    
        /* ===== PREMIUM MOBILE APP ENHANCEMENTS ===== */
        @media (max-width: 768px) {

            /* Smoother body */
            body { -webkit-font-smoothing: antialiased; }

            /* Top bar — glassy premium feel */
            .top-bar {
                background: rgba(255,255,255,0.96);
                backdrop-filter: blur(12px);
                -webkit-backdrop-filter: blur(12px);
                border-bottom: 1px solid rgba(0,0,0,0.07);
                padding: 14px 16px;
                gap: 10px;
                position: sticky;
                top: 0;
                z-index: 100;
                box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            }
            .top-bar h1 {
                font-size: 17px;
                font-weight: 700;
                letter-spacing: -0.3px;
                flex: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Hamburger */
            .hamburger-menu {
                font-size: 22px;
                padding: 4px 8px;
                border-radius: 10px;
                transition: background 0.2s;
            }
            .hamburger-menu:active { background: rgba(0,0,0,0.07); }

            /* Sidebar full-height overlay style */
            .sidebar {
                width: 82vw;
                max-width: 300px;
                padding-top: 20px;
                border-radius: 0 24px 24px 0;
                box-shadow: 4px 0 40px rgba(0,0,0,0.25);
            }
            body.lang-ar .sidebar {
                border-radius: 24px 0 0 24px;
            }

            /* Sidebar header */
            .sidebar-header { padding: 0 20px 20px; }
            .sidebar-header h2 { font-size: 22px; }

            /* Nav items on mobile — bigger tap targets */
            .nav-item {
                padding: 14px 20px !important;
                font-size: 14px;
                min-height: 52px;
            }
            .nav-item i { font-size: 20px; }

            /* Main content */
            .main-content { margin-left: 0 !important; margin-right: 0 !important; }
            .content-section { padding: 16px; }

            /* Stat cards — 2 column on mobile */
            .stats-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 12px;
            }
            .stat-card {
                padding: 14px 12px;
                border-radius: 14px;
            }
            .stat-value { font-size: 22px !important; }
            .stat-label { font-size: 11px !important; }
            .stat-icon  { width: 42px !important; height: 42px !important; font-size: 20px !important; border-radius: 12px !important; }

            /* Summary grid */
            .summary-grid { grid-template-columns: 1fr 1fr !important; gap: 12px; }

            /* Tables — card style on mobile */
            .table-container { border-radius: 14px; overflow: hidden; }
            .table-header { padding: 14px 16px; }
            .table-header h3 { font-size: 15px; }

            table thead { display: none; }
            table tbody tr {
                display: block;
                margin-bottom: 12px;
                border-radius: 12px;
                border: 1.5px solid #eee;
                padding: 12px 14px;
                background: #fff;
                box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }
            table tbody td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 6px 0;
                border: none;
                font-size: 13px;
                border-bottom: 1px solid #f5f5f5;
            }
            table tbody td:last-child { border-bottom: none; }
            table tbody td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #888;
                font-size: 11px;
                text-transform: uppercase;
                letter-spacing: 0.3px;
                flex-shrink: 0;
                margin-right: 8px;
            }
            body.lang-ar table tbody td {
                flex-direction: row-reverse;
            }
            body.lang-ar table tbody td::before {
                margin-right: 0;
                margin-left: 8px;
            }

            /* Buttons */
            .btn { padding: 11px 16px; border-radius: 10px; font-size: 13px; }
            .btn-icon { width: 36px; height: 36px; font-size: 14px; }

            /* Modals */
            .modal-content {
                margin: 0;
                border-radius: 24px 24px 0 0;
                position: fixed;
                bottom: 0; left: 0; right: 0;
                width: 100%;
                max-height: 90vh;
                overflow-y: auto;
                animation: slideModalUp 0.3s cubic-bezier(.4,0,.2,1);
            }
            @keyframes slideModalUp {
                from { transform: translateY(100%); opacity: 0.5; }
                to   { transform: translateY(0);    opacity: 1; }
            }
            .modal-body { padding: 16px; }
            .modal-header { padding: 16px 20px; }

            /* Search box */
            .search-box {
                padding: 10px 14px;
                border-radius: 10px;
                font-size: 14px;
            }

            /* Form groups */
            .form-group { margin-bottom: 16px; }
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 13px 14px;
                font-size: 16px; /* prevent iOS zoom */
                border-radius: 10px;
            }

            /* Lang toggle in app */
            .lang-btn {
                padding: 7px 12px;
                font-size: 12px;
                border-radius: 8px;
            }

            /* Action buttons row */
            .action-buttons { gap: 6px; flex-wrap: nowrap; }

            /* Page title clamp */
            #currentPageTitle {
                font-size: 17px;
                max-width: calc(100vw - 160px);
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }

        @media (max-width: 400px) {
            .stats-grid { grid-template-columns: 1fr !important; }
            .summary-grid { grid-template-columns: 1fr !important; }
            .content-section { padding: 12px; }
            .top-bar { padding: 12px 12px; }
        }

        /* ===== END MOBILE ENHANCEMENTS ===== */
</style>
</head>
<body>
    <!-- Global Loader -->
    <div id="globalLoader">
        <div class="spinner"></div>
    </div>

    <!-- Login Page -->
    <div id="loginPage">
        <!-- Left panel: branding -->
        <div class="login-brand-panel">
            <div class="login-brand-inner">
                <div class="login-brand-orb">🚗</div>
                <div class="login-brand-name">Rihlati</div>
                <div class="login-brand-tagline">Fleet Management System</div>
                <div class="login-brand-dots">
                    <span></span><span></span><span></span>
                </div>
            </div>
            <div class="login-brand-footer">© 2026 Rihlati</div>
        </div>

        <!-- Right panel: form -->
        <div class="login-form-panel">

            <!-- Language toggle top right -->
            <button onclick="toggleLanguage()" class="lang-toggle-btn" aria-label="Switch language">
                🌐 <span>عربي</span>
            </button>

            <div class="login-form-inner">
                <!-- Tab switcher -->
                <div class="login-tabs">
                    <button id="tabLoginBtn"  class="login-tab active"  onclick="switchAuthTab('login')">Sign In</button>
                    <button id="tabSignupBtn" class="login-tab"         onclick="switchAuthTab('signup')">Create Account</button>
                    <div class="login-tab-slider" id="loginTabSlider"></div>
                </div>

                <!-- SIGN IN -->
                <div id="loginTab">
                    <div class="login-welcome">
                        <h2>Welcome back</h2>
                        <p>Sign in to your account to continue</p>
                    </div>
                    <form class="login-form" id="loginForm" novalidate>
                        <div class="lf-group">
                            <span class="lf-icon">✉️</span>
                            <input type="email" id="loginEmail" placeholder="Email address"
                                   required autocomplete="email" aria-label="Email">
                        </div>
                        <div class="lf-group">
                            <span class="lf-icon">🔒</span>
                            <input type="password" id="loginPassword" placeholder="Password"
                                   required autocomplete="current-password" aria-label="Password">
                            <button type="button" class="lf-eye" onclick="togglePassVis('loginPassword', this)" aria-label="Show password">👁️</button>
                        </div>
                        <!-- Forgot password sits cleanly below the password field -->
                        <div class="lf-forgot-row">
                            <button type="button" class="lf-forgot-btn" onclick="openForgotPassword()" id="forgotPassBtn">
                                Forgot password?
                            </button>
                        </div>
                        <button type="submit" id="loginBtn" class="lf-submit">
                            <span>Sign In</span>
                        </button>
                    </form>
                </div>

                <!-- SIGN UP -->
                <div id="signupTab" style="display:none;">
                    <div class="login-welcome">
                        <h2>Create account</h2>
                        <p>Join Rihlati Fleet Management</p>
                    </div>
                    <form class="login-form" id="signupForm" novalidate>
                        <div class="lf-group">
                            <span class="lf-icon">👤</span>
                            <input type="text" id="signupName" placeholder="Full name" required>
                        </div>
                        <div class="lf-group">
                            <span class="lf-icon">✉️</span>
                            <input type="email" id="signupEmail" placeholder="Email address"
                                   required autocomplete="email">
                        </div>
                        <div class="lf-group">
                            <span class="lf-icon">🔒</span>
                            <input type="password" id="signupPassword" placeholder="Password (min 6 chars)"
                                   required minlength="6" autocomplete="new-password">
                            <button type="button" class="lf-eye" onclick="togglePassVis('signupPassword', this)" aria-label="Show password">👁️</button>
                        </div>
                        <button type="submit" id="signupBtn" class="lf-submit">
                            <span>Create Account</span>
                        </button>
                        <p class="lf-note" id="signupNoteText">New accounts are assigned the Driver role by default. An admin can change your role after registration.</p>
                    </form>
                </div>

                <!-- hidden firebase badge (kept for applyLanguage selector) -->
                <span class="fb-powered-text" style="display:none;">Powered by Firebase</span>
                <div class="login-footer" style="display:none;">
                    <p class="fb-powered-text"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== FORGOT PASSWORD MODAL (Firebase) ===== -->
    <div id="forgotPasswordModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content" style="max-width:440px;">
            <div class="modal-header">
                <h3>🔑 Reset Password</h3>
                <button class="close-btn" onclick="closeForgotPassword()">&times;</button>
            </div>
            <div id="fpStep1">
                <p style="font-size:13px;color:#555;margin-bottom:18px;line-height:1.6;">
                    Enter your email address and we'll send you a password reset link.
                </p>
                <div class="form-group" style="margin-bottom:14px;">
                    <label style="font-weight:600;font-size:13px;color:var(--primary-color);">Email Address</label>
                    <input type="email" id="fpEmail" placeholder="your@email.com"
                           style="margin-top:6px;width:100%;padding:12px 14px;border:1.5px solid #e0e0e0;border-radius:10px;font-size:14px;box-sizing:border-box;"
                           onkeydown="if(event.key==='Enter')sendPasswordReset()">
                </div>
                <p id="fpError" style="color:#c62828;font-size:12px;display:none;margin-bottom:10px;"></p>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-primary" style="flex:1;min-height:46px;" onclick="sendPasswordReset()">📧 Send Reset Link</button>
                    <button class="btn btn-secondary" style="min-height:46px;" onclick="closeForgotPassword()">Cancel</button>
                </div>
            </div>
            <div id="fpStep2" style="display:none;text-align:center;padding:10px 0;">
                <div style="font-size:48px;margin-bottom:16px;">📧</div>
                <h3 style="color:var(--primary-color);margin-bottom:8px;">Check your email!</h3>
                <p style="font-size:13px;color:#555;line-height:1.7;">A password reset link has been sent to <strong id="fpEmailSent"></strong>.<br>Check your inbox (and spam folder).</p>
                <button class="btn btn-primary" style="margin-top:20px;min-height:46px;padding:12px 30px;" onclick="closeForgotPassword()">Done ✓</button>
            </div>
        </div>
    </div>

    <!-- ===== FIREBASE SETUP GUIDE MODAL ===== -->
    <div id="firebaseSetupModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content" style="max-width:580px;">
            <div class="modal-header">
                <h3>🔥 Firebase Setup Guide</h3>
                <button class="close-btn" onclick="closeModal('firebaseSetupModal')">&times;</button>
            </div>
            <div style="max-height:70vh;overflow-y:auto;padding-right:4px;">

                <!-- Step 1: Auth -->
                <div style="background:#e8f0fe;border-radius:12px;padding:16px;margin-bottom:14px;border-left:4px solid #1a73e8;">
                    <h4 style="color:#1a73e8;margin-bottom:8px;">Step 1 — Enable Email/Password Auth</h4>
                    <ol style="font-size:13px;color:#37474f;line-height:2;margin-left:16px;">
                        <li>Go to <a href="https://console.firebase.google.com/project/mange-ab6e6/authentication/providers" target="_blank" style="color:#1a73e8;font-weight:600;">Firebase Console → Authentication</a></li>
                        <li>Click <strong>Sign-in method</strong> tab</li>
                        <li>Click <strong>Email/Password</strong> → Enable → Save</li>
                    </ol>
                </div>

                <!-- Step 2: Firestore Rules -->
                <div style="background:#e8f5e9;border-radius:12px;padding:16px;margin-bottom:14px;border-left:4px solid #2e7d32;">
                    <h4 style="color:#2e7d32;margin-bottom:8px;">Step 2 — Set Firestore Security Rules</h4>
                    <p style="font-size:13px;color:#37474f;margin-bottom:10px;">Go to <a href="https://console.firebase.google.com/project/mange-ab6e6/firestore/rules" target="_blank" style="color:#2e7d32;font-weight:600;">Firestore → Rules</a> and paste this:</p>
                    <div style="position:relative;">
                        <textarea id="firestoreRulesCode" readonly style="font-family:monospace;font-size:12px;background:#1e2130;color:#a6e22e;border:none;border-radius:8px;padding:14px;width:100%;height:140px;resize:none;box-sizing:border-box;line-height:1.5;">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /appdata/{document} {
      allow read, write: if request.auth != null;
    }
  }
}</textarea>
                        <button onclick="copyFirestoreRules()" style="position:absolute;top:8px;right:8px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);color:white;border-radius:6px;padding:4px 10px;font-size:11px;cursor:pointer;">📋 Copy</button>
                    </div>
                    <p style="font-size:12px;color:#777;margin-top:8px;">After pasting, click <strong>Publish</strong>.</p>
                </div>

                <!-- Step 3: First Admin -->
                <div style="background:#fff3e0;border-radius:12px;padding:16px;margin-bottom:14px;border-left:4px solid #e65100;">
                    <h4 style="color:#e65100;margin-bottom:8px;">Step 3 — Create Your Admin Account</h4>
                    <ol style="font-size:13px;color:#37474f;line-height:2;margin-left:16px;">
                        <li>Close this dialog and click <strong>Create Account</strong> tab</li>
                        <li>Sign up with your email and password</li>
                        <li>Go to <a href="https://console.firebase.google.com/project/mange-ab6e6/firestore/data/~2Fappdata~2Fusers" target="_blank" style="color:#e65100;font-weight:600;">Firestore → appdata → users</a></li>
                        <li>Find your user record (by email) → change <code style="background:#ffe0b2;padding:1px 5px;border-radius:4px;">role</code> from <code style="background:#ffe0b2;padding:1px 5px;border-radius:4px;">"driver"</code> to <code style="background:#ffe0b2;padding:1px 5px;border-radius:4px;">"admin"</code></li>
                        <li>Log out and log back in — you'll have full admin access!</li>
                    </ol>
                </div>

                <!-- Status check -->
                <div style="background:#f5f5f5;border-radius:12px;padding:16px;border-left:4px solid #9e9e9e;">
                    <h4 style="color:#555;margin-bottom:10px;">🔍 Check Connection Status</h4>
                    <div style="display:flex;gap:10px;flex-wrap:wrap;">
                        <div id="fbAuthStatus" style="flex:1;background:white;border-radius:8px;padding:12px;text-align:center;font-size:12px;color:#888;">
                            <div style="font-size:20px;">🔐</div>
                            <div style="font-weight:600;margin:4px 0;">Auth</div>
                            <div id="fbAuthIndicator">Checking…</div>
                        </div>
                        <div id="fbDbStatus" style="flex:1;background:white;border-radius:8px;padding:12px;text-align:center;font-size:12px;color:#888;">
                            <div style="font-size:20px;">🗄️</div>
                            <div style="font-weight:600;margin:4px 0;">Firestore</div>
                            <div id="fbDbIndicator">Checking…</div>
                        </div>
                        <div id="fbUserStatus" style="flex:1;background:white;border-radius:8px;padding:12px;text-align:center;font-size:12px;color:#888;">
                            <div style="font-size:20px;">👤</div>
                            <div style="font-weight:600;margin:4px 0;">Logged In</div>
                            <div id="fbUserIndicator">Checking…</div>
                        </div>
                    </div>
                    <button onclick="checkFirebaseStatus()" class="btn btn-secondary" style="width:100%;margin-top:12px;font-size:13px;">🔄 Refresh Status</button>
                </div>

            </div>
            <div style="margin-top:16px;text-align:center;">
                <button class="btn btn-primary" style="padding:12px 30px;" onclick="closeModal('firebaseSetupModal')">Got it! Close</button>
            </div>
        </div>
    </div>

    <!-- Password Recovery Modal (legacy PIN-based for local accounts) -->
    <div id="recoveryModal" class="modal" role="dialog" aria-modal="true">
        <div class="modal-content" style="max-width:460px;">
            <div class="modal-header">
                <h3>🔑 Account Recovery</h3>
                <button class="close-btn" onclick="closeRecoveryModal()">&times;</button>
            </div>
            <!-- Step 1: Enter recovery PIN -->
            <div id="recStep1" class="recovery-step active">
                <p style="font-size:13px;color:#555;margin-bottom:16px;line-height:1.6;">
                    Enter your <strong>6-digit Recovery PIN</strong> to reset the admin password.<br>
                    <span style="color:#888;font-size:12px;">This PIN is set in Settings → 🔐 Security after first login.</span>
                </p>
                <div class="recovery-pin-inputs" id="pinInputs">
                    <input type="number" min="0" max="9" oninput="pinDigit(this,0)" onkeydown="pinKey(event,0)">
                    <input type="number" min="0" max="9" oninput="pinDigit(this,1)" onkeydown="pinKey(event,1)">
                    <input type="number" min="0" max="9" oninput="pinDigit(this,2)" onkeydown="pinKey(event,2)">
                    <input type="number" min="0" max="9" oninput="pinDigit(this,3)" onkeydown="pinKey(event,3)">
                    <input type="number" min="0" max="9" oninput="pinDigit(this,4)" onkeydown="pinKey(event,4)">
                    <input type="number" min="0" max="9" oninput="pinDigit(this,5)" onkeydown="pinKey(event,5)">
                </div>
                <p id="pinError" style="color:#c62828;font-size:13px;text-align:center;display:none;">❌ Incorrect PIN. Please try again.</p>
                <button class="btn btn-primary" style="width:100%;margin-top:8px;min-height:46px;" onclick="verifyRecoveryPin()">Verify PIN →</button>
                <div style="margin-top:14px;padding:12px;background:#e8f0fe;border-radius:10px;font-size:12px;color:#37474f;">
                    💡 <strong>No PIN set yet?</strong> Log in as admin → Settings → 🔐 Security to create your recovery PIN now.
                </div>
            </div>
            <!-- Step 2: Reset password -->
            <div id="recStep2" class="recovery-step">
                <div style="background:#e8f5e9;border-radius:10px;padding:14px;margin-bottom:16px;">
                    <p style="color:#2e7d32;font-weight:700;font-size:13px;margin-bottom:4px;">✅ PIN verified!</p>
                    <p style="color:#555;font-size:12px;">Admin username: <strong id="recAdminUsername" style="color:var(--primary-color);"></strong></p>
                </div>
                <div class="form-group" style="margin-bottom:12px;">
                    <label style="font-weight:600;font-size:13px;color:var(--primary-color);">New Password</label>
                    <input type="password" id="recNewPassword" placeholder="Min 6 characters" style="margin-top:6px;width:100%;padding:10px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:14px;box-sizing:border-box;">
                </div>
                <div class="form-group">
                    <label style="font-weight:600;font-size:13px;color:var(--primary-color);">Confirm Password</label>
                    <input type="password" id="recConfirmPassword" placeholder="Re-enter new password" style="margin-top:6px;width:100%;padding:10px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:14px;box-sizing:border-box;">
                </div>
                <p id="recPassError" style="color:#c62828;font-size:13px;display:none;margin-top:8px;"></p>
                <div style="display:flex;gap:10px;margin-top:16px;">
                    <button class="btn btn-primary" style="flex:1;min-height:46px;" onclick="resetAdminPassword()">🔑 Reset Password</button>
                    <button class="btn btn-secondary" style="min-height:46px;" onclick="closeRecoveryModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="app-container">
        <!-- Mobile Menu Overlay -->
        <div id="menuOverlay" class="menu-overlay" onclick="toggleMobileMenu()"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>🚗 Rihlati</h2>
                <p>Fleet Management</p>
                <button class="sidebar-close-btn" onclick="toggleMobileMenu()" aria-label="Close menu">✕</button>
            </div>

            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">A</div>
                <div class="user-details">
                    <h4 id="userName">Admin</h4>
                    <p id="sidebarUserRole">Administrator</p>
                </div>
            </div>

            <nav class="nav-menu" id="navMenu" aria-label="Main navigation">
                <!-- Navigation items will be loaded dynamically -->
            </nav>

            <div class="sidebar-logout" onclick="logout()" role="button" tabindex="0">
                <div class="nav-item" style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 8px;">
                    <i>🚪</i>
                    <span id="logoutLabel">Logout</span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <button class="hamburger-menu" onclick="toggleMobileMenu()" aria-label="Toggle menu">☰</button>
                <h1 id="currentPageTitle">Dashboard</h1>
                <div class="top-bar-actions" id="topBarActions"></div>
                <div id="adminOnlyControls" style="display:none; align-items:center; gap:8px;">
                    <div id="syncStatus" class="sync-status not-linked" onclick="openFirebaseSetup()" title="Firebase status & setup guide" style="cursor:pointer;">
                        <span class="sync-dot"></span>
                        <span id="syncStatusText">Connecting…</span>
                    </div>
                    <button class="lang-btn" onclick="openModal('settingsModal');onSettingsOpen();" title="Settings" style="padding: 8px 10px;">⚙️</button>
                </div>
                <button class="lang-btn" id="langToggle" onclick="toggleLanguage()" title="Switch Language">عربي</button>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="content-section active">
                <div class="stats-grid" id="statsGrid">
                    <!-- Stats cards will be loaded dynamically -->
                </div>
                <div class="chart-container" id="adminChart">
                    <div class="chart-title">Reports Overview</div>
                    <div class="chart-grid" id="adminChartGrid"></div>
                </div>
                <div class="table-container" id="recentReportsContainer">
                    <!-- Recent reports table -->
                </div>
            </div>

            <!-- Admin Reports Management -->
            <div id="adminReports" class="content-section">
                <div class="table-container">
                    <div class="table-header">
                        <h3>${t('allReports')}</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="exportReports('csv')">📥 Export CSV</button>
                            <input type="text" class="search-box" placeholder="Search reports..." 
                                   onkeyup="debouncedFilterReports(this.value)" aria-label="Search reports">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <div id="reportsTableContainer"></div>
                    </div>
                    <div id="reportsPagination" class="pagination"></div>
                </div>
            </div>

            <!-- Admin User Management -->
            <div id="adminUsers" class="content-section">
                <div class="table-container">
                    <div class="table-header">
                        <h3 data-i18n="userManagement">👥 User Management</h3>
                        <button class="btn btn-primary" onclick="showAddUserModal()">
                            <span data-i18n="addUser">➕ Add User</span>
                        </button>
                    </div>
                    <div class="table-responsive">
                        <div id="usersTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Admin Analytics -->
            <div id="adminAnalytics" class="content-section">
                <div class="stats-grid" id="analyticsStats"></div>
                <div class="chart-container">
                    <div class="chart-title">Reports by Status</div>
                    <div class="chart-grid" id="statusChart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Reports by Type</div>
                    <div class="chart-grid" id="typeChart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Monthly Report Trends</div>
                    <div class="chart-grid" id="monthlyChart"></div>
                </div>
            </div>

            <!-- ===== ADMIN PERMISSIONS PANEL ===== -->
            <div id="adminPermissions" class="content-section">

                <!-- Header + filters -->
                <div style="margin-bottom:20px;">
                    <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-bottom:14px;">
                        <h2 style="color:var(--primary-color); font-size:clamp(18px,4vw,26px);">🔐 Permission Control</h2>
                    </div>

                    <!-- Info banner -->
                    <div style="background:linear-gradient(135deg,#e8f0fe,#f3e5f5); border:1px solid #c5cae9; border-radius:12px; padding:14px 18px; font-size:13px; color:#37474f; line-height:1.6; margin-bottom:16px;">
                        <strong>🛡️ How it works:</strong> Each user's permissions are shown as <span style="background:#e8f5e9;color:#2e7d32;padding:1px 7px;border-radius:10px;font-size:11px;font-weight:700;">✅ ALLOW</span> or <span style="background:#ffebee;color:#c62828;padding:1px 7px;border-radius:10px;font-size:11px;font-weight:700;">❌ DENY</span>.
                        Overrides marked <span class="custom-badge">CUSTOM</span> differ from the role default and take priority.
                    </div>

                    <!-- Search & filter row -->
                    <div style="display:flex; gap:10px; flex-wrap:wrap;">
                        <input type="text" id="permSearchBox" class="search-box" placeholder="🔍 Search users..."
                               onkeyup="filterPermUsers(this.value)"
                               style="background:white; border:1.5px solid #e0e0e0; flex:1; min-width:160px;">
                        <select id="permRoleFilter" class="search-box" onchange="filterPermUsers('')"
                                style="background:white; border:1.5px solid #e0e0e0; min-width:160px;">
                            <option value="">All Roles</option>
                            <option value="manager">👔 Manager</option>
                            <option value="supervisor">👷 Supervisor</option>
                            <option value="driver_supervisor">🚦 Driver Supervisor</option>
                            <option value="maintenance_supervisor">🔩 Maintenance Supervisor</option>
                            <option value="hr">🧑‍💼 HR</option>
                            <option value="accountant">🧾 Accountant</option>
                            <option value="sales_marketing">📣 Sales & Marketing</option>
                            <option value="executive">💼 Executive</option>
                            <option value="vehicle_engineer">🔧 Vehicle Engineer</option>
                            <option value="driver">🚗 Driver</option>
                        </select>
                        <select id="permStatusFilter" class="search-box" onchange="filterPermUsers('')"
                                style="background:white; border:1.5px solid #e0e0e0; min-width:140px;">
                            <option value="">All Users</option>
                            <option value="custom">Custom Permissions</option>
                            <option value="default">Role Defaults</option>
                        </select>
                    </div>
                </div>

                <!-- Stats bar -->
                <div id="permStatsBar" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:18px;"></div>

                <!-- Users list -->
                <div id="permUsersGrid" class="perm-users-grid"></div>
            </div>

            <!-- User Dashboard -->
            <div id="userDashboard" class="content-section">
                <div class="stats-grid" id="userStatsGrid">
                    <!-- User stats -->
                </div>
                <div class="chart-container">
                    <div class="chart-title">My Report Status</div>
                    <div class="chart-grid" id="userChartGrid"></div>
                </div>
            </div>

            <!-- Submit Report (Role-Based) -->
            <div id="submitReport" class="content-section">
                <div class="form-card" style="max-width:860px;">
                    <div id="roleReportFormContainer">
                        <!-- Populated dynamically based on user role -->
                    </div>
                </div>
            </div>

            <!-- My Reports (User) -->
            <div id="myReports" class="content-section">
                <div class="table-container">
                    <div class="table-header">
                        <h3>📋 My Reports</h3>
                        <input type="text" class="search-box" placeholder="Search my reports..." 
                               onkeyup="debouncedFilterMyReports(this.value)" aria-label="Search my reports">
                    </div>
                    <div class="table-responsive">
                        <div id="myReportsTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- ===== TICKET SUBMISSION (Driver Supervisor) ===== -->
            <div id="submitTicket" class="content-section">
                <div class="form-card" style="max-width: 900px;">
                    <h2 style="color: var(--primary-color); margin-bottom: 8px;">🎫 Raise New Request</h2>
                    <p style="color:#777; margin-bottom: 24px; font-size:14px;">Select a request type to get started. It will be sent to Admin for approval.</p>

                    <!-- Step indicator -->
                    <div class="step-indicator">
                        <div class="step-dot active" id="sdot1">1</div>
                        <div class="step-line" id="sline1"></div>
                        <div class="step-dot" id="sdot2">2</div>
                        <div class="step-line" id="sline2"></div>
                        <div class="step-dot" id="sdot3">3</div>
                    </div>

                    <!-- Step 1: Choose type -->
                    <div id="ticketStep1" class="ticket-form-step active">
                        <h3 style="margin-bottom:16px; font-size:15px; color:#555;">Step 1: Choose Request Type</h3>
                        <div class="ticket-type-grid">
                            <div class="ticket-type-card" onclick="selectTicketType('maintenance')" id="ttype-maintenance">
                                <div class="ticket-icon">🔧</div>
                                <div class="ticket-label">Maintenance Request</div>
                                <div style="font-size:11px; color:#888; margin-top:5px;">Vehicle repair & service</div>
                            </div>
                            <div class="ticket-type-card" onclick="selectTicketType('fuel')" id="ttype-fuel">
                                <div class="ticket-icon">⛽</div>
                                <div class="ticket-label">Fuel Request</div>
                                <div style="font-size:11px; color:#888; margin-top:5px;">Fuel amount approval</div>
                            </div>
                            <div class="ticket-type-card" onclick="selectTicketType('leave')" id="ttype-leave">
                                <div class="ticket-icon">🏖️</div>
                                <div class="ticket-label">Leave Request</div>
                                <div style="font-size:11px; color:#888; margin-top:5px;">Driver leave / absence</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <button class="btn btn-primary" onclick="ticketNextStep(2)" id="ticketStep1Btn" disabled>Next →</button>
                        </div>
                    </div>

                    <!-- Step 2: Fill form -->
                    <div id="ticketStep2" class="ticket-form-step">
                        <h3 style="margin-bottom:16px; font-size:15px; color:#555;" id="ticketFormTitle">Step 2: Request Details</h3>

                        <!-- MAINTENANCE fields -->
                        <div id="ticketFields-maintenance" style="display:none;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Driver Name <span class="required">*</span></label>
                                    <input type="text" id="t-maint-driver" placeholder="Driver full name" required>
                                </div>
                                <div class="form-group">
                                    <label>Vehicle Number <span class="required">*</span></label>
                                    <input type="text" id="t-maint-vehicle" placeholder="e.g. ABC-1234">
                                </div>
                                <div class="form-group">
                                    <label>Maintenance Type <span class="required">*</span></label>
                                    <select id="t-maint-type">
                                        <option value="">Select type</option>
                                        <option value="oil_change">Oil Change</option>
                                        <option value="tire_change">Tire Change</option>
                                        <option value="brake_service">Brake Service</option>
                                        <option value="engine_repair">Engine Repair</option>
                                        <option value="ac_repair">A/C Repair</option>
                                        <option value="electrical">Electrical Issue</option>
                                        <option value="body_repair">Body Repair</option>
                                        <option value="periodic_service">Periodic Service</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Estimated Cost (SAR) <span class="required">*</span></label>
                                    <input type="number" id="t-maint-cost" min="0" step="0.01" placeholder="0.00" required>
                                </div>
                                <div class="form-group">
                                    <label>Priority <span class="required">*</span></label>
                                    <select id="t-maint-priority">
                                        <option value="low">🟢 Low</option>
                                        <option value="medium" selected>🟡 Medium</option>
                                        <option value="high">🟠 High</option>
                                        <option value="urgent">🔴 Urgent</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Requested Date</label>
                                    <input type="date" id="t-maint-date">
                                </div>
                                <div class="form-group full-width">
                                    <label>Description / Notes <span class="required">*</span></label>
                                    <textarea id="t-maint-notes" placeholder="Describe the issue in detail..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- FUEL fields -->
                        <div id="ticketFields-fuel" style="display:none;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Driver Name <span class="required">*</span></label>
                                    <input type="text" id="t-fuel-driver" placeholder="Driver full name" required>
                                </div>
                                <div class="form-group">
                                    <label>Vehicle Number <span class="required">*</span></label>
                                    <input type="text" id="t-fuel-vehicle" placeholder="e.g. ABC-1234">
                                </div>
                                <div class="form-group">
                                    <label>Fuel Amount (Liters) <span class="required">*</span></label>
                                    <input type="number" id="t-fuel-liters" min="1" step="0.1" placeholder="0.0" required>
                                </div>
                                <div class="form-group">
                                    <label>Estimated Cost (SAR) <span class="required">*</span></label>
                                    <input type="number" id="t-fuel-cost" min="0" step="0.01" placeholder="0.00" required>
                                </div>
                                <div class="form-group">
                                    <label>Fuel Station</label>
                                    <input type="text" id="t-fuel-station" placeholder="Station name / location">
                                </div>
                                <div class="form-group">
                                    <label>Required Date <span class="required">*</span></label>
                                    <input type="date" id="t-fuel-date" required>
                                </div>
                                <div class="form-group full-width">
                                    <label>Reason / Notes <span class="required">*</span></label>
                                    <textarea id="t-fuel-notes" placeholder="Reason for fuel request..." required></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- LEAVE fields -->
                        <div id="ticketFields-leave" style="display:none;">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Driver Name <span class="required">*</span></label>
                                    <input type="text" id="t-leave-driver" placeholder="Driver full name" required>
                                </div>
                                <div class="form-group">
                                    <label>Leave Type <span class="required">*</span></label>
                                    <select id="t-leave-type">
                                        <option value="">Select type</option>
                                        <option value="annual">Annual Leave</option>
                                        <option value="sick">Sick Leave</option>
                                        <option value="emergency">Emergency Leave</option>
                                        <option value="unpaid">Unpaid Leave</option>
                                        <option value="hajj">Hajj Leave</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>From Date <span class="required">*</span></label>
                                    <input type="date" id="t-leave-from">
                                </div>
                                <div class="form-group">
                                    <label>To Date <span class="required">*</span></label>
                                    <input type="date" id="t-leave-to">
                                </div>
                                <div class="form-group">
                                    <label>Number of Days</label>
                                    <input type="number" id="t-leave-days" min="1" placeholder="Auto calculated" readonly
                                           style="background:#f5f5f5;">
                                </div>
                                <div class="form-group">
                                    <label>Replacement Driver</label>
                                    <input type="text" id="t-leave-replacement" placeholder="Replacement driver name (if any)">
                                </div>
                                <div class="form-group full-width">
                                    <label>Reason / Notes <span class="required">*</span></label>
                                    <textarea id="t-leave-notes" placeholder="Reason for leave request..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div style="display:flex; gap:10px; margin-top:20px; justify-content:space-between;">
                            <button class="btn btn-secondary" onclick="ticketNextStep(1)">← Back</button>
                            <button class="btn btn-primary" onclick="ticketNextStep(3)">Preview →</button>
                        </div>
                    </div>

                    <!-- Step 3: Preview & Submit -->
                    <div id="ticketStep3" class="ticket-form-step">
                        <h3 style="margin-bottom:16px; font-size:15px; color:#555;">Step 3: Review & Submit</h3>
                        <div id="ticketPreview" style="background:#f8f9ff; border:1px solid #c5cae9; border-radius:12px; padding:20px; margin-bottom:20px;"></div>
                        <div style="background:#fff8e1; border:1px solid #ffe082; border-radius:10px; padding:12px 16px; font-size:13px; color:#555; margin-bottom:20px;">
                            ⚠️ This request will be sent to <strong>Admin</strong> for approval. You will see the status in "My Requests".
                        </div>
                        <div style="display:flex; gap:10px; justify-content:space-between;">
                            <button class="btn btn-secondary" onclick="ticketNextStep(2)">← Edit</button>
                            <button class="btn btn-primary" onclick="submitTicket()" style="min-width:160px;">
                                📤 Send Request
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== MY TICKETS (Driver Supervisor) ===== -->
            <div id="myTickets" class="content-section">
                <div class="table-container">
                    <div class="table-header">
                        <h3>🎫 My Requests</h3>
                        <input type="text" class="search-box" placeholder="Search tickets..."
                               onkeyup="filterMyTickets(this.value)" aria-label="Search tickets">
                    </div>
                    <div class="table-responsive">
                        <div id="myTicketsTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- ===== VEHICLE MANAGEMENT ===== -->
            <div id="vehicleManagement" class="content-section">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
                    <h2 style="color:var(--primary-color);">🚗 <span data-i18n="vehicleManagement">Vehicle Management</span></h2>
                    <button class="btn btn-primary" onclick="showAddVehicleModal()">➕ <span data-i18n="addVehicle">Add Vehicle</span></button>
                </div>

                <!-- Summary Cards -->
                <div class="stats-grid" id="vehicleSummaryCards" style="margin-bottom:24px;"></div>

                <!-- Table -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>🚘 Fleet Inventory</h3>
                        <div style="display:flex;gap:10px;flex-wrap:wrap;">
                            <select id="vehicleStatusFilter" class="search-box" style="width:150px;" onchange="loadVehiclesTable()">
                                <option value="" data-i18n="allStatus">All Status</option>
                                <option value="active">✅ Active</option>
                                <option value="maintenance">🔧 Maintenance</option>
                                <option value="retired">❌ Retired</option>
                            </select>
                            <input type="text" class="search-box" data-i18n-placeholder="search" placeholder="Search vehicles..." onkeyup="filterVehicles(this.value)">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <div id="vehiclesTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Vehicle Add/Edit Modal -->
            <div id="vehicleModal" class="modal">
                <div class="modal-content" style="max-width:700px;">
                    <div class="modal-header">
                        <h3 id="vehicleModalTitle">➕ Add Vehicle</h3>
                        <button class="modal-close" onclick="closeModal('vehicleModal')">✕</button>
                    </div>
                    <div class="modal-body">
                        <form id="vehicleForm" onsubmit="return false;">
                            <input type="hidden" id="editVehicleId">

                            <div class="form-section-divider">🚗 Vehicle Information</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Plate Number <span class="required">*</span></label>
                                    <input type="text" id="vPlate" placeholder="e.g. ABC-1234" required>
                                </div>
                                <div class="form-group">
                                    <label>Make / Brand <span class="required">*</span></label>
                                    <input type="text" id="vMake" placeholder="e.g. Toyota" required>
                                </div>
                                <div class="form-group">
                                    <label>Model <span class="required">*</span></label>
                                    <input type="text" id="vModel" placeholder="e.g. Hilux" required>
                                </div>
                                <div class="form-group">
                                    <label>Year <span class="required">*</span></label>
                                    <input type="number" id="vYear" min="1990" max="2030" placeholder="e.g. 2022" required>
                                </div>
                                <div class="form-group">
                                    <label>Color</label>
                                    <input type="text" id="vColor" placeholder="e.g. White">
                                </div>
                                <div class="form-group">
                                    <label>VIN / Chassis Number</label>
                                    <input type="text" id="vVin" placeholder="e.g. 1HGBH41JXMN109186">
                                </div>
                                <div class="form-group">
                                    <label>Fuel Type</label>
                                    <select id="vFuelType">
                                        <option value="petrol">Petrol</option>
                                        <option value="diesel">Diesel</option>
                                        <option value="electric">Electric</option>
                                        <option value="hybrid">Hybrid</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Status <span class="required">*</span></label>
                                    <select id="vStatus" required>
                                        <option value="active">Active</option>
                                        <option value="maintenance">In Maintenance</option>
                                        <option value="retired">Retired</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Current Odometer (km)</label>
                                    <input type="number" id="vOdometer" min="0" placeholder="e.g. 45000">
                                </div>
                                <div class="form-group">
                                    <label>Assigned Driver</label>
                                    <select id="vAssignedDriver">
                                        <option value="">— Unassigned —</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-section-divider" style="margin-top:20px;">🛒 Purchase Information</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Purchase Date</label>
                                    <input type="date" id="vPurchaseDate">
                                </div>
                                <div class="form-group">
                                    <label>Purchase Price (SAR)</label>
                                    <input type="number" id="vPurchasePrice" min="0" step="0.01" placeholder="e.g. 95000">
                                </div>
                                <div class="form-group">
                                    <label>Purchased From (Dealer/Seller)</label>
                                    <input type="text" id="vPurchasedFrom" placeholder="e.g. Al-Jazirah Motors">
                                </div>
                                <div class="form-group">
                                    <label>Dealer City</label>
                                    <input type="text" id="vDealerCity" placeholder="e.g. Riyadh">
                                </div>
                                <div class="form-group" style="grid-column:1/-1;">
                                    <label>Warranty Expiry Date</label>
                                    <input type="date" id="vWarrantyExpiry">
                                </div>
                            </div>

                            <div class="form-section-divider" style="margin-top:20px;">📋 Registration & Insurance</div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Registration Expiry</label>
                                    <input type="date" id="vRegExpiry">
                                </div>
                                <div class="form-group">
                                    <label>Insurance Expiry</label>
                                    <input type="date" id="vInsExpiry">
                                </div>
                                <div class="form-group" style="grid-column:1/-1;">
                                    <label>Notes</label>
                                    <textarea id="vNotes" rows="3" placeholder="Any additional notes..."></textarea>
                                </div>
                            </div>

                            <div id="vehicleSaveError" style="display:none;color:var(--danger-color);margin-top:10px;padding:10px;background:#ffebee;border-radius:8px;"></div>

                            <div style="display:flex;gap:12px;margin-top:20px;">
                                <button type="button" class="btn btn-primary" style="flex:1;" onclick="saveVehicle()">💾 Save Vehicle</button>
                                <button type="button" class="btn btn-secondary" onclick="closeModal('vehicleModal')">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Vehicle Detail Modal -->
            <div id="vehicleDetailModal" class="modal">
                <div class="modal-content" style="max-width:600px;">
                    <div class="modal-header">
                        <h3>🚗 Vehicle Details</h3>
                        <button class="modal-close" onclick="closeModal('vehicleDetailModal')">✕</button>
                    </div>
                    <div class="modal-body">
                        <div id="vehicleDetailContent"></div>
                    </div>
                </div>
            </div>

            <!-- ===== FINANCIAL DASHBOARD (Accountant - View Only) ===== -->
            <div id="financialDashboard" class="content-section">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
                    <h2 style="color: var(--primary-color);">💰 Financial Dashboard</h2>
                    <div id="financialActionBar" style="display:flex;gap:10px;flex-wrap:wrap;"></div>
                </div>
                
                <!-- Summary Cards -->
                <div class="summary-grid" id="financialSummary">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Financial Overview (View Only) -->
                <div class="table-container" style="margin-top: 30px;">
                    <div class="table-header">
                        <h3>📊 Financial Overview</h3>
                        <div style="display:flex; gap:10px;">
                            <select id="financialTypeFilter" class="search-box" style="width:160px;" onchange="loadFinancialDashboard()">
                                <option value="">All Types</option>
                                <option value="maintenance">🔧 Maintenance</option>
                                <option value="fuel">⛽ Fuel</option>
                                <option value="report">📋 Expense Reports</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <div id="financialTableContainer"></div>
                    </div>
                </div>

                <!-- Financial Analytics -->
                <div class="chart-container" style="margin-top: 30px;">
                    <div class="chart-title">Monthly Financial Overview</div>
                    <div class="chart-grid" id="financialChartGrid"></div>
                </div>
            </div>

            <!-- ===== SALES & MARKETING DASHBOARD ===== -->
            <div id="salesDashboard" class="content-section">
                <h2 style="color: var(--primary-color); margin-bottom: 20px;">📊 Sales & Marketing Dashboard</h2>
                
                <!-- Summary Cards -->
                <div class="summary-grid" id="salesSummary">
                    <!-- Will be populated dynamically -->
                </div>

                <!-- Campaign/Event Requests -->
                <div class="table-container" style="margin-top: 30px;">
                    <div class="table-header">
                        <h3>🎯 Campaign & Event Requests</h3>
                        <button class="btn btn-primary" onclick="showCampaignRequestModal()">➕ New Campaign Request</button>
                    </div>
                    <div class="table-responsive">
                        <div id="campaignRequestsTable"></div>
                    </div>
                </div>

                <!-- Marketing Reports -->
                <div class="chart-container" style="margin-top: 30px;">
                    <div class="chart-title">Marketing ROI Overview</div>
                    <div class="chart-grid" id="roiChartGrid"></div>
                </div>
            </div>

            <!-- ===== ADMIN TICKET MANAGEMENT (Admin Only) ===== -->
            <div id="adminTickets" class="content-section">
                <div class="table-container">
                    <div class="table-header">
                        <h3>🎫 Request Management (Admin Only)</h3>
                        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                            <select id="ticketTypeFilter" class="search-box" style="width:160px;" onchange="loadAdminTickets()">
                                <option value="">All Types</option>
                                <option value="maintenance">🔧 Maintenance</option>
                                <option value="fuel">⛽ Fuel</option>
                                <option value="leave">🏖️ Leave</option>
                            </select>
                            <select id="ticketStatusFilter" class="search-box" style="width:150px;" onchange="loadAdminTickets()">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <div id="adminTicketsTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Campaign Request Modal -->
            <div id="campaignModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="campaignModalTitle">
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 id="campaignModalTitle">🎯 New Campaign Request</h3>
                        <button class="close-btn" onclick="closeModal('campaignModal')" aria-label="Close">&times;</button>
                    </div>
                    <form onsubmit="saveCampaignRequest(event)">
                        <input type="hidden" id="campaignId">
                        <div class="form-group">
                            <label>Campaign Name <span class="required">*</span></label>
                            <input type="text" id="campaignName" required>
                        </div>
                        <div class="form-group">
                            <label>Campaign Type <span class="required">*</span></label>
                            <select id="campaignType" required>
                                <option value="">Select type</option>
                                <option value="digital">📱 Digital Marketing</option>
                                <option value="print">🖨️ Print Media</option>
                                <option value="event">🎪 Event/Exhibition</option>
                                <option value="social">📲 Social Media</option>
                                <option value="promotion">🎁 Special Promotion</option>
                                <option value="other">📌 Other</option>
                            </select>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Budget (SAR) <span class="required">*</span></label>
                                <input type="number" id="campaignBudget" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label>Start Date <span class="required">*</span></label>
                                <input type="date" id="campaignStartDate" required>
                            </div>
                            <div class="form-group">
                                <label>End Date <span class="required">*</span></label>
                                <input type="date" id="campaignEndDate" required>
                            </div>
                            <div class="form-group">
                                <label>Expected ROI (%)</label>
                                <input type="number" id="campaignRoi" min="0" step="0.1" placeholder="e.g., 150">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Target Audience</label>
                            <input type="text" id="campaignTarget" placeholder="e.g., Corporate clients, SME">
                        </div>
                        <div class="form-group full-width">
                            <label>Description / Objectives <span class="required">*</span></label>
                            <textarea id="campaignDescription" rows="3" required></textarea>
                        </div>
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">Submit Request</button>
                            <button type="button" class="btn btn-secondary" onclick="closeModal('campaignModal')">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Report Details Modal -->
    <div id="reportModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="reportModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="reportModalTitle">Report Details</h3>
                <button class="close-btn" onclick="closeModal('reportModal')" aria-label="Close">&times;</button>
            </div>
            <div id="reportDetails"></div>
        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="userModalTitle">Add User</h3>
                <button class="close-btn" onclick="closeModal('userModal')" aria-label="Close">&times;</button>
            </div>
            <!-- Firebase notice for new users -->
            <div id="userModalFirebaseNotice" style="background:#e8f0fe;border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:12.5px;color:#1a237e;display:flex;align-items:flex-start;gap:8px;line-height:1.6;">
                <span style="font-size:18px;flex-shrink:0;">🔥</span>
                <span>A <strong>Firebase account</strong> will be created with this email & password. The user can log in immediately and reset their password via "Forgot password" on the login screen.</span>
            </div>
            <form onsubmit="saveUser(event)">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label>Username <span class="required">*</span></label>
                    <input type="text" id="userUsername" required>
                </div>
                <div class="form-group">
                    <label>Full Name <span class="required">*</span></label>
                    <input type="text" id="userFullName" required>
                </div>
                <div class="form-group">
                    <label>Email <span class="required">*</span></label>
                    <input type="email" id="userEmail" required>
                </div>
                <div class="form-group" id="passwordGroup">
                    <label>
                        Password <span class="required" id="passwordRequired">*</span>
                        <span id="passwordHint" style="font-size:11px;color:#888;font-weight:normal;margin-left:6px;">(min. 6 characters)</span>
                    </label>
                    <div style="position:relative;">
                        <input type="password" id="userPassword" minlength="6" placeholder="Set initial password" style="padding-right:44px;">
                        <button type="button" onclick="toggleUserPasswordVisibility()" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:16px;" title="Show/hide password">👁️</button>
                    </div>
                    <div id="editPasswordNote" style="display:none;font-size:11.5px;color:#888;margin-top:5px;">Leave blank to keep current password unchanged.</div>
                </div>
                <div class="form-group">
                    <label>Role <span class="required">*</span></label>
                    <select id="userRole" required>
                        <option value="driver">🚗 Driver</option>
                        <option value="driver_supervisor">🚦 Driver Supervisor</option>
                        <option value="maintenance_supervisor">🔩 Maintenance Supervisor</option>
                        <option value="vehicle_engineer">🔧 Vehicle Engineer</option>
                        <option value="supervisor">👷 Supervisor</option>
                        <option value="accountant">🧾 Accountant</option>
                        <option value="sales_marketing">📣 Sales & Marketing</option>
                        <option value="hr">🧑‍💼 HR</option>
                        <option value="manager">👔 Manager</option>
                        <option value="executive">💼 Executive</option>
                        <option value="admin">🛡️ Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Status <span class="required">*</span></label>
                    <select id="userStatus" required>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div id="userSaveError" style="display:none;background:#ffebee;border-radius:8px;padding:10px 14px;font-size:13px;color:#c62828;margin-bottom:10px;"></div>
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;" id="saveUserBtn">Save User</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Permission Control Modal -->
    <div id="permissionModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="permModalTitle">
        <div class="modal-content" style="max-width:680px;">
            <div class="modal-header" style="position:sticky;top:0;z-index:10;background:white;border-radius:15px 15px 0 0;">
                <div>
                    <h3 id="permModalTitle" style="font-size:17px;">🔐 Manage Permissions</h3>
                    <p id="permModalSubtitle" style="font-size:12px;color:#888;margin-top:2px;font-weight:400;"></p>
                </div>
                <button class="close-btn" onclick="closeModal('permissionModal')" aria-label="Close">&times;</button>
            </div>

            <!-- User info strip -->
            <div id="permModalUserInfo" style="display:flex;align-items:center;gap:14px;padding:14px 0;border-bottom:2px solid #f0f4ff;margin-bottom:4px;flex-wrap:wrap;"></div>
            <input type="hidden" id="permModalUserId">

            <!-- Quick actions bar -->
            <div class="perm-quick-bar">
                <span style="font-size:12px;color:#888;font-weight:600;align-self:center;">Quick:</span>
                <button class="perm-quick-btn perm-quick-allow" onclick="quickPermAll(true)">✅ Allow All</button>
                <button class="perm-quick-btn perm-quick-deny"  onclick="quickPermAll(false)">❌ Deny All</button>
                <button class="perm-quick-btn perm-quick-reset" onclick="resetUserPermissions()">↺ Role Default</button>
            </div>

            <!-- Group 1 -->
            <div class="perm-section-title">📋 Reports &amp; Data Access</div>
            <div id="permRows1"></div>

            <!-- Group 2 -->
            <div class="perm-section-title">⚙️ Management Actions</div>
            <div id="permRows2"></div>

            <!-- Group 3 -->
            <div class="perm-section-title">🎫 Tickets &amp; Finance</div>
            <div id="permRows3"></div>

            <!-- Save bar (sticky on mobile) -->
            <div style="display:flex;gap:10px;margin-top:22px;padding-top:14px;border-top:1px solid #f0f0f0;position:sticky;bottom:0;background:white;padding-bottom:4px;">
                <button class="btn btn-primary" style="flex:1;min-height:48px;" onclick="saveUserPermissions()">💾 Save Changes</button>
                <button class="btn btn-secondary" style="min-height:48px;min-width:100px;" onclick="closeModal('permissionModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div id="ticketModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="ticketModalTitle">
        <div class="modal-content" style="max-width:620px;">
            <div class="modal-header">
                <h3 id="ticketModalTitle">🎫 Request Details</h3>
                <button class="close-btn" onclick="closeModal('ticketModal')" aria-label="Close">&times;</button>
            </div>
            <div id="ticketDetailContent"></div>
            <div id="ticketApprovalActions" style="display:none; margin-top:20px;"></div>
        </div>
    </div>

    <!-- Financial Detail Modal (View Only) -->
    <div id="financialModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="financialModalTitle">
        <div class="modal-content" style="max-width:600px;">
            <div class="modal-header">
                <h3 id="financialModalTitle">💰 Financial Details</h3>
                <button class="close-btn" onclick="closeModal('financialModal')" aria-label="Close">&times;</button>
            </div>
            <div id="financialDetailContent"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle">
        <div class="modal-content" style="max-width: 540px;">
            <div class="modal-header">
                <h3 id="settingsModalTitle">⚙️ Settings</h3>
                <div style="display:flex;gap:8px;align-items:center;">
                    <button class="btn btn-primary" onclick="openFirebaseSetup()" style="font-size:12px;padding:7px 14px;min-height:36px;">🔥 Firebase Setup</button>
                    <button class="close-btn" onclick="closeModal('settingsModal')" aria-label="Close">&times;</button>
                </div>
            </div>

            <!-- Google Sheets Section -->
            <div class="settings-section">
                <h4>🔗 Google Sheets Sync — Full Setup</h4>

                <!-- Step-by-step guide -->
                <div class="sync-info-box" style="margin-bottom:14px;">
                    <strong>📋 Step-by-step setup:</strong>
                    <ol style="margin:8px 0 0 16px;line-height:2;">
                        <li>Go to <a href="https://script.google.com" target="_blank" style="color:var(--secondary-color);">script.google.com</a> → <strong>New project</strong></li>
                        <li>Delete any existing code. Paste the script below into the editor.</li>
                        <li>Click <strong>Deploy → New deployment</strong></li>
                        <li>Type: <code>Web app</code> · Execute as: <code>Me</code> · Access: <code>Anyone</code></li>
                        <li>Authorize the app (click "Allow")</li>
                        <li>Copy the <strong>Web App URL</strong> and paste it below</li>
                    </ol>
                </div>

                <!-- Apps Script code block -->
                <div style="margin-bottom:14px;">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
                        <label style="font-size:13px;font-weight:700;color:var(--primary-color);">📄 Google Apps Script Code</label>
                        <button onclick="copyAppsScript()" class="btn btn-secondary" style="font-size:12px;padding:5px 12px;">📋 Copy</button>
                    </div>
                    <textarea id="appsScriptCode" readonly style="font-family:monospace;font-size:11px;background:#1e1e2e;color:#cdd6f4;border:none;border-radius:10px;padding:14px;width:100%;height:220px;resize:vertical;box-sizing:border-box;line-height:1.5;"></textarea>
                </div>

                <!-- URL input -->
                <div class="form-group" style="margin-bottom: 6px;">
                    <label style="font-size: 13px; color: var(--primary-color); font-weight: 600;">Web App URL</label>
                    <input type="url" id="sheetsUrlInput" class="sheet-url-input"
                           placeholder="https://script.google.com/macros/s/AKfy.../exec"
                           oninput="validateSheetsUrl(this)">
                </div>
                <p id="sheetsUrlFeedback" class="sync-last-time"></p>
                <div style="display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="saveSheetsUrl()" style="flex: 1;">💾 Save & Connect</button>
                    <button class="btn btn-secondary" onclick="testSheetsConnection()" style="flex: 1;">🔌 Test Connection</button>
                    <button class="btn btn-danger" onclick="disconnectSheets()" style="flex: 1;" id="disconnectBtn">🗑️ Disconnect</button>
                </div>
                <div id="syncActions" style="margin-top: 14px; display: none; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="syncFromSheets()" style="flex:1;">⬇️ Pull All from Sheets</button>
                    <button class="btn btn-primary"  onclick="syncToSheets()"   style="flex:1;">⬆️ Push All to Sheets</button>
                </div>
                <p id="lastSyncTime" class="sync-last-time"></p>
                <p style="font-size:11px;color:#aaa;margin-top:8px;">Syncs: Users · Reports · Tickets · Vehicles · Campaigns</p>
            </div>

            <!-- Auto sync toggle -->
            <div class="settings-section" style="margin-bottom: 0;">
                <h4>🔄 Auto Sync</h4>
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <span style="font-size: 14px; color: #555;">Sync automatically every 5 minutes</span>
                    <label style="position:relative; display:inline-block; width:48px; height:26px; cursor:pointer;">
                        <input type="checkbox" id="autoSyncToggle" onchange="toggleAutoSync(this.checked)"
                               style="opacity:0; width:0; height:0;">
                        <span id="autoSyncSlider" style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0;
                              background:#ccc; border-radius:26px; transition:.3s;">
                            <span id="autoSyncThumb" style="position:absolute; height:20px; width:20px; left:3px; bottom:3px;
                                  background:white; border-radius:50%; transition:.3s;"></span>
                        </span>
                    </label>
                </div>
            </div>

            <!-- BACKUP & RESTORE -->
            <div class="settings-section" style="margin-top:20px;border-top:1px solid #f0f0f0;padding-top:20px;margin-bottom:0;">
                <h4>💾 Backup &amp; Restore</h4>
                <p style="font-size:13px;color:#666;margin-bottom:16px;line-height:1.7;">
                    Download a full local backup of all your data (users, reports, vehicles, tickets) as a JSON file.
                    Restore from any previous backup file at any time.
                </p>

                <!-- Last backup info -->
                <div id="lastBackupInfo" style="background:#f0f4ff;border-radius:10px;padding:12px 14px;font-size:13px;color:#3949ab;margin-bottom:16px;display:none;">
                    <span id="lastBackupText"></span>
                </div>

                <!-- Action buttons -->
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="backupAllData()" style="flex:1;min-height:44px;gap:6px;display:flex;align-items:center;justify-content:center;">
                        📥 Download Backup
                    </button>
                    <label class="btn btn-secondary" style="flex:1;min-height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;margin:0;">
                        📤 Restore from File
                        <input type="file" accept=".json" id="restoreFileInput" onchange="restoreFromBackup(this)" style="display:none;">
                    </label>
                </div>

                <!-- Restore status -->
                <div id="restoreStatus" style="display:none;margin-top:12px;padding:12px 14px;border-radius:10px;font-size:13px;line-height:1.6;"></div>

                <p style="font-size:11px;color:#aaa;margin-top:10px;">
                    Backup includes: Users · Reports · Vehicles · Tickets · Campaigns · Settings
                </p>
            </div>

            <!-- SECURITY / RECOVERY PIN -->
            <div class="settings-section" style="margin-top:20px;border-top:1px solid #f0f0f0;padding-top:20px;margin-bottom:0;">
                <h4>🔐 Security &amp; Recovery</h4>
                <p style="font-size:13px;color:#666;margin-bottom:14px;line-height:1.6;">
                    Set a 6-digit Recovery PIN. If you ever forget the admin password, this PIN lets you reset it from the login screen. <strong>Write it down and keep it safe.</strong>
                </p>
                <div id="currentPinStatus" style="font-size:13px;margin-bottom:12px;"></div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
                    <input type="number" id="newRecoveryPin" placeholder="New 6-digit PIN" min="100000" max="999999"
                           style="padding:10px 14px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:15px;font-weight:700;letter-spacing:3px;width:160px;text-align:center;">
                    <button class="btn btn-primary" onclick="saveRecoveryPin()" style="min-height:42px;">💾 Save PIN</button>
                    <button class="btn btn-secondary" onclick="clearRecoveryPin()" style="min-height:42px;" id="clearPinBtn">🗑️ Clear PIN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" role="alert">
        <span id="toastIcon">✓</span>
        <span id="toastMessage">Success!</span>
    </div>

    <script>
        // ==================== UTILITY FUNCTIONS ====================
        const Utils = {
            showLoading(show = true) {
                document.getElementById('globalLoader').style.display = show ? 'flex' : 'none';
            },

            formatDate(date, format = 'short') {
                const d = new Date(date);
                if (isNaN(d.getTime())) return 'Invalid Date';
                if (format === 'short') {
                    return d.toLocaleDateString('en-SA', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
                return d.toLocaleString('en-SA', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            formatCurrency(amount) {
                return new Intl.NumberFormat('en-SA', {
                    style: 'currency',
                    currency: 'SAR',
                    minimumFractionDigits: 2
                }).format(amount || 0);
            },

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            validateVehicleNumber(vehicleNumber) {
                const vehicleRegex = /^[A-Z]{3}-\d{4}$/;
                return vehicleRegex.test(vehicleNumber);
            },

            hashPassword: async (password) => {
                const msgBuffer = new TextEncoder().encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            },

            generateId(items) {
                if (items.length === 0) return 1;
                const numericIds = items.map(i => typeof i.id === 'number' ? i.id : parseInt(i.id)).filter(n => !isNaN(n));
                return numericIds.length > 0 ? Math.max(...numericIds) + 1 : Date.now();
            },

            showToast(message, isError = false, duration = 3000) {
                const toast = document.getElementById('toast');
                document.getElementById('toastMessage').textContent = message;
                document.getElementById('toastIcon').textContent = isError ? '❌' : '✓';
                toast.className = 'toast' + (isError ? ' error' : '');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), duration);
            },

            escapeHTML(str) {
                if (str === null || str === undefined) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            },

            async safeAsync(fn, errorMessage = 'Operation failed') {
                try {
                    this.showLoading(true);
                    return await fn();
                } catch (error) {
                    console.error(error);
                    this.showToast(`${errorMessage}: ${error.message}`, true);
                } finally {
                    this.showLoading(false);
                }
            },

            isAdmin() {
                return AppState.currentUser && AppState.currentUser.role === 'admin';
            },

            canManageTickets() {
                if (!AppState.currentUser) return false;
                return getEffectivePermissions(AppState.currentUser).canManageTickets === true;
            },

            canManageFinancial() {
                if (!AppState.currentUser) return false;
                return getEffectivePermissions(AppState.currentUser).canManageFinancial === true;
            },

            // Debounced sync for performance
            debouncedSync: null
        };

        // Initialize debounced sync
        Utils.debouncedSync = Utils.debounce(async () => {
            if (DataService.isLinked() && AppState.currentUser) {
                await syncDataFromSheets();
            }
        }, 5000);

        // ==================== DATA SERVICE (Firestore + localStorage fallback for Sheets) ====================
        const DataService = {
            // ---- Firestore helpers (used by AppState setters) ----
            async saveCollection(collectionName, items) {
                if (!window.db) return;
                const { collection, doc, setDoc, writeBatch } = window.firebaseFns || {};
                if (!setDoc) return;
                try {
                    // Use batched writes for performance
                    // We store the entire array as a single document for simplicity
                    const ref = doc(window.db, 'appdata', collectionName);
                    await setDoc(ref, { items: items, updatedAt: new Date().toISOString() });
                } catch (e) {
                    console.warn(`Firestore save ${collectionName} failed:`, e.message);
                }
            },

            async loadCollection(collectionName) {
                if (!window.db) return [];
                const { doc, getDoc } = window.firebaseFns || {};
                if (!getDoc) return [];
                try {
                    const ref = doc(window.db, 'appdata', collectionName);
                    const snap = await getDoc(ref);
                    return snap.exists() ? (snap.data().items || []) : [];
                } catch (e) {
                    console.warn(`Firestore load ${collectionName} failed:`, e.message);
                    return [];
                }
            },

            // ---- Realtime listeners setup ----
            setupListeners(onUpdate) {
                if (!window.db) return [];
                const { doc, onSnapshot } = window.firebaseFns || {};
                if (!onSnapshot) return [];
                const unsubscribers = [];
                const collections = ['users','reports','tickets','vehicles','campaigns'];
                collections.forEach(col => {
                    try {
                        const ref = doc(window.db, 'appdata', col);
                        const unsub = onSnapshot(ref, (snap) => {
                            if (snap.exists()) {
                                AppState.data[col] = snap.data().items || [];
                                if (onUpdate) onUpdate(col);
                            }
                        });
                        unsubscribers.push(unsub);
                    } catch(e) { console.warn('Listener setup failed:', col, e.message); }
                });
                return unsubscribers;
            },

            // ---- localStorage-backed Sheets helpers (kept for optional Sheets sync) ----
            getSheetsUrl()  { return localStorage.getItem('rihlatiSheetsUrl') || ''; },
            setSheetsUrl(u) { localStorage.setItem('rihlatiSheetsUrl', u); },
            clearSheetsUrl(){ localStorage.removeItem('rihlatiSheetsUrl'); },
            getLastSync()   { return localStorage.getItem('rihlatiLastSync') || ''; },
            setLastSync()   { localStorage.setItem('rihlatiLastSync', new Date().toISOString()); },
            isLinked()      { return !!this.getSheetsUrl(); },

            async sheetsGet(action) {
                const url = this.getSheetsUrl();
                if (!url) throw new Error('No Google Sheets URL configured');
                const res = await fetch(`${url}?action=${action}`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();
                if (json.error) throw new Error(json.error);
                return json;
            },

            async sheetsPost(payload) {
                const url = this.getSheetsUrl();
                if (!url) throw new Error('No Google Sheets URL configured');
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const json = await res.json();
                if (json.error) throw new Error(json.error);
                return json;
            },

            async pullFromSheets() {
                const remote = await this.sheetsGet('getAll');
                AppState.data.users     = remote.users     || AppState.data.users     || [];
                AppState.data.reports   = remote.reports   || AppState.data.reports   || [];
                AppState.data.tickets   = remote.tickets   || AppState.data.tickets   || [];
                AppState.data.vehicles  = remote.vehicles  || AppState.data.vehicles  || [];
                AppState.data.campaigns = remote.campaigns || AppState.data.campaigns || [];
                this.setLastSync();
                return { users: AppState.data.users.length, reports: AppState.data.reports.length, tickets: AppState.data.tickets.length };
            },

            async pushToSheets() {
                const result = await this.sheetsPost({
                    action:    'saveAll',
                    users:     AppState.data.users     || [],
                    reports:   AppState.data.reports   || [],
                    tickets:   AppState.data.tickets   || [],
                    vehicles:  AppState.data.vehicles  || [],
                    campaigns: AppState.data.campaigns || []
                });
                this.setLastSync();
                return result;
            },

            async ping() {
                const result = await this.sheetsGet('ping');
                return result.ok === true;
            },

            initializeDefaultData() {
                // Default in-memory seed data (used as fallback before Firestore loads)
                return {
                    users: [
                        {
                            id: 1,
                            username: 'admin',
                            password: '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918', // admin
                            name: 'Admin User',
                            email: 'admin@rihlati.com',
                            role: 'admin',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 2,
                            username: 'manager1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Fahad Al-Otaibi',
                            email: 'fahad@rihlati.com',
                            role: 'manager',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 3,
                            username: 'supervisor1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Nasser Al-Ghamdi',
                            email: 'nasser@rihlati.com',
                            role: 'supervisor',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 4,
                            username: 'drvsupervisor1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Walid Al-Qahtani',
                            email: 'walid@rihlati.com',
                            role: 'driver_supervisor',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 5,
                            username: 'maintsupervisor1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Rami Al-Dosari',
                            email: 'rami@rihlati.com',
                            role: 'maintenance_supervisor',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 6,
                            username: 'hr1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Sara Al-Zahrani',
                            email: 'sara@rihlati.com',
                            role: 'hr',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 7,
                            username: 'accountant1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Lina Al-Rashidi',
                            email: 'lina@rihlati.com',
                            role: 'accountant',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 8,
                            username: 'sales1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Yousef Al-Malki',
                            email: 'yousef@rihlati.com',
                            role: 'sales_marketing',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 9,
                            username: 'exec1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Tariq Al-Harbi',
                            email: 'tariq@rihlati.com',
                            role: 'executive',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 10,
                            username: 'engineer1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Omar Al-Shehri',
                            email: 'omar@rihlati.com',
                            role: 'vehicle_engineer',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 11,
                            username: 'driver1',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Ahmed Mohammed',
                            email: 'ahmed@rihlati.com',
                            role: 'driver',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: 12,
                            username: 'driver2',
                            password: '494d022492052a06f8f81949639a1d148c1051fa3d4e4688fbd96efe649cd382', // driver123
                            name: 'Khalid Ali',
                            email: 'khalid@rihlati.com',
                            role: 'driver',
                            status: 'active',
                            createdAt: new Date().toISOString()
                        }
                    ],
                    reports: [
                        {
                            id: 1,
                            userId: 2,
                            driverName: 'Ahmed Mohammed',
                            date: '2026-02-15',
                            type: 'daily',
                            vehicleNumber: 'ABC-1234',
                            odometer: 45000,
                            fuel: 45.5,
                            expenses: 250,
                            route: 'Riyadh to Medina',
                            notes: 'Regular daily route. No issues.',
                            status: 'approved',
                            submittedAt: '2026-02-15T08:30:00',
                            reviewedAt: '2026-02-15T10:00:00'
                        },
                        {
                            id: 2,
                            userId: 3,
                            driverName: 'Khalid Ali',
                            date: '2026-02-15',
                            type: 'maintenance',
                            vehicleNumber: 'XYZ-5678',
                            odometer: 32000,
                            fuel: 0,
                            expenses: 450,
                            route: 'Service Center',
                            notes: 'Oil change and tire rotation completed.',
                            status: 'pending',
                            submittedAt: '2026-02-15T14:20:00'
                        }
                    ],
                    vehicles: [],
                    tickets: [
                        {
                            id: 1,
                            type: 'maintenance',
                            submittedBy: 4,
                            submitterName: 'Walid Al-Qahtani',
                            submitterRole: 'driver_supervisor',
                            driverName: 'Ahmed Mohammed',
                            vehicle: 'ABC-1234',
                            maintType: 'oil_change',
                            cost: 450,
                            priority: 'high',
                            requestedDate: '2026-02-20',
                            notes: 'Engine oil needs urgent change',
                            status: 'pending',
                            submittedAt: '2026-02-15T16:30:00'
                        },
                        {
                            id: 2,
                            type: 'fuel',
                            submittedBy: 4,
                            submitterName: 'Walid Al-Qahtani',
                            submitterRole: 'driver_supervisor',
                            driverName: 'Khalid Ali',
                            vehicle: 'XYZ-5678',
                            liters: 80,
                            cost: 240,
                            station: 'Al-Dabab Station',
                            requestedDate: '2026-02-16',
                            notes: 'Need fuel for long trip',
                            status: 'pending',
                            submittedAt: '2026-02-15T17:00:00'
                        }
                    ],
                    campaigns: [
                        {
                            id: 1,
                            name: 'Summer Fleet Promotion',
                            type: 'digital',
                            budget: 5000,
                            startDate: '2026-03-01',
                            endDate: '2026-03-31',
                            expectedRoi: 150,
                            targetAudience: 'Corporate clients',
                            description: 'Digital campaign targeting corporate sector',
                            status: 'pending',
                            submittedBy: 8,
                            submitterName: 'Yousef Al-Malki',
                            submittedAt: '2026-02-14T10:00:00'
                        }
                    ]
                };

                return defaultData;
            }
        };

        // ==================== SYNC FUNCTIONS ====================
        
        async function syncDataFromSheets() {
            if (!DataService.isLinked()) return;
            
            try {
                Utils.showLoading(true);
                setSyncStatus('syncing', 'Syncing...');
                
                const counts = await DataService.pullFromSheets();
                
                // Update UI based on current user's permissions
                if (AppState.currentUser) {
                    refreshAllSections();
                }
                
                setSyncStatus('connected', 'Connected');
                updateLastSyncLabel();
                Utils.showToast(`🔄 Data synced: ${counts.users || 0} users, ${counts.reports || 0} reports, ${counts.tickets || 0} tickets`);
            } catch (error) {
                console.error('Sync failed:', error);
                setSyncStatus('offline', 'Sync failed');
                Utils.showToast('Sync failed: ' + error.message, true);
            } finally {
                Utils.showLoading(false);
            }
        }

        async function manualSync() {
            if (!DataService.isLinked()) {
                Utils.showToast('Google Sheets not connected', true);
                return;
            }
            await syncDataFromSheets();
        }

        // Helper: refresh all UI sections based on permissions
        function refreshAllSections() {
            if (!AppState.currentUser) return;
            const perms = getEffectivePermissions(AppState.currentUser);
            if (perms.canViewAllReports) { loadAdminDashboard(); loadAdminReports(); }
            if (perms.canViewMyReports) loadMyReports();
            if (perms.canManageTickets) { loadAdminTickets(); updatePendingTicketsBadge(); }
            if (perms.canViewFinancial || perms.canManageFinancial) loadFinancialDashboard();
            if (perms.canManageCampaigns) loadSalesDashboard();
            const activeSection = document.querySelector('.content-section.active');
            if (activeSection) {
                const id = activeSection.id;
                if (id === 'adminDashboard') loadAdminDashboard();
                else if (id === 'adminReports') loadAdminReports();
                else if (id === 'adminUsers') loadUsersTable();
                else if (id === 'adminPermissions') loadPermissionsPanel();
                else if (id === 'adminAnalytics') loadAnalytics();
                else if (id === 'userDashboard') loadUserDashboard();
                else if (id === 'myReports') loadMyReports();
                else if (id === 'myTickets') loadMyTickets();
                else if (id === 'adminTickets') loadAdminTickets();
                else if (id === 'vehicleManagement') loadVehiclesTable();
                else if (id === 'financialDashboard') loadFinancialDashboard();
                else if (id === 'salesDashboard') loadSalesDashboard();
            }
        }

        // triggerSyncAfterChange is a no-op now (Firestore handles real-time sync)
        function triggerSyncAfterChange() {
            // Firestore real-time listeners handle sync automatically
        }

        // ==================== APPLICATION STATE ====================
        const AppState = {
            currentUser: null,
            data: DataService.initializeDefaultData(),
            sessionTimeout: 30 * 60 * 1000, // 30 minutes
            lastActivity: Date.now(),
            _unsubscribers: [],

            get users() { return this.data.users; },
            set users(value) { 
                this.data.users = value;
                DataService.saveCollection('users', value);
            },

            get reports() { return this.data.reports; },
            set reports(value) { 
                this.data.reports = value;
                DataService.saveCollection('reports', value);
            },

            get vehicles() { return this.data.vehicles; },
            set vehicles(value) { 
                this.data.vehicles = value;
                DataService.saveCollection('vehicles', value);
            },

            get tickets() { return this.data.tickets || []; },
            set tickets(value) {
                this.data.tickets = value;
                DataService.saveCollection('tickets', value);
            },

            get campaigns() { return this.data.campaigns || []; },
            set campaigns(value) {
                this.data.campaigns = value;
                DataService.saveCollection('campaigns', value);
            },

            updateActivity() {
                this.lastActivity = Date.now();
            },

            checkSession() {
                if (this.currentUser && Date.now() - this.lastActivity > this.sessionTimeout) {
                    logout();
                    Utils.showToast(t('sessionExpired'), true);
                    return false;
                }
                return true;
            }
        };

        // ==================== ROLE PERMISSIONS ====================

        // All editable permission keys with metadata
        const PERM_DEFS = {
            canViewAllReports:  { label: 'View All Reports',    desc: 'See all reports from every user',   group: 1 },
            canViewMyReports:   { label: 'View My Reports',     desc: 'Access personal report history',    group: 1 },
            canViewAnalytics:   { label: 'View Analytics',      desc: 'Access charts and analytics',       group: 1 },
            canViewFinancial:   { label: 'View Financial',       desc: 'Access financial dashboard',        group: 1 },
            canSubmitReport:    { label: 'Submit Reports',       desc: 'Create and submit daily reports',   group: 1 },
            canApprove:         { label: 'Approve Reports',      desc: 'Approve pending reports',           group: 2 },
            canReject:          { label: 'Reject Reports',       desc: 'Reject submitted reports',          group: 2 },
            canManageUsers:     { label: 'Manage Users',         desc: 'Add, edit, delete users',           group: 2 },
            canManagePermissions:{ label: 'Manage Permissions', desc: 'Control user permission settings',  group: 2 },
            canSubmitTicket:    { label: 'Submit Requests',      desc: 'Raise maintenance/fuel/leave tickets', group: 3 },
            canManageTickets:   { label: 'Manage Requests',      desc: 'Approve or reject all requests',   group: 3 },
            canManageFinancial: { label: 'Manage Financial',     desc: 'Full financial management access',  group: 3 },
            canManageCampaigns: { label: 'Sales & Marketing',    desc: 'Manage campaigns and marketing',   group: 3 },
            canManageVehicles:  { label: 'Manage Vehicles',      desc: 'Add, edit, delete vehicle records', group: 2 },
        };

        const ROLES = {
            admin: {
                label: 'Administrator', labelAr: 'مدير النظام', icon: '🛡️',
                color: '#1976d2', bg: '#e3f2fd',
                nav: ['dashboard', 'reports', 'users', 'analytics', 'tickets', 'financial'],
                canApprove: true, canReject: true, canManageUsers: true,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: true, canViewMyReports: false,
                canSubmitTicket: false, canManageTickets: true, canManageFinancial: true, canViewFinancial: true, canManageCampaigns: true,
                canManagePermissions: true, canManageVehicles: true,
            },
            manager: {
                label: 'Manager', labelAr: 'مدير', icon: '👔',
                color: '#6a1b9a', bg: '#f3e5f5',
                nav: ['dashboard', 'reports', 'analytics', 'tickets'],
                canApprove: true, canReject: true, canManageUsers: false,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: true, canViewMyReports: false,
                canSubmitTicket: false, canManageTickets: true, canManageFinancial: false, canManageCampaigns: false,
                canManageVehicles: true,
            },
            supervisor: {
                label: 'Supervisor', labelAr: 'مشرف', icon: '👷',
                color: '#e65100', bg: '#fff3e0',
                nav: ['dashboard', 'reports'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: false, canViewMyReports: false,
                canSubmitTicket: false, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            },
            driver_supervisor: {
                label: 'Driver Supervisor', labelAr: 'مشرف السائقين', icon: '🚦',
                color: '#1565c0', bg: '#e3f2fd',
                nav: ['dashboard', 'reports', 'tickets', 'myTickets'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: false, canViewMyReports: false,
                canSubmitTicket: true, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            },
            maintenance_supervisor: {
                label: 'Maintenance Supervisor', labelAr: 'مشرف الصيانة', icon: '🔩',
                color: '#4e342e', bg: '#efebe9',
                nav: ['dashboard', 'reports', 'submit', 'myReports', 'tickets', 'myTickets'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: true, canViewAllReports: true, canViewAnalytics: false, canViewMyReports: true,
                canSubmitTicket: true, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            },
            hr: {
                label: 'HR', labelAr: 'الموارد البشرية', icon: '🧑‍💼',
                color: '#00695c', bg: '#e0f2f1',
                nav: ['dashboard', 'users', 'reports'],
                canApprove: false, canReject: false, canManageUsers: true,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: false, canViewMyReports: false,
                canSubmitTicket: false, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            },
            accountant: {
                label: 'Accountant', labelAr: 'محاسب', icon: '🧾',
                color: '#2e7d32', bg: '#e8f5e9',
                nav: ['dashboard', 'reports', 'analytics', 'financial', 'tickets'],
                canApprove: true, canReject: true, canManageUsers: false,
                canSubmitReport: true, canViewAllReports: true, canViewAnalytics: true, canViewMyReports: true,
                canSubmitTicket: false, canManageTickets: true, canManageFinancial: true, canViewFinancial: true, canManageCampaigns: false,
                canManagePermissions: false,
            },
            sales_marketing: {
                label: 'Sales & Marketing', labelAr: 'المبيعات والتسويق', icon: '📣',
                color: '#ad1457', bg: '#fce4ec',
                nav: ['dashboard', 'reports', 'analytics', 'sales'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: true, canViewMyReports: false,
                canSubmitTicket: false, canManageTickets: false, canManageFinancial: false, canManageCampaigns: true,
                canCreateCampaign: true
            },
            executive: {
                label: 'Executive', labelAr: 'تنفيذي', icon: '💼',
                color: '#b71c1c', bg: '#ffebee',
                nav: ['dashboard', 'reports', 'analytics'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: false, canViewAllReports: true, canViewAnalytics: true, canViewMyReports: false,
                canSubmitTicket: false, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            },
            vehicle_engineer: {
                label: 'Vehicle Engineer', labelAr: 'مهندس المركبات', icon: '🔧',
                color: '#37474f', bg: '#eceff1',
                nav: ['dashboard', 'submit', 'myReports', 'reports'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: true, canViewAllReports: true, canViewAnalytics: false, canViewMyReports: true,
                canSubmitTicket: false, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            },
            driver: {
                label: 'Driver', labelAr: 'سائق', icon: '🚗',
                color: '#f57f17', bg: '#fffde7',
                nav: ['dashboard', 'submit', 'myReports'],
                canApprove: false, canReject: false, canManageUsers: false,
                canSubmitReport: true, canViewAllReports: false, canViewAnalytics: false, canViewMyReports: true,
                canSubmitTicket: false, canManageTickets: false, canManageFinancial: false, canManageCampaigns: false,
            }
        };

        function getRoleInfo(role) {
            return ROLES[role] || ROLES['driver'];
        }

        // Return effective permissions for a user (role defaults merged with custom overrides)
        function getEffectivePermissions(user) {
            const base = ROLES[user.role] || ROLES['driver'];
            const custom = user.customPermissions || {};
            return Object.assign({}, base, custom);
        }

        // ==================== SESSION MANAGEMENT ====================
        document.addEventListener('click', () => AppState.updateActivity());
        document.addEventListener('keypress', () => AppState.updateActivity());
        document.addEventListener('scroll', () => AppState.updateActivity());

        setInterval(() => {
            AppState.checkSession();
        }, 60000);

        // ==================== DEBOUNCED FUNCTIONS ====================
        const debouncedFilterReports = Utils.debounce((term) => {
            filterReports(term);
        }, 300);

        const debouncedFilterMyReports = Utils.debounce((term) => {
            filterMyReports(term);
        }, 300);

        // ==================== AUTH TAB SWITCH ====================
        function switchAuthTab(tab) {
            const isLogin = tab === 'login';
            document.getElementById('loginTab').style.display  = isLogin  ? '' : 'none';
            document.getElementById('signupTab').style.display = !isLogin ? '' : 'none';
            document.getElementById('tabLoginBtn').classList.toggle('active',  isLogin);
            document.getElementById('tabSignupBtn').classList.toggle('active', !isLogin);
            const slider = document.getElementById('loginTabSlider');
            if (slider) slider.classList.toggle('right', !isLogin);
        }

        function togglePassVis(inputId, btn) {
            const inp = document.getElementById(inputId);
            if (!inp) return;
            const show = inp.type === 'password';
            inp.type = show ? 'text' : 'password';
            btn.textContent = show ? '🙈' : '👁️';
            btn.style.opacity = show ? '0.8' : '0.4';
        }

        // ==================== AUTHENTICATION ====================
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = `<span>${t('signingIn')}</span>`;
            
            try {
                if (!window.firebaseFns || !window.auth) {
                    Utils.showToast(currentLang === 'ar' ? 'Firebase غير جاهز. يرجى الانتظار…' : 'Firebase not ready. Please wait…', true);
                    return;
                }
                const { signInWithEmailAndPassword } = window.firebaseFns;
                const cred = await signInWithEmailAndPassword(window.auth, email, password);
                // onAuthStateChanged will handle the rest
                Utils.showToast(t('signingIn'));
            } catch (error) {
                let msg = currentLang === 'ar' ? 'فشل تسجيل الدخول. يرجى المحاولة مرة أخرى.' : 'Login failed. Please try again.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    msg = currentLang === 'ar' ? 'البريد الإلكتروني أو كلمة المرور غير صحيحة.' : 'Invalid email or password.';
                } else if (error.code === 'auth/too-many-requests') {
                    msg = currentLang === 'ar' ? 'محاولات كثيرة. يرجى المحاولة لاحقاً.' : 'Too many attempts. Please try again later.';
                } else if (error.code === 'auth/network-request-failed') {
                    msg = currentLang === 'ar' ? 'خطأ في الشبكة. تحقق من اتصالك.' : 'Network error. Check your connection.';
                }
                Utils.showToast(msg, true);
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = `<span>${t('signIn')}</span>`;
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const signupBtn = document.getElementById('signupBtn');
            
            if (!name) { Utils.showToast(currentLang === 'ar' ? 'يرجى إدخال اسمك الكامل' : 'Please enter your full name', true); return; }
            
            signupBtn.disabled = true;
            signupBtn.innerHTML = `<span>${t('creatingAccount')}</span>`;
            
            try {
                if (!window.firebaseFns || !window.auth) {
                    Utils.showToast('Firebase not ready. Please wait…', true);
                    return;
                }
                const { createUserWithEmailAndPassword } = window.firebaseFns;
                const cred = await createUserWithEmailAndPassword(window.auth, email, password);
                const uid = cred.user.uid;
                
                // Create user profile in Firestore
                const newUser = {
                    id: uid,
                    uid: uid,
                    email: email,
                    name: name,
                    role: 'driver',
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    customPermissions: null
                };
                
                // Add to users collection
                const updatedUsers = [...AppState.data.users, newUser];
                await DataService.saveCollection('users', updatedUsers);
                AppState.data.users = updatedUsers;
                
                Utils.showToast(`✅ Account created! Welcome, ${name}`);
            } catch (error) {
                let msg = 'Registration failed.';
                if (error.code === 'auth/email-already-in-use') msg = 'Email already registered.';
                else if (error.code === 'auth/weak-password') msg = 'Password too weak (min 6 characters).';
                else if (error.code === 'auth/invalid-email') msg = 'Invalid email address.';
                Utils.showToast(msg, true);
            } finally {
                signupBtn.disabled = false;
                signupBtn.innerHTML = '<span>Create Account</span>';
            }
        }

        // ==================== MOBILE MENU ====================
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('menuOverlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('show');
        }

        // ==================== NAVIGATION ====================
        function navigateTo(sectionId, title, element) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            element.classList.add('active');
            document.getElementById('currentPageTitle').textContent = title;
            
            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                toggleMobileMenu();
            }
            
            // Load section content
            switch(sectionId) {
                case 'adminDashboard':
                    loadAdminDashboard();
                    break;
                case 'adminReports':
                    loadAdminReports();
                    break;
                case 'adminUsers':
                    loadUsersTable();
                    break;
                case 'adminPermissions':
                    loadPermissionsPanel();
                    break;
                case 'adminAnalytics':
                    loadAnalytics();
                    break;
                case 'userDashboard':
                    loadUserDashboard();
                    break;
                case 'myReports':
                    loadMyReports();
                    break;
                case 'submitReport':
                    loadRoleReportForm();
                    break;
                case 'myTickets':
                    loadMyTickets();
                    break;
                case 'adminTickets':
                    loadAdminTickets();
                    break;
                case 'vehicleManagement':
                    loadVehiclesTable();
                    break;
                case 'financialDashboard':
                    loadFinancialDashboard();
                    break;
                case 'salesDashboard':
                    loadSalesDashboard();
                    break;
            }
        }

        // ==================== UNIFIED INTERFACE LOADER ====================
        function loadInterface() {
            const user = AppState.currentUser;
            const role = getRoleInfo(user.role);
            const perms = getEffectivePermissions(user);
            const navMenu = document.getElementById('navMenu');
            let navItems = '';

            // Dashboard — always shown
            {
                const section = perms.canViewAllReports ? 'adminDashboard' : 'userDashboard';
                navItems += `<div class="nav-item active" onclick="navigateTo('${section}', '${t('dashboard')}', this)" role="button" tabindex="0">
                    <i>📊</i><span>${t('dashboard')}</span></div>`;
            }
            if (perms.canViewAllReports) {
                navItems += `<div class="nav-item" onclick="navigateTo('adminReports', '${t('reports')}', this)" role="button" tabindex="0">
                    <i>📋</i><span>${t('reports')}</span></div>`;
            }
            if (perms.canManageUsers) {
                navItems += `<div class="nav-item" onclick="navigateTo('adminUsers', '${t('users')}', this)" role="button" tabindex="0">
                    <i>👥</i><span>${t('users')}</span></div>`;
            }
            if (perms.canManagePermissions || user.role === 'admin') {
                navItems += `<div class="nav-item" onclick="navigateTo('adminPermissions', '🔐 ${t('permissions')}', this)" role="button" tabindex="0">
                    <i>🔐</i><span>${t('permissions')}</span></div>`;
            }
            if (perms.canViewAnalytics) {
                navItems += `<div class="nav-item" onclick="navigateTo('adminAnalytics', '${t('analytics')}', this)" role="button" tabindex="0">
                    <i>📈</i><span>${t('analytics')}</span></div>`;
            }
            if (perms.canSubmitReport) {
                navItems += `<div class="nav-item" onclick="navigateTo('submitReport', '${t('submitReport')}', this)" role="button" tabindex="0">
                    <i>📝</i><span>${t('submitReport')}</span></div>`;
            }
            if (perms.canViewMyReports) {
                navItems += `<div class="nav-item" onclick="navigateTo('myReports', '${t('myReports')}', this)" role="button" tabindex="0">
                    <i>📋</i><span>${t('myReports')}</span></div>`;
            }
            if (perms.canSubmitTicket) {
                navItems += `<div class="nav-item" onclick="navigateTo('submitTicket', '${t('raiseRequest')}', this)" role="button" tabindex="0">
                    <i>🎫</i><span>${t('raiseRequest')}</span></div>`;
                navItems += `<div class="nav-item" onclick="navigateTo('myTickets', '${t('myRequests')}', this); loadMyTickets();" role="button" tabindex="0">
                    <i>📬</i><span>${t('myRequests')}</span></div>`;
            }
            if (perms.canManageTickets) {
                navItems += `<div class="nav-item" onclick="navigateTo('adminTickets', '${t('requests')}', this); loadAdminTickets();" role="button" tabindex="0">
                    <i>📥</i><span>${t('requests')}</span><span id="pendingTicketsBadge" style="background:#f44336;color:white;border-radius:10px;padding:1px 7px;font-size:11px;margin-${currentLang === 'ar' ? 'right' : 'left'}:6px;display:none;"></span></div>`;
            }
            if (perms.canManageVehicles) {
                navItems += `<div class="nav-item" onclick="navigateTo('vehicleManagement', '🚗 ${currentLang === 'ar' ? 'المركبات' : 'Vehicles'}', this); loadVehiclesTable();" role="button" tabindex="0">
                    <i>🚗</i><span>${t('vehicles')}</span></div>`;
            }
            if (perms.canViewFinancial || perms.canManageFinancial) {
                navItems += `<div class="nav-item" onclick="navigateTo('financialDashboard', '💰 ${t('financial')}', this); loadFinancialDashboard();" role="button" tabindex="0">
                    <i>💰</i><span>${t('financial')}</span></div>`;
            }
            if (perms.canManageCampaigns) {
                navItems += `<div class="nav-item" onclick="navigateTo('salesDashboard', '📊 ${t('sales')}', this); loadSalesDashboard();" role="button" tabindex="0">
                    <i>📊</i><span>${t('sales')}</span></div>`;
            }

            navMenu.innerHTML = navItems;

            // Show Google Sheets controls only for admin
            const adminControls = document.getElementById('adminOnlyControls');
            if (adminControls) {
                adminControls.style.display = user.role === 'admin' ? 'flex' : 'none';
            }

            // Add sync button to top bar for all users if Sheets is connected
            const topBarActions = document.getElementById('topBarActions');
            if (topBarActions && DataService.isLinked() && AppState.currentUser) {
                topBarActions.innerHTML = `
                    <button class="btn btn-secondary" onclick="manualSync()" style="padding: 8px 16px; min-height: 40px; font-size: 13px;">
                        🔄 Sync
                    </button>
                `;
            }

            // Load the first section
            if (perms.canViewAllReports) {
                loadAdminDashboard();
            } else {
                loadUserDashboard();
                if (perms.canSubmitReport) {
                    loadRoleReportForm();
                }
            }
        }

        // ==================== ADMIN DASHBOARD ====================

        function loadAdminDashboard() {
            const reports = AppState.reports;
            
            // Stats
            const totalReports = reports.length;
            const pendingReports = reports.filter(r => r.status === 'pending').length;
            const approvedReports = reports.filter(r => r.status === 'approved').length;
            const activeDrivers = AppState.users.filter(u => u.role === 'driver' && u.status === 'active').length;
            const pendingTickets = AppState.tickets.filter(tk => tk.status === 'pending').length;
            
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${totalReports}</div>
                            <div class="stat-label">${t('totalReports')}</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">📋</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${pendingReports}</div>
                            <div class="stat-label">${t('pendingReports')}</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">⏳</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${pendingTickets}</div>
                            <div class="stat-label">${currentLang === 'ar' ? 'طلبات قيد الانتظار' : 'Pending Requests'}</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #ff6b6b, #feca57);">🎫</div>
                    </div>
                    ${Utils.canManageTickets() && pendingTickets > 0 ? `<div style="margin-top:10px;"><button class="btn btn-primary" style="font-size:12px;padding:6px 14px;" onclick="navigateTo('adminTickets','${t('requests')}',document.querySelector('.nav-item[onclick*=adminTickets]'));loadAdminTickets()">${currentLang === 'ar' ? 'عرض الطلبات ←' : 'View Requests →'}</button></div>` : ''}
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${activeDrivers}</div>
                            <div class="stat-label">${t('totalDrivers')}</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">👥</div>
                    </div>
                </div>
            `;
            
            // Status Chart
            const statusCounts = {
                pending: pendingReports,
                approved: approvedReports,
                rejected: reports.filter(r => r.status === 'rejected').length
            };
            
            const chartGrid = document.getElementById('adminChartGrid');
            const maxCount = Math.max(...Object.values(statusCounts), 1);
            
            chartGrid.innerHTML = Object.entries(statusCounts).map(([status, count]) => {
                const labels = { 
                    pending: currentLang === 'ar' ? 'انتظار' : 'PENDING',
                    approved: currentLang === 'ar' ? 'موافق' : 'APPROVED',
                    rejected: currentLang === 'ar' ? 'مرفوض' : 'REJECTED'
                };
                return `
                <div class="chart-bar-container">
                    <div class="chart-value">${count}</div>
                    <div class="chart-bar" style="height: ${(count / maxCount) * 150}px; background: ${
                        status === 'approved' ? '#4caf50' : 
                        status === 'pending' ? '#ff9800' : '#f44336'
                    }"></div>
                    <div class="chart-label">${labels[status]}</div>
                </div>`;
            }).join('');
            
            // Recent reports
            const recentReports = reports.slice(-5).reverse();
            const container = document.getElementById('recentReportsContainer');
            
            if (recentReports.length > 0) {
                container.innerHTML = `
                    <div class="table-header">
                        <h3>${t('recentReports')}</h3>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>${t('date')}</th>
                                    <th>${currentLang === 'ar' ? 'السائق' : 'Driver'}</th>
                                    <th>${t('vehicle')}</th>
                                    <th>${t('type')}</th>
                                    <th>${t('statusCol')}</th>
                                    <th>${t('actions')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recentReports.map(r => {
                                    const driverName   = r.driverName   || r.name || 'Unknown';
                                    const vehicleNum   = r.vehicleNumber || 'N/A';
                                    const reportType   = r.type          || 'report';
                                    const reportStatus = r.status        || 'pending';
                                    const statusLabel = currentLang === 'ar' 
                                        ? ({pending:'انتظار',approved:'موافق',rejected:'مرفوض'}[reportStatus] || reportStatus)
                                        : reportStatus.toUpperCase();
                                    return `
                                    <tr>
                                        <td data-label="${t('date')}">${Utils.formatDate(r.date)}</td>
                                        <td data-label="${currentLang === 'ar' ? 'السائق' : 'Driver'}">${Utils.escapeHTML(driverName)}</td>
                                        <td data-label="${t('vehicle')}">${Utils.escapeHTML(vehicleNum)}</td>
                                        <td data-label="${t('type')}">${Utils.escapeHTML(reportType)}</td>
                                        <td data-label="${t('statusCol')}"><span class="badge badge-${Utils.escapeHTML(reportStatus)}">${statusLabel}</span></td>
                                        <td data-label="${t('actions')}" class="action-buttons">
                                            <button class="btn-icon" style="background: #e3f2fd; color: #1976d2;" onclick="viewReport('${r.id}')">
                                                👁️
                                            </button>
                                            ${reportStatus === 'pending' && (Utils.isAdmin() || Utils.canManageFinancial()) ? `
                                                <button class="btn-icon" style="background: #e8f5e9; color: #388e3c;" onclick="approveReport('${r.id}')">
                                                    ✓
                                                </button>
                                                <button class="btn-icon" style="background: #ffebee; color: #c62828;" onclick="rejectReport('${r.id}')">
                                                    ✗
                                                </button>
                                            ` : ''}
                                        </td>
                                    </tr>`;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <h3>${t('noReports')}</h3>
                        <p>${t('noReportsMsg')}</p>
                    </div>
                `;
            }
        }

        function loadAdminReports() {
            const container = document.getElementById('reportsTableContainer');
            const reports = AppState.reports.slice().reverse();
            
            if (reports.length > 0) {
                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>${t('id')}</th>
                                <th>${t('date')}</th>
                                <th>${currentLang === 'ar' ? 'السائق' : 'Driver'}</th>
                                <th>${t('vehicle')}</th>
                                <th>${t('type')}</th>
                                <th>${t('fuel')}</th>
                                <th>${t('expenses')}</th>
                                <th>${t('statusCol')}</th>
                                <th>${t('actions')}</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            ${reports.map(r => {
                                const driverName   = r.driverName   || r.name || 'Unknown';
                                const vehicleNum   = r.vehicleNumber || 'N/A';
                                const reportType   = r.type          || 'report';
                                const reportStatus = r.status        || 'pending';
                                const statusLabel = currentLang === 'ar' 
                                    ? ({pending:'انتظار',approved:'موافق',rejected:'مرفوض'}[reportStatus] || reportStatus)
                                    : reportStatus.toUpperCase();
                                return `
                                <tr data-search="${Utils.escapeHTML(driverName.toLowerCase())} ${Utils.escapeHTML(vehicleNum.toLowerCase())} ${Utils.escapeHTML(reportType.toLowerCase())} ${Utils.escapeHTML(reportStatus.toLowerCase())}">
                                    <td data-label="${t('id')}">${("#"+r.id)}</td>
                                    <td data-label="${t('date')}">${Utils.formatDate(r.date)}</td>
                                    <td data-label="${currentLang === 'ar' ? 'السائق' : 'Driver'}">${Utils.escapeHTML(driverName)}</td>
                                    <td data-label="${t('vehicle')}">${Utils.escapeHTML(vehicleNum)}</td>
                                    <td data-label="${t('type')}">${Utils.escapeHTML(reportType)}</td>
                                    <td data-label="${t('fuel')}">${r.fuel || 0} L</td>
                                    <td data-label="${t('expenses')}">${Utils.formatCurrency(r.expenses || 0)}</td>
                                    <td data-label="${t('statusCol')}"><span class="badge badge-${Utils.escapeHTML(reportStatus)}">${statusLabel}</span></td>
                                    <td data-label="${t('actions')}" class="action-buttons">
                                        <button class="btn-icon" style="background: #e3f2fd; color: #1976d2;" onclick="viewReport('${r.id}')" title="${t('viewDetails')}">
                                            👁️
                                        </button>
                                        ${reportStatus === 'pending' && (Utils.isAdmin() || Utils.canManageFinancial()) ? `
                                            <button class="btn-icon" style="background: #e8f5e9; color: #388e3c;" onclick="approveReport('${r.id}')" title="${t('approve')}">
                                                ✓
                                            </button>
                                            <button class="btn-icon" style="background: #ffebee; color: #c62828;" onclick="rejectReport('${r.id}')" title="${t('reject')}">
                                                ✗
                                            </button>
                                        ` : ''}
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <h3>No reports submitted</h3>
                        <p>Driver reports will appear here</p>
                    </div>
                `;
            }
        }

        function loadAnalytics() {
            const reports = AppState.reports;
            
            // Analytics Stats
            const totalExpenses = reports.reduce((sum, r) => sum + (r.expenses || 0), 0);
            const totalFuel = reports.reduce((sum, r) => sum + (r.fuel || 0), 0);
            const avgExpenses = reports.length > 0 ? totalExpenses / reports.length : 0;
            const reportsThisMonth = reports.filter(r => {
                const reportDate = new Date(r.date);
                const now = new Date();
                return reportDate.getMonth() === now.getMonth() && 
                       reportDate.getFullYear() === now.getFullYear();
            }).length;
            
            document.getElementById('analyticsStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${Utils.formatCurrency(totalExpenses)}</div>
                            <div class="stat-label">${t('totalExpenses')}</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">💰</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${totalFuel.toFixed(1)} L</div>
                            <div class="stat-label">${t('totalFuel')}</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">⛽</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${Utils.formatCurrency(avgExpenses)}</div>
                            <div class="stat-label">${currentLang === 'ar' ? 'متوسط لكل تقرير' : 'Avg. per Report'}</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">📊</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${reportsThisMonth}</div>
                            <div class="stat-label">${currentLang === 'ar' ? 'تقارير هذا الشهر' : 'Reports This Month'}</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">📅</div>
                    </div>
                </div>
            `;
            
            // Status Chart
            const statusCounts = {
                pending: reports.filter(r => r.status === 'pending').length,
                approved: reports.filter(r => r.status === 'approved').length,
                rejected: reports.filter(r => r.status === 'rejected').length
            };
            
            const statusChart = document.getElementById('statusChart');
            const maxStatus = Math.max(...Object.values(statusCounts), 1);
            
            statusChart.innerHTML = Object.entries(statusCounts).map(([status, count]) => `
                <div class="chart-bar-container">
                    <div class="chart-value">${count}</div>
                    <div class="chart-bar" style="height: ${(count / maxStatus) * 150}px; background: ${
                        status === 'approved' ? '#4caf50' : 
                        status === 'pending' ? '#ff9800' : '#f44336'
                    }"></div>
                    <div class="chart-label">${status.toUpperCase()}</div>
                </div>
            `).join('');
            
            // Type Chart
            const typeCounts = {};
            reports.forEach(r => {
                typeCounts[r.type] = (typeCounts[r.type] || 0) + 1;
            });
            
            const typeChart = document.getElementById('typeChart');
            const maxType = Math.max(...Object.values(typeCounts), 1);
            
            typeChart.innerHTML = Object.entries(typeCounts).map(([type, count]) => `
                <div class="chart-bar-container">
                    <div class="chart-value">${count}</div>
                    <div class="chart-bar" style="height: ${(count / maxType) * 150}px; background: linear-gradient(135deg, #667eea, #764ba2);"></div>
                    <div class="chart-label">${type}</div>
                </div>
            `).join('');
            
            // Monthly Chart
            const monthlyData = {};
            reports.forEach(r => {
                const month = new Date(r.date).toLocaleString('default', { month: 'short' });
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });
            
            const monthlyChart = document.getElementById('monthlyChart');
            const maxMonthly = Math.max(...Object.values(monthlyData), 1);
            
            monthlyChart.innerHTML = Object.entries(monthlyData).map(([month, count]) => `
                <div class="chart-bar-container">
                    <div class="chart-value">${count}</div>
                    <div class="chart-bar" style="height: ${(count / maxMonthly) * 150}px; background: linear-gradient(135deg, #ff5722, #ff9800);"></div>
                    <div class="chart-label">${month}</div>
                </div>
            `).join('');
        }

        // ==================== USER DASHBOARD ====================

        function loadUserDashboard() {
            const userReports = AppState.reports.filter(r => String(r.userId) === String(AppState.currentUser.id));
            const totalReports = userReports.length;
            const pendingReports = userReports.filter(r => r.status === 'pending').length;
            const approvedReports = userReports.filter(r => r.status === 'approved').length;
            const rejectedReports = userReports.filter(r => r.status === 'rejected').length;
            
            const statsGrid = document.getElementById('userStatsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${totalReports}</div>
                            <div class="stat-label">${t('totalReports')}</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">📋</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${pendingReports}</div>
                            <div class="stat-label">${t('pendingReports')}</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">⏳</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${approvedReports}</div>
                            <div class="stat-label">${t('approvedReports')}</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">✓</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${rejectedReports}</div>
                            <div class="stat-label">${currentLang === 'ar' ? 'مرفوضة' : 'Rejected'}</div>
                        </div>
                        <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a, #fee140);">✗</div>
                    </div>
                </div>
            `;
            
            // User Chart
            const statusCounts = { pending: pendingReports, approved: approvedReports, rejected: rejectedReports };
            const chartGrid = document.getElementById('userChartGrid');
            const maxCount = Math.max(...Object.values(statusCounts), 1);
            const chartLabels = {
                pending: currentLang === 'ar' ? 'انتظار' : 'PENDING',
                approved: currentLang === 'ar' ? 'موافق' : 'APPROVED',
                rejected: currentLang === 'ar' ? 'مرفوض' : 'REJECTED'
            };
            
            chartGrid.innerHTML = Object.entries(statusCounts).map(([status, count]) => `
                <div class="chart-bar-container">
                    <div class="chart-value">${count}</div>
                    <div class="chart-bar" style="height: ${(count / maxCount) * 150}px; background: ${
                        status === 'approved' ? '#4caf50' : 
                        status === 'pending' ? '#ff9800' : '#f44336'
                    }"></div>
                    <div class="chart-label">${chartLabels[status]}</div>
                </div>
            `).join('');
        }

        // ==================== REPORT FUNCTIONS ====================
        // (Role-based form functions defined later in ROLE-BASED REPORT FORMS section)

        function loadMyReports() {
            const container = document.getElementById('myReportsTableContainer');
            const myReports = AppState.reports
                .filter(r => String(r.userId) === String(AppState.currentUser.id))
                .slice()
                .reverse();
            
            if (myReports.length > 0) {
                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>${t('id')}</th>
                                <th>${t('date')}</th>
                                <th>${t('vehicle')}</th>
                                <th>${t('type')}</th>
                                <th>${currentLang === 'ar' ? 'عداد الكيلومتر' : 'Odometer'}</th>
                                <th>${t('fuel')}</th>
                                <th>${t('expenses')}</th>
                                <th>${t('statusCol')}</th>
                                <th>${t('actions')}</th>
                            </tr>
                        </thead>
                        <tbody id="myReportsTableBody">
                            ${myReports.map(r => {
                                const vehicleNum   = r.vehicleNumber || 'N/A';
                                const reportType   = r.type          || 'report';
                                const reportStatus = r.status        || 'pending';
                                const statusLabel = currentLang === 'ar' 
                                    ? ({pending:'انتظار',approved:'موافق',rejected:'مرفوض'}[reportStatus] || reportStatus)
                                    : reportStatus.toUpperCase();
                                return `
                                <tr data-search="${Utils.escapeHTML(vehicleNum.toLowerCase())} ${Utils.escapeHTML(reportType.toLowerCase())} ${Utils.escapeHTML(reportStatus.toLowerCase())}">
                                    <td data-label="${t('id')}">${("#"+r.id)}</td>
                                    <td data-label="${t('date')}">${Utils.formatDate(r.date)}</td>
                                    <td data-label="${t('vehicle')}">${Utils.escapeHTML(vehicleNum)}</td>
                                    <td data-label="${t('type')}">${Utils.escapeHTML(reportType)}</td>
                                    <td data-label="${currentLang === 'ar' ? 'عداد الكيلومتر' : 'Odometer'}">${r.odometer || 0} km</td>
                                    <td data-label="${t('fuel')}">${r.fuel || 0} L</td>
                                    <td data-label="${t('expenses')}">${Utils.formatCurrency(r.expenses || 0)}</td>
                                    <td data-label="${t('statusCol')}"><span class="badge badge-${Utils.escapeHTML(reportStatus)}">${statusLabel}</span></td>
                                    <td data-label="${t('actions')}">
                                        <button class="btn-icon" style="background: #e3f2fd; color: #1976d2;" onclick="viewReport('${r.id}')">
                                            👁️
                                        </button>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <h3>${t('noReports')}</h3>
                        <p>${currentLang === 'ar' ? 'انقر على "إرسال تقرير" لإنشاء أول تقرير لك' : 'Click "Submit Report" to create your first report'}</p>
                        <button class="btn btn-primary" onclick="document.querySelector('.nav-item[onclick*=submitReport]').click()" style="margin-top: 20px;">
                            ➕ ${currentLang === 'ar' ? 'إرسال أول تقرير' : 'Submit Your First Report'}
                        </button>
                    </div>
                `;
            }
        }

        function viewReport(reportId) {
            const report = AppState.reports.find(r => String(r.id) === String(reportId));
            if (!report) return;
            
            const details = document.getElementById('reportDetails');
            details.innerHTML = `
                <div style="line-height: 1.8;">
                    <p><strong>Report ID:</strong> #${report.id}</p>
                    <p><strong>Date:</strong> ${Utils.formatDate(report.date, 'long')}</p>
                    <p><strong>Driver:</strong> ${Utils.escapeHTML(report.driverName)}</p>
                    <p><strong>Vehicle:</strong> ${Utils.escapeHTML(report.vehicleNumber)}</p>
                    <p><strong>Type:</strong> ${Utils.escapeHTML(report.type)}</p>
                    <p><strong>Odometer:</strong> ${report.odometer} km</p>
                    <p><strong>Fuel:</strong> ${report.fuel || 0} liters</p>
                    <p><strong>Expenses:</strong> ${Utils.formatCurrency(report.expenses || 0)}</p>
                    <p><strong>Route:</strong> ${Utils.escapeHTML(report.route || 'N/A')}</p>
                    <p><strong>Status:</strong> <span class="badge badge-${Utils.escapeHTML(report.status)}">${Utils.escapeHTML(report.status.toUpperCase())}</span></p>
                    <hr style="margin: 15px 0;">
                    <p><strong>Notes:</strong></p>
                    <p style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 10px;">${Utils.escapeHTML(report.notes)}</p>
                    <p style="margin-top: 15px; font-size: 12px; color: #999;">Submitted: ${Utils.formatDate(report.submittedAt, 'long')}</p>
                    ${report.reviewedAt ? `<p style="font-size: 12px; color: #999;">Reviewed: ${Utils.formatDate(report.reviewedAt, 'long')}</p>` : ''}
                </div>
            `;
            
            openModal('reportModal');
        }

        function approveReport(reportId) {
            if (!Utils.isAdmin() && !Utils.canManageFinancial()) {
                Utils.showToast('You do not have permission to approve reports', true);
                return;
            }
            const report = AppState.reports.find(r => String(r.id) === String(reportId));
            if (report && report.status === 'pending') {
                AppState.reports = AppState.reports.map(r =>
                    String(r.id) === String(reportId)
                        ? { ...r, status: 'approved', reviewedAt: new Date().toISOString(), reviewedBy: AppState.currentUser.name }
                        : r
                );
                if (Utils.isAdmin()) { loadAdminDashboard(); loadAdminReports(); }
                else loadFinancialDashboard();
                Utils.showToast('✅ Report approved successfully!');
            }
        }

        function rejectReport(reportId) {
            if (!Utils.isAdmin() && !Utils.canManageFinancial()) {
                Utils.showToast('You do not have permission to reject reports', true);
                return;
            }
            if (confirm('Are you sure you want to reject this report?')) {
                const report = AppState.reports.find(r => String(r.id) === String(reportId));
                if (report && report.status === 'pending') {
                    AppState.reports = AppState.reports.map(r =>
                        String(r.id) === String(reportId)
                            ? { ...r, status: 'rejected', reviewedAt: new Date().toISOString(), reviewedBy: AppState.currentUser.name }
                            : r
                    );
                    if (Utils.isAdmin()) { loadAdminDashboard(); loadAdminReports(); }
                    else loadFinancialDashboard();
                    Utils.showToast('Report rejected');
                }
            }
        }

        function filterReports(searchTerm) {
            const rows = document.querySelectorAll('#reportsTableBody tr');
            const term = searchTerm.toLowerCase();
            
            rows.forEach(row => {
                const searchText = row.getAttribute('data-search') || '';
                row.style.display = searchText.includes(term) ? '' : 'none';
            });
        }

        function filterMyReports(searchTerm) {
            const rows = document.querySelectorAll('#myReportsTableBody tr');
            const term = searchTerm.toLowerCase();
            
            rows.forEach(row => {
                const searchText = row.getAttribute('data-search') || '';
                row.style.display = searchText.includes(term) ? '' : 'none';
            });
        }

        // ==================== USER MANAGEMENT ====================
        function loadUsersTable() {
            const container = document.getElementById('usersTableContainer');
            const users = AppState.users;
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>${t('id')}</th>
                            <th>${currentLang === 'ar' ? 'اسم المستخدم' : 'Username'}</th>
                            <th>${t('name')}</th>
                            <th>${t('email')}</th>
                            <th>${t('role')}</th>
                            <th>${t('status')}</th>
                            <th>${t('actions')}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(u => {
                            const roleInfo = getRoleInfo(u.role);
                            const roleLabel = currentLang === 'ar' ? roleInfo.labelAr : roleInfo.label;
                            const statusLabel = currentLang === 'ar' 
                                ? (u.status === 'active' ? 'نشط' : 'غير نشط') 
                                : u.status.toUpperCase();
                            return `
                            <tr>
                                <td data-label="${t('id')}">${("#"+u.id)}</td>
                                <td data-label="${currentLang === 'ar' ? 'اسم المستخدم' : 'Username'}">${Utils.escapeHTML(u.username || u.email || '')}</td>
                                <td data-label="${t('name')}">${Utils.escapeHTML(u.name)}</td>
                                <td data-label="${t('email')}">${Utils.escapeHTML(u.email)}</td>
                                <td data-label="${t('role')}"><span class="badge" style="background: ${roleInfo.bg}; color: ${roleInfo.color};">${roleInfo.icon} ${Utils.escapeHTML(roleLabel)}</span></td>
                                <td data-label="${t('status')}"><span class="badge badge-${u.status === 'active' ? 'approved' : 'rejected'}">${statusLabel}</span></td>
                                <td data-label="${t('actions')}" class="action-buttons">
                                    <button class="btn-icon" style="background: #e3f2fd; color: #1976d2;" onclick="editUser('${u.id}')">
                                        ✏️
                                    </button>
                                    ${u.role !== 'admin' && Utils.isAdmin() ? `
                                        <button class="btn-icon" style="background: #f3e5f5; color: #7b1fa2;" onclick="showPermissionsModal('${u.id}')" title="${currentLang === 'ar' ? 'إدارة الصلاحيات' : 'Manage Permissions'}">
                                            🔐
                                        </button>
                                    ` : ''}
                                    ${u.id !== AppState.currentUser.id && Utils.isAdmin() ? `
                                        <button class="btn-icon" style="background: #ffebee; color: #c62828;" onclick="deleteUser('${u.id}')">
                                            🗑️
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function showAddUserModal() {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can add users', true);
                return;
            }
            document.getElementById('userModalTitle').textContent = '➕ Add New User';
            document.getElementById('editUserId').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userFullName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = true;
            document.getElementById('userPassword').placeholder = 'Set initial password';
            document.getElementById('passwordRequired').style.display = 'inline';
            document.getElementById('userRole').value = 'driver';
            document.getElementById('userStatus').value = 'active';
            document.getElementById('userModalFirebaseNotice').style.display = 'flex';
            document.getElementById('editPasswordNote').style.display = 'none';
            document.getElementById('userSaveError').style.display = 'none';
            openModal('userModal');
        }

        function editUser(userId) {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can edit users', true);
                return;
            }
            const user = AppState.users.find(u => String(u.id) === String(userId));
            if (user) {
                document.getElementById('userModalTitle').textContent = '✏️ Edit User';
                document.getElementById('editUserId').value = user.id;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userFullName').value = user.name;
                document.getElementById('userEmail').value = user.email || '';
                document.getElementById('userPassword').value = '';
                document.getElementById('userPassword').required = false;
                document.getElementById('userPassword').placeholder = 'Leave blank to keep current';
                document.getElementById('passwordRequired').style.display = 'none';
                document.getElementById('userRole').value = user.role;
                document.getElementById('userStatus').value = user.status;
                // Hide Firebase creation notice when editing
                document.getElementById('userModalFirebaseNotice').style.display = 'none';
                document.getElementById('editPasswordNote').style.display = 'block';
                document.getElementById('userSaveError').style.display = 'none';
                openModal('userModal');
            }
        }

        function toggleUserPasswordVisibility() {
            const inp = document.getElementById('userPassword');
            inp.type = inp.type === 'password' ? 'text' : 'password';
        }

        async function saveUser(event) {
            event.preventDefault();
            
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can save users', true);
                return;
            }
            
            const userId    = document.getElementById('editUserId').value;
            const username  = document.getElementById('userUsername').value.trim();
            const password  = document.getElementById('userPassword').value;
            const name      = document.getElementById('userFullName').value.trim();
            const email     = document.getElementById('userEmail').value.trim().toLowerCase();
            const role      = document.getElementById('userRole').value;
            const status    = document.getElementById('userStatus').value;
            const errEl     = document.getElementById('userSaveError');
            const saveBtn   = document.getElementById('saveUserBtn');

            const showErr = (msg) => {
                errEl.textContent = msg;
                errEl.style.display = 'block';
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save User';
            };

            errEl.style.display = 'none';
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span style="opacity:.7">⏳ Saving…</span>';

            // Check for duplicate username
            const existingUser = AppState.users.find(u => 
                u.username && u.username.toLowerCase() === username.toLowerCase() && 
                String(u.id) !== String(userId || '')
            );
            if (existingUser) {
                return showErr('❌ Username already exists. Choose a different username.');
            }

            // Check for duplicate email (new user)
            if (!userId) {
                const emailTaken = AppState.users.find(u => u.email && u.email.toLowerCase() === email);
                if (emailTaken) {
                    return showErr('❌ An account with this email already exists.');
                }
            }
            
            if (userId) {
                // ── EDIT EXISTING USER ──────────────────────────────────────────
                const index = AppState.users.findIndex(u => String(u.id) === String(userId));
                if (index !== -1) {
                    const updatedUser = {
                        ...AppState.users[index],
                        username,
                        name,
                        email,
                        role,
                        status
                    };
                    // Only hash/update password if provided
                    if (password) {
                        updatedUser.password = await Utils.hashPassword(password);
                    }
                    AppState.users[index] = updatedUser;
                }
            } else {
                // ── CREATE NEW USER — Firebase Auth + Firestore ─────────────────
                if (!password || password.length < 6) {
                    return showErr('❌ Password must be at least 6 characters.');
                }

                if (!window.firebaseFns || !window.auth) {
                    return showErr('❌ Firebase not connected. Please refresh and try again.');
                }

                try {
                    // Use a secondary app instance to create user without signing out admin
                    const { initializeApp, getApps } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
                    const { getAuth, createUserWithEmailAndPassword: createUser, signOut: fbSignOut } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js');

                    const firebaseConfig = {
                        apiKey: "AIzaSyD_G8W1ORtcjZdnu0yz7F2GBN_dCofueRo",
                        authDomain: "mange-ab6e6.firebaseapp.com",
                        projectId: "mange-ab6e6"
                    };

                    // Use a secondary Firebase app so we don't log out the admin
                    const secondaryAppName = 'adminCreatesUser';
                    let secondaryApp;
                    const existingApps = getApps();
                    const found = existingApps.find(a => a.name === secondaryAppName);
                    if (found) {
                        secondaryApp = found;
                    } else {
                        secondaryApp = initializeApp(firebaseConfig, secondaryAppName);
                    }
                    const secondaryAuth = getAuth(secondaryApp);

                    // Create the Firebase Auth account
                    const cred = await createUser(secondaryAuth, email, password);
                    const firebaseUid = cred.user.uid;
                    // Sign out from secondary instance immediately
                    await fbSignOut(secondaryAuth);

                    // Save to Firestore (AppState) with Firebase UID
                    const hashedPassword = await Utils.hashPassword(password);
                    const newUser = {
                        id: firebaseUid,
                        uid: firebaseUid,
                        firebaseUid,
                        username,
                        password: hashedPassword,
                        name,
                        email,
                        role,
                        status,
                        createdAt: new Date().toISOString(),
                        createdBy: AppState.currentUser?.name || 'Admin'
                    };
                    AppState.users = [...AppState.users, newUser];
                    Utils.showToast(`✅ Account created for ${name}! They can log in with their email & password.`);

                } catch (error) {
                    let msg = '❌ Failed to create Firebase account.';
                    if (error.code === 'auth/email-already-in-use') {
                        msg = '❌ This email is already registered in Firebase. Use a different email.';
                    } else if (error.code === 'auth/invalid-email') {
                        msg = '❌ Invalid email address format.';
                    } else if (error.code === 'auth/weak-password') {
                        msg = '❌ Password is too weak. Use at least 6 characters.';
                    } else if (error.code === 'auth/network-request-failed') {
                        msg = '❌ Network error. Check your connection.';
                    } else if (error.code === 'auth/operation-not-allowed') {
                        msg = '❌ Email/Password auth not enabled in Firebase Console. Enable it in Authentication → Sign-in method.';
                    }
                    return showErr(msg);
                }
            }
            
            AppState.users = [...AppState.users];
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save User';
            closeModal('userModal');
            loadUsersTable();
            if (userId) Utils.showToast('✅ User updated successfully!');
        }

        function deleteUser(userId) {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can delete users', true);
                return;
            }
            if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                AppState.users = AppState.users.filter(u => String(u.id) !== String(userId));
                AppState.reports = AppState.reports.filter(r => String(r.userId) !== String(userId));
                loadUsersTable();
                Utils.showToast('User deleted successfully');
            }
        }

        // ==================== EXPORT FUNCTIONS ====================
        function exportReports(format = 'csv') {
            const reports = AppState.reports;
            
            if (format === 'csv') {
                const headers = ['ID', 'Date', 'Driver', 'Vehicle', 'Type', 'Odometer', 'Fuel', 'Expenses', 'Route', 'Status', 'Submitted'];
                const csv = [
                    headers.join(','),
                    ...reports.map(r => [
                        r.id,
                        r.date,
                        `"${r.driverName}"`,
                        r.vehicleNumber,
                        r.type,
                        r.odometer,
                        r.fuel || 0,
                        r.expenses || 0,
                        `"${r.route || ''}"`,
                        r.status,
                        r.submittedAt
                    ].join(','))
                ].join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reports_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
                Utils.showToast('Reports exported successfully!');
            }
        }

        // ==================== MODAL FUNCTIONS ====================
        function openModal(modalId) {
            // Settings modal is admin-only
            if (modalId === 'settingsModal' && !Utils.isAdmin()) {
                Utils.showToast('Access denied: Admin only', true);
                return;
            }
            document.getElementById(modalId).classList.add('show');
            // Focus first input for accessibility
            const modal = document.getElementById(modalId);
            const firstInput = modal.querySelector('input, select, textarea, button');
            if (firstInput) setTimeout(() => firstInput.focus(), 100);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // ==================== LOGOUT ====================
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    // Detach Firestore listeners
                    if (AppState._unsubscribers) {
                        AppState._unsubscribers.forEach(unsub => { try { unsub(); } catch(e){} });
                        AppState._unsubscribers = [];
                    }
                    
                    if (window.firebaseFns && window.auth) {
                        await window.firebaseFns.signOut(window.auth);
                    }
                    
                    AppState.currentUser = null;
                    const adminControls = document.getElementById('adminOnlyControls');
                    if (adminControls) adminControls.style.display = 'none';
                    document.getElementById('loginPage').style.display = 'block';
                    document.getElementById('appContainer').classList.remove('show');
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                    
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    Utils.showToast('Logged out successfully');
                } catch (error) {
                    console.error('Logout error:', error);
                    Utils.showToast('Logout failed: ' + error.message, true);
                }
            }
        }

        // ==================== LANGUAGE / RTL SUPPORT ====================
        const i18n = {
            en: {
                // App
                appName: '🚗 Rihlati',
                appSubtitle: 'Fleet Management',
                fleetTitle: 'Rihlati',
                fleetSubtitle: 'Fleet Management',
                langToggle: 'عربي',
                // Auth
                signIn: 'Sign In',
                createAccount: 'Create Account',
                tabSignIn: 'Sign In',
                tabCreateAccount: 'Create Account',
                username: 'Username',
                password: 'Password',
                email: 'Email',
                fullName: 'Full Name',
                enterUsername: 'Enter username',
                enterPassword: 'Enter password',
                enterEmail: 'Enter your email',
                forgotPassword: '🔑 Forgot password?',
                signingIn: 'Signing in…',
                creatingAccount: 'Creating account…',
                newAccountNote: 'New accounts are assigned the Driver role by default. An admin can change your role after registration.',
                // Navigation
                dashboard: 'Dashboard',
                reports: 'Reports',
                users: 'Users',
                analytics: 'Analytics',
                submitReport: 'Submit Report',
                myReports: 'My Reports',
                myRequests: 'My Requests',
                raiseRequest: 'Raise Request',
                requests: 'Requests',
                financial: 'Financial',
                sales: 'Sales & Marketing',
                permissions: 'Permissions',
                vehicles: 'Vehicles',
                vehicleManagement: 'Vehicle Management',
                search: 'Search...',
                allStatus: 'All Status',
                logout: 'Logout',
                settings: 'Settings',
                // Roles
                administrator: 'Administrator',
                driver: 'Driver',
                manager: 'Manager',
                supervisor: 'Supervisor',
                hr: 'HR',
                accountant: 'Accountant',
                // Dashboard
                welcomeBack: (name) => `Welcome back, ${name}!`,
                recentReports: 'Recent Reports',
                totalReports: 'Total Reports',
                pendingReports: 'Pending',
                approvedReports: 'Approved',
                totalDrivers: 'Total Drivers',
                totalVehicles: 'Total Vehicles',
                totalExpenses: 'Total Expenses',
                totalFuel: 'Total Fuel',
                // Reports
                allReports: '📋 All Reports',
                noReports: 'No reports yet',
                noReportsMsg: 'Reports will appear here once drivers submit them',
                submitReportBtn: '✓ Submit Report',
                resetForm: '↺ Reset',
                reportSubmitted: '✅ Report submitted successfully!',
                fillRequired: 'Please fill in all required fields',
                // Users
                userManagement: '👥 User Management',
                addUser: '➕ Add User',
                editUser: 'Edit User',
                deleteUser: 'Delete User',
                saveUser: 'Save User',
                cancel: 'Cancel',
                name: 'Name',
                role: 'Role',
                status: 'Status',
                active: 'Active',
                inactive: 'Inactive',
                actions: 'Actions',
                // Table headers
                id: 'ID',
                date: 'Date',
                type: 'Type',
                vehicle: 'Vehicle',
                fuel: 'Fuel (L)',
                expenses: 'Expenses',
                statusCol: 'Status',
                submittedAt: 'Submitted',
                details: 'Details',
                priority: 'Priority',
                // Status badges
                pending: 'PENDING',
                approved: 'APPROVED',
                rejected: 'REJECTED',
                // Export/Search
                exportCSV: '📥 Export CSV',
                searchReports: 'Search reports...',
                searchMyReports: 'Search my reports...',
                searchUsers: 'Search users...',
                // Tickets
                maintenanceReq: '🔧 Maintenance',
                fuelReq: '⛽ Fuel',
                leaveReq: '🏖️ Leave',
                noRequests: 'No requests yet',
                noRequestsMsg: 'Click "Raise Request" to submit your first request',
                requestSubmitted: '✅ Request submitted! Awaiting Admin approval.',
                // Sync
                syncConnected: 'Firebase Synced',
                syncConnecting: 'Connecting…',
                // Misc
                viewDetails: 'View',
                approve: 'Approve',
                reject: 'Reject',
                save: 'Save',
                close: 'Close',
                confirm: 'Confirm',
                sessionExpired: 'Session expired. Please login again.',
                poweredBy: 'Powered by Firebase — real-time cloud sync',
                copyright: '© 2026 Rihlati',
            },
            ar: {
                // App
                appName: '🚗 رحلتي',
                appSubtitle: 'إدارة الأسطول',
                fleetTitle: 'رحلتي',
                fleetSubtitle: 'إدارة الأسطول',
                langToggle: 'EN',
                // Auth
                signIn: 'تسجيل الدخول',
                createAccount: 'إنشاء حساب',
                tabSignIn: 'تسجيل الدخول',
                tabCreateAccount: 'إنشاء حساب',
                username: 'اسم المستخدم',
                password: 'كلمة المرور',
                email: 'البريد الإلكتروني',
                fullName: 'الاسم الكامل',
                enterUsername: 'أدخل اسم المستخدم',
                enterPassword: 'أدخل كلمة المرور',
                enterEmail: 'أدخل بريدك الإلكتروني',
                forgotPassword: '🔑 نسيت كلمة المرور؟',
                signingIn: 'جارٍ تسجيل الدخول…',
                creatingAccount: 'جارٍ إنشاء الحساب…',
                newAccountNote: 'تُمنح الحسابات الجديدة دور "سائق" بشكل افتراضي. يمكن للمسؤول تغيير دورك بعد التسجيل.',
                // Navigation
                dashboard: 'لوحة التحكم',
                reports: 'التقارير',
                users: 'المستخدمون',
                analytics: 'التحليلات',
                submitReport: 'إرسال تقرير',
                myReports: 'تقاريري',
                myRequests: 'طلباتي',
                raiseRequest: 'رفع طلب',
                requests: 'الطلبات',
                financial: 'المالية',
                sales: 'المبيعات والتسويق',
                permissions: 'الصلاحيات',
                vehicles: 'المركبات',
                vehicleManagement: 'إدارة المركبات',
                addVehicle: 'إضافة مركبة',
                search: 'بحث...',
                allStatus: 'جميع الحالات',
                logout: 'تسجيل الخروج',
                settings: 'الإعدادات',
                // Roles
                administrator: 'مدير النظام',
                driver: 'سائق',
                manager: 'مدير',
                supervisor: 'مشرف',
                hr: 'الموارد البشرية',
                accountant: 'محاسب',
                // Dashboard
                welcomeBack: (name) => `مرحباً بعودتك، ${name}!`,
                recentReports: 'أحدث التقارير',
                totalReports: 'إجمالي التقارير',
                pendingReports: 'قيد الانتظار',
                approvedReports: 'موافق عليها',
                totalDrivers: 'إجمالي السائقين',
                totalVehicles: 'إجمالي المركبات',
                totalExpenses: 'إجمالي المصروفات',
                totalFuel: 'إجمالي الوقود',
                // Reports
                allReports: '📋 جميع التقارير',
                noReports: 'لا توجد تقارير بعد',
                noReportsMsg: 'ستظهر التقارير هنا بمجرد إرسال السائقين لها',
                submitReportBtn: '✓ إرسال التقرير',
                resetForm: '↺ إعادة تعيين',
                reportSubmitted: '✅ تم إرسال التقرير بنجاح!',
                fillRequired: 'يرجى ملء جميع الحقول المطلوبة',
                // Users
                userManagement: '👥 إدارة المستخدمين',
                addUser: '➕ إضافة مستخدم',
                editUser: 'تعديل المستخدم',
                deleteUser: 'حذف المستخدم',
                saveUser: 'حفظ المستخدم',
                cancel: 'إلغاء',
                name: 'الاسم',
                role: 'الدور',
                status: 'الحالة',
                active: 'نشط',
                inactive: 'غير نشط',
                actions: 'الإجراءات',
                // Table headers
                id: 'الرقم',
                date: 'التاريخ',
                type: 'النوع',
                vehicle: 'المركبة',
                fuel: 'الوقود (لتر)',
                expenses: 'المصروفات',
                statusCol: 'الحالة',
                submittedAt: 'تاريخ الإرسال',
                details: 'التفاصيل',
                priority: 'الأولوية',
                // Status badges
                pending: 'قيد الانتظار',
                approved: 'موافق عليه',
                rejected: 'مرفوض',
                // Export/Search
                exportCSV: '📥 تصدير CSV',
                searchReports: 'بحث في التقارير...',
                searchMyReports: 'بحث في تقاريري...',
                searchUsers: 'بحث في المستخدمين...',
                // Tickets
                maintenanceReq: '🔧 صيانة',
                fuelReq: '⛽ وقود',
                leaveReq: '🏖️ إجازة',
                noRequests: 'لا توجد طلبات بعد',
                noRequestsMsg: 'انقر على "رفع طلب" لإرسال طلبك الأول',
                requestSubmitted: '✅ تم إرسال الطلب! في انتظار موافقة الإدارة.',
                // Sync
                syncConnected: 'متزامن مع Firebase',
                syncConnecting: 'جارٍ الاتصال…',
                // Misc
                viewDetails: 'عرض',
                approve: 'موافقة',
                reject: 'رفض',
                save: 'حفظ',
                close: 'إغلاق',
                confirm: 'تأكيد',
                sessionExpired: 'انتهت الجلسة. يرجى تسجيل الدخول مجدداً.',
                poweredBy: 'مدعوم بـ Firebase — مزامنة فورية',
                copyright: '© 2026 رحلتي',
                // Vehicles
                vehicleManagement: '🚗 إدارة المركبات',
                addVehicle: '➕ إضافة مركبة',
                editVehicle: 'تعديل المركبة',
                deleteVehicle: 'حذف المركبة',
                saveVehicle: 'حفظ المركبة',
                totalVehiclesFleet: 'إجمالي الأسطول',
                fleetCost: 'تكلفة الأسطول',
                inMaintenance: 'تحت الصيانة',
                // Common
                search: 'بحث...',
                allStatus: 'جميع الحالات',
                noData: 'لا توجد بيانات',
                loading: 'جارٍ التحميل…',
                yes: 'نعم',
                no: 'لا',
                add: 'إضافة',
                edit: 'تعديل',
                delete: 'حذف',
                reset: 'إعادة تعيين',
                filter: 'تصفية',
                export: 'تصدير',
                all: 'الكل',
                // Permissions
                managePermissions: 'إدارة الصلاحيات',
                // Tickets/Requests
                requestManagement: 'إدارة الطلبات',
                submitTicket: 'رفع طلب',
                ticketHistory: 'سجل الطلبات',
                // Financial
                financialDashboard: 'لوحة المالية',
                monthlyOverview: 'نظرة شهرية',
                // Analytics
                analyticsDashboard: 'لوحة التحليلات',
            }
        };

        let currentLang = localStorage.getItem('rihlatiLang') || 'en';

        function t(key, ...args) {
            const val = i18n[currentLang][key];
            return typeof val === 'function' ? val(...args) : (val || i18n['en'][key] || key);
        }

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            localStorage.setItem('rihlatiLang', currentLang);
            applyLanguage();
        }

        function applyLanguage() { try {
            const isRTL = currentLang === 'ar';
            const html  = document.documentElement;

            // ── Direction & lang attribute ────────────────────────────────
            html.lang = currentLang;
            html.dir  = isRTL ? 'rtl' : 'ltr';
            document.body.dir = isRTL ? 'rtl' : 'ltr';

            // ── Font class ────────────────────────────────────────────────
            document.body.classList.toggle('lang-ar', isRTL);

            // ── Page title ───────────────────────────────────────────────
            document.title = isRTL ? 'رحلتي' : 'Rihlati';

            // ── Lang toggle buttons ──────────────────────────────────────
            document.querySelectorAll('#langToggle, .lang-toggle-btn').forEach(btn => {
                btn.textContent = isRTL ? '🌐 EN' : '🌐 عربي';
            });

            // ── Login page brand panel ───────────────────────────────────
            const brandName = document.querySelector('.login-brand-name');
            if (brandName) brandName.textContent = t('fleetTitle');
            const brandTag  = document.querySelector('.login-brand-tagline');
            if (brandTag)  brandTag.textContent  = t('fleetSubtitle');

            const tabLoginBtn = document.getElementById('tabLoginBtn');
            if (tabLoginBtn) { tabLoginBtn.textContent = t('tabSignIn'); tabLoginBtn.classList.toggle('active', document.getElementById('loginTab').style.display !== 'none'); }
            const tabSignupBtn = document.getElementById('tabSignupBtn');
            if (tabSignupBtn) { tabSignupBtn.textContent = t('tabCreateAccount'); tabSignupBtn.classList.toggle('active', document.getElementById('signupTab').style.display !== 'none'); }

            // ── Login welcome text ──────────────────────────────────────────
            const welcomeH2 = document.querySelector('#loginTab .login-welcome h2');
            const welcomeP  = document.querySelector('#loginTab .login-welcome p');
            if (welcomeH2) welcomeH2.textContent = isRTL ? 'مرحباً بعودتك' : 'Welcome back';
            if (welcomeP)  welcomeP.textContent  = isRTL ? 'سجّل دخولك للمتابعة' : 'Sign in to your account to continue';
            const signupH2 = document.querySelector('#signupTab .login-welcome h2');
            const signupP  = document.querySelector('#signupTab .login-welcome p');
            if (signupH2) signupH2.textContent = isRTL ? 'إنشاء حساب' : 'Create account';
            if (signupP)  signupP.textContent  = isRTL ? 'انضم إلى رحلتي لإدارة الأسطول' : 'Join Rihlati Fleet Management';

            // ── Input placeholders ────────────────────────────────────────────
            const emailIn = document.getElementById('loginEmail');
            if (emailIn) emailIn.placeholder = isRTL ? 'البريد الإلكتروني' : 'Email address';
            const passIn  = document.getElementById('loginPassword');
            if (passIn)   passIn.placeholder  = isRTL ? 'كلمة المرور' : 'Password';

            // Form labels (login) - set data-i18n labels safely
            const loginEmailLabel = document.querySelector('#loginTab .form-group:first-child label');
            if (loginEmailLabel) loginEmailLabel.firstChild.textContent = t('email');
            const loginPassLabel  = document.querySelector('#loginTab .form-group:nth-child(2) label');
            if (loginPassLabel)  loginPassLabel.firstChild.textContent  = t('password');
            const emailInput = document.getElementById('loginEmail');
            if (emailInput) emailInput.placeholder = t('enterEmail');
            const passInput = document.getElementById('loginPassword');
            if (passInput) passInput.placeholder = t('enterPassword');
            const forgotBtn = document.getElementById('forgotPassBtn');
            if (forgotBtn) forgotBtn.textContent = t('forgotPassword');
            const loginBtn = document.getElementById('loginBtn');
            if (loginBtn && !loginBtn.disabled) loginBtn.innerHTML = `<span>${t('signIn')}</span>`;

            // Form labels (signup) - safe update
            const nameLabel  = document.querySelector('#signupTab .form-group:nth-child(1) label');
            const sEmailLabel= document.querySelector('#signupTab .form-group:nth-child(2) label');
            const sPassLabel = document.querySelector('#signupTab .form-group:nth-child(3) label');
            if (nameLabel  && nameLabel.firstChild)  nameLabel.firstChild.textContent  = t('fullName');
            if (sEmailLabel && sEmailLabel.firstChild) sEmailLabel.firstChild.textContent = t('email');
            if (sPassLabel && sPassLabel.firstChild) sPassLabel.firstChild.textContent  = t('password');
            const nameInput = document.getElementById('signupName');
            if (nameInput) nameInput.placeholder = isRTL ? 'اسمك الكامل' : 'Your full name';
            const emailInp = document.getElementById('signupEmail');
            if (emailInp) emailInp.placeholder = isRTL ? 'بريدك@الإلكتروني.com' : 'your@email.com';
            const passInp = document.getElementById('signupPassword');
            if (passInp) passInp.placeholder = isRTL ? 'كلمة المرور (٦ أحرف على الأقل)' : 'Password (min 6 chars)';
            const signupBtn = document.getElementById('signupBtn');
            if (signupBtn && !signupBtn.disabled) signupBtn.innerHTML = `<span>${t('createAccount')}</span>`;
            const signupNote = document.getElementById('signupNoteText');
            if (signupNote) signupNote.textContent = t('newAccountNote');

            const fbBadge = document.querySelector('.fb-powered-text');
            if (fbBadge) fbBadge.textContent = t('poweredBy');
            const copyrightEl = document.querySelector('.login-footer p');
            if (copyrightEl) copyrightEl.textContent = t('copyright');

            // ── Sidebar ──────────────────────────────────────────────────
            const sidebarAppName = document.querySelector('.sidebar-header h2');
            if (sidebarAppName) sidebarAppName.textContent = t('appName');
            const sidebarSubtitle = document.querySelector('.sidebar-header p');
            if (sidebarSubtitle) sidebarSubtitle.textContent = t('appSubtitle');
            const userRoleEl = document.getElementById('sidebarUserRole');
            if (userRoleEl && AppState.currentUser) {
                const rInfo = getRoleInfo(AppState.currentUser.role);
                userRoleEl.textContent = isRTL ? rInfo.labelAr : rInfo.label;
            }
            const logoutLabel = document.getElementById('logoutLabel');
            if (logoutLabel) logoutLabel.textContent = t('logout');

            // ── Sync status ──────────────────────────────────────────────
            const syncText = document.getElementById('syncStatusText');
            if (syncText) {
                const statusClass = document.getElementById('syncStatus')?.className || '';
                syncText.textContent = statusClass.includes('connected') ? t('syncConnected') : t('syncConnecting');
            }

            // ── data-i18n elements ────────────────────────────────────────
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const val = t(key);
                if (val && typeof val === 'string') el.textContent = val;
            });

            // ── data-i18n-placeholder elements ───────────────────────────
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                const val = t(key);
                if (val) el.placeholder = val;
            });

            // ── Re-render nav + all dynamic sections ────────────────────
            if (AppState.currentUser) {
                try { loadInterface(); } catch(e) { console.warn('loadInterface error', e); }
                try { refreshAllSections(); } catch(e) { console.warn('refreshAllSections error', e); }
            }
        } catch(e) { console.error('applyLanguage error:', e); }
        }

        // Apply language on load
        (function() {
            currentLang = localStorage.getItem('rihlatiLang') || 'en';
            document.body.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = currentLang;
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.body.classList.toggle('lang-ar', currentLang === 'ar');
        })();

        // ==================== TICKET SYSTEM ====================
        let currentTicketType = null;

        function selectTicketType(type) {
            currentTicketType = type;
            document.querySelectorAll('.ticket-type-card').forEach(c => c.classList.remove('selected'));
            document.getElementById(`ttype-${type}`).classList.add('selected');
            document.getElementById('ticketStep1Btn').disabled = false;
        }

        function ticketNextStep(step) {
            // Validate step 2 before moving to 3
            if (step === 3 && !validateTicketForm()) return;

            [1,2,3].forEach(n => {
                document.getElementById(`ticketStep${n}`).classList.remove('active');
                const dot = document.getElementById(`sdot${n}`);
                dot.classList.remove('active', 'done');
                if (n < step) { dot.classList.add('done'); }
                if (n === step) { dot.classList.add('active'); }
                if (n < 3) {
                    const line = document.getElementById(`sline${n}`);
                    line.classList.toggle('done', n < step);
                }
            });
            document.getElementById(`ticketStep${step}`).classList.add('active');

            if (step === 2) {
                // Show relevant fields
                ['maintenance','fuel','leave'].forEach(t => {
                    document.getElementById(`ticketFields-${t}`).style.display = t === currentTicketType ? 'block' : 'none';
                });
                document.getElementById('ticketFormTitle').textContent =
                    `Step 2: ${currentTicketType === 'maintenance' ? '🔧 Maintenance' : currentTicketType === 'fuel' ? '⛽ Fuel' : '🏖️ Leave'} Request Details`;
            }

            if (step === 3) {
                buildTicketPreview();
            }
        }

        function validateTicketForm() {
            const t = currentTicketType;
            if (t === 'maintenance') {
                if (!document.getElementById('t-maint-driver').value.trim()) { Utils.showToast('Driver name is required', true); return false; }
                if (!document.getElementById('t-maint-type').value) { Utils.showToast('Maintenance type is required', true); return false; }
                if (!document.getElementById('t-maint-cost').value) { Utils.showToast('Estimated cost is required', true); return false; }
                if (!document.getElementById('t-maint-notes').value.trim()) { Utils.showToast('Description is required', true); return false; }
            } else if (t === 'fuel') {
                if (!document.getElementById('t-fuel-driver').value.trim()) { Utils.showToast('Driver name is required', true); return false; }
                if (!document.getElementById('t-fuel-liters').value) { Utils.showToast('Fuel amount is required', true); return false; }
                if (!document.getElementById('t-fuel-cost').value) { Utils.showToast('Estimated cost is required', true); return false; }
                if (!document.getElementById('t-fuel-date').value) { Utils.showToast('Required date is required', true); return false; }
                if (!document.getElementById('t-fuel-notes').value.trim()) { Utils.showToast('Reason is required', true); return false; }
            } else if (t === 'leave') {
                if (!document.getElementById('t-leave-driver').value.trim()) { Utils.showToast('Driver name is required', true); return false; }
                if (!document.getElementById('t-leave-type').value) { Utils.showToast('Leave type is required', true); return false; }
                if (!document.getElementById('t-leave-from').value) { Utils.showToast('From date is required', true); return false; }
                if (!document.getElementById('t-leave-to').value) { Utils.showToast('To date is required', true); return false; }
                if (!document.getElementById('t-leave-notes').value.trim()) { Utils.showToast('Reason is required', true); return false; }
            }
            return true;
        }

        function buildTicketPreview() {
            const t = currentTicketType;
            let rows = '';
            if (t === 'maintenance') {
                rows = [
                    ['Type', '🔧 Maintenance Request'],
                    ['Driver', document.getElementById('t-maint-driver').value],
                    ['Vehicle', document.getElementById('t-maint-vehicle').value || 'N/A'],
                    ['Maintenance Type', document.getElementById('t-maint-type').value.replace('_',' ')],
                    ['Estimated Cost', `SAR ${document.getElementById('t-maint-cost').value || '0'}`],
                    ['Priority', document.getElementById('t-maint-priority').value.toUpperCase()],
                    ['Requested Date', document.getElementById('t-maint-date').value || 'ASAP'],
                    ['Description', document.getElementById('t-maint-notes').value],
                ].map(([l,v]) => `<div class="ticket-detail-row"><span class="ticket-detail-label">${l}</span><span class="ticket-detail-value">${Utils.escapeHTML(String(v))}</span></div>`).join('');
            } else if (t === 'fuel') {
                rows = [
                    ['Type', '⛽ Fuel Request'],
                    ['Driver', document.getElementById('t-fuel-driver').value],
                    ['Vehicle', document.getElementById('t-fuel-vehicle').value || 'N/A'],
                    ['Fuel Amount', `${document.getElementById('t-fuel-liters').value} Liters`],
                    ['Est. Cost', `SAR ${document.getElementById('t-fuel-cost').value || '0'}`],
                    ['Station', document.getElementById('t-fuel-station').value || 'N/A'],
                    ['Required Date', document.getElementById('t-fuel-date').value],
                    ['Reason', document.getElementById('t-fuel-notes').value],
                ].map(([l,v]) => `<div class="ticket-detail-row"><span class="ticket-detail-label">${l}</span><span class="ticket-detail-value">${Utils.escapeHTML(String(v))}</span></div>`).join('');
            } else {
                const from = document.getElementById('t-leave-from').value;
                const to   = document.getElementById('t-leave-to').value;
                rows = [
                    ['Type', '🏖️ Leave Request'],
                    ['Driver', document.getElementById('t-leave-driver').value],
                    ['Leave Type', document.getElementById('t-leave-type').value],
                    ['From', from],
                    ['To', to],
                    ['Days', document.getElementById('t-leave-days').value || calcLeaveDays(from, to)],
                    ['Replacement', document.getElementById('t-leave-replacement').value || 'None'],
                    ['Reason', document.getElementById('t-leave-notes').value],
                ].map(([l,v]) => `<div class="ticket-detail-row"><span class="ticket-detail-label">${l}</span><span class="ticket-detail-value">${Utils.escapeHTML(String(v))}</span></div>`).join('');
            }
            document.getElementById('ticketPreview').innerHTML = rows;
        }

        function calcLeaveDays(from, to) {
            if (!from || !to) return '';
            const diff = (new Date(to) - new Date(from)) / (1000*60*60*24);
            return diff >= 0 ? diff + 1 : '';
        }

        function submitTicket() {
            const t = currentTicketType;
            const user = AppState.currentUser;
            let data = { type: t };

            if (t === 'maintenance') {
                data = { ...data,
                    driverName:   document.getElementById('t-maint-driver').value.trim(),
                    vehicle:      document.getElementById('t-maint-vehicle').value.trim(),
                    maintType:    document.getElementById('t-maint-type').value,
                    cost:         parseFloat(document.getElementById('t-maint-cost').value) || 0,
                    priority:     document.getElementById('t-maint-priority').value,
                    requestedDate: document.getElementById('t-maint-date').value,
                    notes:        document.getElementById('t-maint-notes').value.trim(),
                };
            } else if (t === 'fuel') {
                data = { ...data,
                    driverName:   document.getElementById('t-fuel-driver').value.trim(),
                    vehicle:      document.getElementById('t-fuel-vehicle').value.trim(),
                    liters:       parseFloat(document.getElementById('t-fuel-liters').value),
                    cost:         parseFloat(document.getElementById('t-fuel-cost').value) || 0,
                    station:      document.getElementById('t-fuel-station').value.trim(),
                    requestedDate: document.getElementById('t-fuel-date').value,
                    notes:        document.getElementById('t-fuel-notes').value.trim(),
                };
            } else {
                const from = document.getElementById('t-leave-from').value;
                const to   = document.getElementById('t-leave-to').value;
                data = { ...data,
                    driverName:   document.getElementById('t-leave-driver').value.trim(),
                    leaveType:    document.getElementById('t-leave-type').value,
                    from, to,
                    days:         calcLeaveDays(from, to),
                    replacement:  document.getElementById('t-leave-replacement').value.trim(),
                    notes:        document.getElementById('t-leave-notes').value.trim(),
                };
            }

            const ticket = {
                id:          Utils.generateId(AppState.tickets),
                submittedBy: user.id,
                submitterName: user.name,
                submitterRole: user.role,
                status:      'pending',
                submittedAt: new Date().toISOString(),
                reviewedAt:  null,
                reviewedBy:  null,
                reviewNote:  '',
                ...data
            };

            AppState.tickets = [...AppState.tickets, ticket];
            Utils.showToast(t('requestSubmitted'));
            resetTicketForm();

            // Update pending badge for admin
            updatePendingTicketsBadge();

            // Navigate to my tickets
            setTimeout(() => {
                const myTicketsNav = document.querySelector('.nav-item[onclick*="myTickets"]');
                if (myTicketsNav) myTicketsNav.click();
            }, 1200);
        }

        function resetTicketForm() {
            currentTicketType = null;
            document.querySelectorAll('.ticket-type-card').forEach(c => c.classList.remove('selected'));
            document.getElementById('ticketStep1Btn').disabled = true;
            // Clear all fields
            ['t-maint-driver','t-maint-vehicle','t-maint-cost','t-maint-date','t-maint-notes',
             't-fuel-driver','t-fuel-vehicle','t-fuel-liters','t-fuel-cost','t-fuel-station','t-fuel-date','t-fuel-notes',
             't-leave-driver','t-leave-from','t-leave-to','t-leave-days','t-leave-replacement','t-leave-notes']
            .forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; });
            ['t-maint-type','t-maint-priority','t-leave-type'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.selectedIndex = 0;
            });
            ticketNextStep(1);
        }

        // Auto-calculate days for leave
        document.addEventListener('change', function(e) {
            if (e.target.id === 't-leave-from' || e.target.id === 't-leave-to') {
                const from = document.getElementById('t-leave-from').value;
                const to   = document.getElementById('t-leave-to').value;
                const days = calcLeaveDays(from, to);
                document.getElementById('t-leave-days').value = days;
            }
        });

        function loadMyTickets() {
            const container = document.getElementById('myTicketsTableContainer');
            const myTickets = AppState.tickets
                .filter(tk => tk.submittedBy === AppState.currentUser.id)
                .slice().reverse();

            if (myTickets.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <div class="empty-state-icon">📬</div>
                    <h3>${t('noRequests')}</h3>
                    <p>${t('noRequestsMsg')}</p></div>`;
                return;
            }

            container.innerHTML = `<table>
                <thead><tr>
                    <th>${t('id')}</th><th>${t('type')}</th><th>${currentLang === 'ar' ? 'السائق' : 'Driver'}</th><th>${t('details')}</th>
                    <th>${t('priority')}</th><th>${t('submittedAt')}</th><th>${t('statusCol')}</th><th>${t('actions')}</th>
                </tr></thead>
                <tbody>
                ${myTickets.map(tk => `
                    <tr class="ticket-row-${tk.type}">
                        <td data-label="${t('id')}">${("#"+tk.id)}</td>
                        <td data-label="Type">${ticketTypeBadge(tk.type)}</td>
                        <td data-label="Driver">${Utils.escapeHTML(tk.driverName)}</td>
                        <td data-label="Details">${ticketSummary(tk)}</td>
                        <td data-label="Priority">${tk.priority ? `<span class="priority-badge priority-${tk.priority}">${tk.priority}</span>` : '—'}</td>
                        <td data-label="Submitted">${Utils.formatDate(tk.submittedAt)}</td>
                        <td data-label="Status"><span class="badge badge-${tk.status}">${currentLang === 'ar' ? ({pending:'انتظار',approved:'موافق',rejected:'مرفوض'}[tk.status] || tk.status) : tk.status.toUpperCase()}</span></td>
                        <td data-label="Actions">
                            <button class="btn-icon" style="background:#e3f2fd;color:#1976d2;" onclick="viewTicket(${tk.id})">👁️</button>
                        </td>
                    </tr>`).join('')}
                </tbody></table>`;
        }

        function loadAdminTickets() {
            if (!Utils.canManageTickets()) {
                document.getElementById('adminTicketsTableContainer').innerHTML = 
                    `<div class="empty-state"><div class="empty-state-icon">🔒</div><h3>Access Denied</h3><p>You don't have permission to manage requests</p></div>`;
                return;
            }
            
            const container = document.getElementById('adminTicketsTableContainer');
            const typeFilter   = document.getElementById('ticketTypeFilter')?.value   || '';
            const statusFilter = document.getElementById('ticketStatusFilter')?.value || '';

            let tickets = AppState.tickets.slice().reverse();
            if (typeFilter)   tickets = tickets.filter(tk => tk.type   === typeFilter);
            if (statusFilter) tickets = tickets.filter(tk => tk.status === statusFilter);

            if (tickets.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <div class="empty-state-icon">📥</div>
                    <h3>No requests found</h3>
                    <p>Requests from users will appear here</p></div>`;
                return;
            }

            container.innerHTML = `<table>
                <thead><tr>
                    <th>ID</th><th>Type</th><th>From</th><th>Driver</th><th>Details</th>
                    <th>Priority</th><th>Submitted</th><th>Status</th><th>Actions</th>
                </tr></thead>
                <tbody>
                ${tickets.map(tk => `
                    <tr class="ticket-row-${tk.type}">
                        <td data-label="${t('id')}">${("#"+tk.id)}</td>
                        <td data-label="Type">${ticketTypeBadge(tk.type)}</td>
                        <td data-label="From">${Utils.escapeHTML(tk.submitterName)}<br><small style="color:#888">${getRoleInfo(tk.submitterRole).label}</small></td>
                        <td data-label="Driver">${Utils.escapeHTML(tk.driverName)}</td>
                        <td data-label="Details">${ticketSummary(tk)}</td>
                        <td data-label="Priority">${tk.priority ? `<span class="priority-badge priority-${tk.priority}">${tk.priority}</span>` : '—'}</td>
                        <td data-label="Submitted">${Utils.formatDate(tk.submittedAt)}</td>
                        <td data-label="Status"><span class="badge badge-${tk.status}">${currentLang === 'ar' ? ({pending:'انتظار',approved:'موافق',rejected:'مرفوض'}[tk.status] || tk.status) : tk.status.toUpperCase()}</span></td>
                        <td data-label="Actions" class="action-buttons">
                            <button class="btn-icon" style="background:#e3f2fd;color:#1976d2;" onclick="viewTicket(${tk.id})">👁️</button>
                            ${tk.status === 'pending' && Utils.canManageTickets() ? `
                            <button class="btn-icon" style="background:#e8f5e9;color:#388e3c;" onclick="approveTicket(${tk.id}, true)" title="Approve">✓</button>
                            <button class="btn-icon" style="background:#ffebee;color:#c62828;" onclick="rejectTicket(${tk.id}, true)"  title="Reject">✗</button>` : ''}
                        </td>
                    </tr>`).join('')}
                </tbody></table>`;
        }

        function ticketTypeBadge(type) {
            const map = { maintenance:'🔧 Maintenance', fuel:'⛽ Fuel', leave:'🏖️ Leave' };
            return `<span class="badge badge-${type}">${map[type] || type}</span>`;
        }

        function ticketSummary(tk) {
            if (tk.type === 'maintenance') return Utils.escapeHTML(`${tk.maintType || ''} ${tk.vehicle ? '– '+tk.vehicle : ''}`);
            if (tk.type === 'fuel') return Utils.escapeHTML(`${tk.liters}L ${tk.vehicle ? '– '+tk.vehicle : ''}`);
            if (tk.type === 'leave') return Utils.escapeHTML(`${tk.leaveType} (${tk.from} → ${tk.to}, ${tk.days} days)`);
            return '';
        }

        function viewTicket(ticketId) {
            const tk = AppState.tickets.find(t => t.id === ticketId);
            if (!tk) return;

            let fields = [];
            if (tk.type === 'maintenance') {
                fields = [
                    ['Request Type','🔧 Maintenance Request'],
                    ['Driver Name', tk.driverName],
                    ['Vehicle', tk.vehicle || 'N/A'],
                    ['Maintenance Type', tk.maintType?.replace(/_/g,' ') || 'N/A'],
                    ['Estimated Cost', `<span class="${tk.status === 'pending' ? 'amount-pending' : tk.status === 'approved' ? 'amount-approved' : 'amount-rejected'}">${Utils.formatCurrency(tk.cost || 0)}</span>`],
                    ['Priority', `<span class="priority-badge priority-${tk.priority}">${tk.priority || 'N/A'}</span>`],
                    ['Requested Date', tk.requestedDate || 'ASAP'],
                    ['Description', tk.notes],
                ];
            } else if (tk.type === 'fuel') {
                fields = [
                    ['Request Type','⛽ Fuel Request'],
                    ['Driver Name', tk.driverName],
                    ['Vehicle', tk.vehicle || 'N/A'],
                    ['Fuel Amount', `${tk.liters} Liters`],
                    ['Est. Cost', `<span class="${tk.status === 'pending' ? 'amount-pending' : tk.status === 'approved' ? 'amount-approved' : 'amount-rejected'}">${Utils.formatCurrency(tk.cost || 0)}</span>`],
                    ['Station', tk.station || 'N/A'],
                    ['Required Date', tk.requestedDate],
                    ['Reason', tk.notes],
                ];
            } else {
                fields = [
                    ['Request Type','🏖️ Leave Request'],
                    ['Driver Name', tk.driverName],
                    ['Leave Type', tk.leaveType],
                    ['From Date', tk.from],
                    ['To Date', tk.to],
                    ['No. of Days', tk.days],
                    ['Replacement', tk.replacement || 'None'],
                    ['Reason', tk.notes],
                ];
            }
            fields.push(
                ['Submitted By', `${Utils.escapeHTML(tk.submitterName)} (${getRoleInfo(tk.submitterRole).label})`],
                ['Submitted At', Utils.formatDate(tk.submittedAt, 'long')],
                ['Status', `<span class="badge badge-${tk.status}">${currentLang === 'ar' ? ({pending:'انتظار',approved:'موافق',rejected:'مرفوض'}[tk.status] || tk.status) : tk.status.toUpperCase()}</span>`],
            );
            if (tk.reviewedAt) {
                fields.push(['Reviewed At', Utils.formatDate(tk.reviewedAt, 'long')]);
                if (tk.reviewNote) fields.push(['Review Note', tk.reviewNote]);
            }

            document.getElementById('ticketDetailContent').innerHTML =
                fields.map(([l,v]) => `<div class="ticket-detail-row">
                    <span class="ticket-detail-label">${l}</span>
                    <span class="ticket-detail-value">${typeof v === 'string' && !v.startsWith('<') ? Utils.escapeHTML(v) : v}</span>
                </div>`).join('');

            // Show approve/reject for anyone with canManageTickets and ticket is pending
            const actionsDiv = document.getElementById('ticketApprovalActions');
            if (Utils.canManageTickets() && tk.status === 'pending') {
                actionsDiv.style.display = 'flex';
                actionsDiv.innerHTML = `
                    <div style="width:100%">
                        <div class="form-group" style="margin-bottom:12px;">
                            <label style="font-size:13px;font-weight:600;color:var(--primary-color);">Review Note (optional)</label>
                            <input type="text" id="ticketReviewNote" class="sheet-url-input" placeholder="Add a note for the requester..." style="font-family:inherit;">
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button class="btn btn-success" style="flex:1;" onclick="approveTicket(${tk.id}, true)">✓ Approve Request</button>
                            <button class="btn btn-danger"  style="flex:1;" onclick="rejectTicket(${tk.id}, true)">✗ Reject Request</button>
                        </div>
                    </div>`;
            } else {
                actionsDiv.style.display = 'none';
            }

            openModal('ticketModal');
        }

        function approveTicket(ticketId, fromModal = false) {
            if (!Utils.canManageTickets()) {
                Utils.showToast('You don\'t have permission to approve requests', true);
                return;
            }
            const tk = AppState.tickets.find(t => t.id === ticketId);
            if (!tk || tk.status !== 'pending') return;
            tk.status = 'approved';
            tk.reviewedAt = new Date().toISOString();
            tk.reviewedBy = AppState.currentUser.name;
            tk.reviewNote = fromModal ? (document.getElementById('ticketReviewNote')?.value || '') : '';
            AppState.tickets = [...AppState.tickets];
            Utils.showToast('✅ Request approved!');
            if (fromModal) closeModal('ticketModal');
            loadAdminTickets();
            updatePendingTicketsBadge();
        }

        function rejectTicket(ticketId, fromModal = false) {
            if (!Utils.canManageTickets()) {
                Utils.showToast('You don\'t have permission to reject requests', true);
                return;
            }
            const tk = AppState.tickets.find(t => t.id === ticketId);
            if (!tk || tk.status !== 'pending') return;
            const note = fromModal ? (document.getElementById('ticketReviewNote')?.value || '') : '';
            if (!note && !confirm('Reject this request? Add a review note for better feedback.')) return;
            tk.status = 'rejected';
            tk.reviewedAt = new Date().toISOString();
            tk.reviewedBy = AppState.currentUser.name;
            tk.reviewNote = note;
            AppState.tickets = [...AppState.tickets];
            Utils.showToast('Request rejected');
            if (fromModal) closeModal('ticketModal');
            loadAdminTickets();
            updatePendingTicketsBadge();
        }

        function filterMyTickets(term) {
            const rows = document.querySelectorAll('#myTicketsTableContainer tr');
            rows.forEach(row => {
                row.style.display = row.textContent.toLowerCase().includes(term.toLowerCase()) ? '' : 'none';
            });
        }

        function updatePendingTicketsBadge() {
            const badge = document.getElementById('pendingTicketsBadge');
            if (!badge) return;
            const count = AppState.tickets.filter(tk => tk.status === 'pending').length;
            badge.textContent = count;
            badge.style.display = Utils.canManageTickets() && count > 0 ? 'inline' : 'none';
        }

        // ==================== FINANCIAL DASHBOARD ====================
        function loadFinancialDashboard() {
            // Render action bar for accountant / financial managers
            const bar = document.getElementById('financialActionBar');
            if (bar) {
                bar.innerHTML = Utils.canManageFinancial() ? `
                    <button class="btn btn-success" onclick="exportFinancialCSV()" style="font-size:13px;">📥 Export CSV</button>
                    <button class="btn btn-primary"  onclick="showSendFinancialReportModal()" style="font-size:13px;">📤 Send Report to Admin</button>
                ` : '';
            }

            const tickets = AppState.tickets.filter(t => t.status === 'pending' && (t.type === 'maintenance' || t.type === 'fuel'));
            const reports = AppState.reports.filter(r => r.status === 'pending' && r.expenses > 0);
            
            // Summary calculations
            const totalPendingAmount = [
                ...tickets.map(t => t.cost || 0),
                ...reports.map(r => r.expenses || 0)
            ].reduce((sum, val) => sum + val, 0);
            
            const pendingMaintenance = tickets.filter(t => t.type === 'maintenance').reduce((sum, t) => sum + (t.cost || 0), 0);
            const pendingFuel = tickets.filter(t => t.type === 'fuel').reduce((sum, t) => sum + (t.cost || 0), 0);
            const pendingExpenses = reports.reduce((sum, r) => sum + (r.expenses || 0), 0);
            
            document.getElementById('financialSummary').innerHTML = `
                <div class="summary-card">
                    <h4>Pending Financial Items</h4>
                    <div class="amount">${Utils.formatCurrency(totalPendingAmount)}</div>
                    <div class="sub">Total amount awaiting approval</div>
                </div>
                <div class="summary-card">
                    <h4>Maintenance</h4>
                    <div class="amount">${Utils.formatCurrency(pendingMaintenance)}</div>
                    <div class="sub">${tickets.filter(t => t.type === 'maintenance').length} requests</div>
                </div>
                <div class="summary-card">
                    <h4>Fuel</h4>
                    <div class="amount">${Utils.formatCurrency(pendingFuel)}</div>
                    <div class="sub">${tickets.filter(t => t.type === 'fuel').length} requests</div>
                </div>
                <div class="summary-card">
                    <h4>Expense Reports</h4>
                    <div class="amount">${Utils.formatCurrency(pendingExpenses)}</div>
                    <div class="sub">${reports.length} reports</div>
                </div>
            `;
            
            // Financial table (View Only)
            const typeFilter = document.getElementById('financialTypeFilter')?.value || '';
            let financialItems = [];
            
            // Add tickets
            tickets.forEach(t => {
                financialItems.push({
                    id: `T${t.id}`,
                    type: t.type,
                    title: t.type === 'maintenance' ? t.maintType?.replace(/_/g, ' ') : `${t.liters}L Fuel`,
                    driver: t.driverName,
                    amount: t.cost || 0,
                    date: t.submittedAt,
                    status: 'pending',
                    priority: t.priority,
                    original: t,
                    source: 'ticket'
                });
            });
            
            // Add expense reports
            reports.forEach(r => {
                financialItems.push({
                    id: `R${r.id}`,
                    type: 'report',
                    title: `${r.type} Report`,
                    driver: r.driverName,
                    amount: r.expenses || 0,
                    date: r.submittedAt,
                    status: 'pending',
                    vehicle: r.vehicleNumber,
                    original: r,
                    source: 'report'
                });
            });
            
            // Apply filter
            if (typeFilter) {
                financialItems = financialItems.filter(item => item.type === typeFilter);
            }
            
            // Sort by date (newest first)
            financialItems.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('financialTableContainer');
            if (financialItems.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <div class="empty-state-icon">💰</div>
                    <h3>No pending financial items</h3>
                    <p>All financial requests have been processed</p></div>`;
                return;
            }
            
            container.innerHTML = `<table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Driver</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Priority</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                ${financialItems.map(item => `
                    <tr class="financial-row">
                        <td data-label="ID">${item.id}</td>
                        <td data-label="Type">${item.type === 'maintenance' ? '🔧 Maintenance' : item.type === 'fuel' ? '⛽ Fuel' : '📋 Expense'}</td>
                        <td data-label="Driver">${Utils.escapeHTML(item.driver)}</td>
                        <td data-label="Description">${Utils.escapeHTML(item.title)}</td>
                        <td data-label="Amount" class="amount-pending">${Utils.formatCurrency(item.amount)}</td>
                        <td data-label="Date">${Utils.formatDate(item.date)}</td>
                        <td data-label="Priority">${item.priority ? `<span class="priority-badge priority-${item.priority}">${item.priority}</span>` : '—'}</td>
                        <td data-label="Actions" class="action-buttons">
                            <button class="btn-icon" style="background:#e3f2fd;color:#1976d2;" onclick="viewFinancialItem('${item.source}', ${item.original.id})">👁️</button>
                            ${Utils.canManageFinancial() ? `
                                <button class="btn-icon" style="background:#e8f5e9;color:#388e3c;" onclick="approveFinancialItem('${item.source}', ${item.original.id})" title="Approve">✓</button>
                                <button class="btn-icon" style="background:#ffebee;color:#c62828;" onclick="rejectFinancialItem('${item.source}', ${item.original.id})" title="Reject">✗</button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('')}
                </tbody>
            </table>`;
            
            // Financial chart
            const monthlyData = {};
            const allFinancial = [...tickets, ...reports];
            allFinancial.forEach(item => {
                const month = new Date(item.submittedAt || item.date).toLocaleString('default', { month: 'short' });
                const amount = item.cost || item.expenses || 0;
                monthlyData[month] = (monthlyData[month] || 0) + amount;
            });
            
            const chartGrid = document.getElementById('financialChartGrid');
            const maxAmount = Math.max(...Object.values(monthlyData), 1);
            
            chartGrid.innerHTML = Object.entries(monthlyData).map(([month, amount]) => `
                <div class="chart-bar-container">
                    <div class="chart-value">${Utils.formatCurrency(amount)}</div>
                    <div class="chart-bar" style="height: ${(amount / maxAmount) * 150}px; background: linear-gradient(135deg, #2e7d32, #4caf50);"></div>
                    <div class="chart-label">${month}</div>
                </div>
            `).join('');
        }

        function viewFinancialItem(source, id) {
            if (source === 'ticket') {
                viewTicket(id);
            } else {
                viewReport(id);
            }
        }

        function approveFinancialItem(source, id) {
            if (!Utils.canManageFinancial()) {
                Utils.showToast('You do not have permission to approve financial items', true);
                return;
            }
            if (source === 'ticket') approveTicket(id);
            else approveReport(id);
            setTimeout(loadFinancialDashboard, 500);
        }

        function rejectFinancialItem(source, id) {
            if (!Utils.canManageFinancial()) {
                Utils.showToast('You do not have permission to reject financial items', true);
                return;
            }
            if (source === 'ticket') rejectTicket(id);
            else rejectReport(id);
            setTimeout(loadFinancialDashboard, 500);
        }

        function exportFinancialCSV() {
            const tickets = AppState.tickets.filter(t => t.type === 'maintenance' || t.type === 'fuel');
            const reports = AppState.reports.filter(r => r.expenses > 0);
            const rows = [['ID','Type','Driver/Name','Description','Amount (SAR)','Status','Date','Reviewed By']];
            tickets.forEach(t => rows.push([
                `T${t.id}`, t.type, t.driverName,
                t.type === 'maintenance' ? (t.maintType||'').replace(/_/g,' ') : `${t.liters}L Fuel`,
                (t.cost||0).toFixed(2), t.status, t.submittedAt, t.reviewedBy||''
            ]));
            reports.forEach(r => rows.push([
                `R${r.id}`, 'expense_report', r.driverName,
                `${r.type} Report`, (r.expenses||0).toFixed(2), r.status, r.submittedAt, r.reviewedBy||''
            ]));
            const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
            const a = document.createElement('a');
            a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            a.download = `rihlati_financial_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            Utils.showToast('📥 Financial CSV exported');
        }

        function showSendFinancialReportModal() {
            const tickets = AppState.tickets.filter(t => t.type === 'maintenance' || t.type === 'fuel');
            const reports = AppState.reports.filter(r => r.expenses > 0);
            const pending  = [...tickets.filter(t=>t.status==='pending'),  ...reports.filter(r=>r.status==='pending')];
            const approved = [...tickets.filter(t=>t.status==='approved'), ...reports.filter(r=>r.status==='approved')];
            const pendingAmt  = pending.reduce( (s,i)=>s+(i.cost||i.expenses||0),0);
            const approvedAmt = approved.reduce((s,i)=>s+(i.cost||i.expenses||0),0);

            const existing = document.getElementById('sendFinReportModal');
            if (existing) existing.remove();
            const modal = document.createElement('div');
            modal.id = 'sendFinReportModal';
            modal.className = 'modal show';
            modal.innerHTML = `
            <div class="modal-content" style="max-width:520px;">
                <div class="modal-header">
                    <h3>📤 Send Financial Report to Admin</h3>
                    <button class="close-btn" onclick="document.getElementById('sendFinReportModal').remove()">&times;</button>
                </div>
                <div style="padding:4px 0 16px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                        <div style="background:#fff3e0;border-radius:12px;padding:14px;text-align:center;">
                            <div style="font-size:22px;font-weight:800;color:#e65100;">${pending.length}</div>
                            <div style="font-size:12px;color:#888;margin-bottom:4px;">Pending Items</div>
                            <div style="font-size:13px;font-weight:700;color:#e65100;">${Utils.formatCurrency(pendingAmt)}</div>
                        </div>
                        <div style="background:#e8f5e9;border-radius:12px;padding:14px;text-align:center;">
                            <div style="font-size:22px;font-weight:800;color:#2e7d32;">${approved.length}</div>
                            <div style="font-size:12px;color:#888;margin-bottom:4px;">Approved Items</div>
                            <div style="font-size:13px;font-weight:700;color:#2e7d32;">${Utils.formatCurrency(approvedAmt)}</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="font-weight:600;font-size:13px;color:var(--primary-color);">Note for admin (optional)</label>
                        <textarea id="finReportNote" placeholder="Summarize findings, flag anomalies, or add recommendations..." style="font-family:inherit;resize:vertical;min-height:80px;width:100%;padding:10px;border:1.5px solid #e0e0e0;border-radius:8px;font-size:13px;box-sizing:border-box;margin-top:6px;"></textarea>
                    </div>
                </div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-primary" style="flex:1;min-height:46px;" onclick="submitFinancialReport()">📤 Send to Admin</button>
                    <button class="btn btn-secondary" style="min-height:46px;" onclick="document.getElementById('sendFinReportModal').remove()">Cancel</button>
                </div>
            </div>`;
            document.body.appendChild(modal);
        }

        function submitFinancialReport() {
            const user = AppState.currentUser;
            const note = document.getElementById('finReportNote')?.value || '';
            const tickets = AppState.tickets.filter(t => t.type === 'maintenance' || t.type === 'fuel');
            const rpts    = AppState.reports.filter(r => r.expenses > 0);
            const pending  = [...tickets.filter(t=>t.status==='pending'),  ...rpts.filter(r=>r.status==='pending')];
            const approved = [...tickets.filter(t=>t.status==='approved'), ...rpts.filter(r=>r.status==='approved')];

            const finReport = {
                id: Date.now(),
                type: 'financial_summary',
                roleType: 'accountant',
                userId: user.id,
                driverName: user.name,
                date: new Date().toISOString().slice(0,10),
                pendingCount:   pending.length,
                pendingAmount:  pending.reduce( (s,i)=>s+(i.cost||i.expenses||0),0),
                approvedCount:  approved.length,
                approvedAmount: approved.reduce((s,i)=>s+(i.cost||i.expenses||0),0),
                totalItems: tickets.length + rpts.length,
                notes: note || `Financial summary submitted by ${user.name}`,
                expenses: pending.reduce((s,i)=>s+(i.cost||i.expenses||0),0),
                status: 'pending',
                submittedAt: new Date().toISOString()
            };
            AppState.reports = [finReport, ...AppState.reports];
            document.getElementById('sendFinReportModal')?.remove();
            Utils.showToast('✅ Financial report sent to admin!');
            triggerSyncAfterChange();
        }

        // ==================== SALES & MARKETING DASHBOARD ====================
        function loadSalesDashboard() {
            const campaigns = AppState.campaigns || [];
            
            // Summary calculations
            const totalBudget = campaigns.reduce((sum, c) => sum + (c.budget || 0), 0);
            const pendingCampaigns = campaigns.filter(c => c.status === 'pending').length;
            const approvedCampaigns = campaigns.filter(c => c.status === 'approved').length;
            const avgRoi = campaigns.filter(c => c.expectedRoi).reduce((sum, c) => sum + (c.expectedRoi || 0), 0) / (campaigns.filter(c => c.expectedRoi).length || 1);
            
            document.getElementById('salesSummary').innerHTML = `
                <div class="summary-card">
                    <h4>Total Campaign Budget</h4>
                    <div class="amount">${Utils.formatCurrency(totalBudget)}</div>
                    <div class="sub">Across ${campaigns.length} campaigns</div>
                </div>
                <div class="summary-card">
                    <h4>Pending Campaigns</h4>
                    <div class="amount">${pendingCampaigns}</div>
                    <div class="sub">Awaiting approval</div>
                </div>
                <div class="summary-card">
                    <h4>Approved Campaigns</h4>
                    <div class="amount">${approvedCampaigns}</div>
                    <div class="sub">Ready for execution</div>
                </div>
                <div class="summary-card">
                    <h4>Avg. Expected ROI</h4>
                    <div class="amount">${avgRoi.toFixed(1)}%</div>
                    <div class="sub">Return on investment</div>
                </div>
            `;
            
            // Campaigns table
            const container = document.getElementById('campaignRequestsTable');
            const sortedCampaigns = [...campaigns].reverse();
            
            if (sortedCampaigns.length === 0) {
                container.innerHTML = `<div class="empty-state">
                    <div class="empty-state-icon">📊</div>
                    <h3>No campaigns yet</h3>
                    <p>Click "New Campaign Request" to create your first campaign</p></div>`;
                return;
            }
            
            container.innerHTML = `<table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Campaign Name</th>
                        <th>Type</th>
                        <th>Budget</th>
                        <th>Period</th>
                        <th>Expected ROI</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                ${sortedCampaigns.map(c => `
                    <tr>
                        <td data-label="ID">#${c.id}</td>
                        <td data-label="Name">${Utils.escapeHTML(c.name)}</td>
                        <td data-label="Type">${c.type}</td>
                        <td data-label="Budget">${Utils.formatCurrency(c.budget || 0)}</td>
                        <td data-label="Period">${Utils.formatDate(c.startDate)} - ${Utils.formatDate(c.endDate)}</td>
                        <td data-label="ROI">${c.expectedRoi ? c.expectedRoi + '%' : '—'}</td>
                        <td data-label="Status"><span class="badge badge-${c.status || 'pending'}">${(c.status || 'pending').toUpperCase()}</span></td>
                        <td data-label="Actions" class="action-buttons">
                            <button class="btn-icon" style="background:#e3f2fd;color:#1976d2;" onclick="viewCampaign(${c.id})">👁️</button>
                            ${Utils.isAdmin() && c.status === 'pending' ? `
                            <button class="btn-icon" style="background:#e8f5e9;color:#388e3c;" onclick="approveCampaign(${c.id})">✓</button>
                            <button class="btn-icon" style="background:#ffebee;color:#c62828;" onclick="rejectCampaign(${c.id})">✗</button>
                            ` : ''}
                        </td>
                    </tr>
                `).join('')}
                </tbody>
            </table>`;
            
            // ROI Chart
            const roiData = campaigns.filter(c => c.expectedRoi).reduce((acc, c) => {
                acc[c.type] = (acc[c.type] || 0) + (c.expectedRoi || 0);
                return acc;
            }, {});
            
            const roiGrid = document.getElementById('roiChartGrid');
            const maxRoi = Math.max(...Object.values(roiData), 1);
            
            roiGrid.innerHTML = Object.entries(roiData).map(([type, roi]) => `
                <div class="chart-bar-container">
                    <div class="chart-value">${roi.toFixed(1)}%</div>
                    <div class="chart-bar" style="height: ${(roi / maxRoi) * 150}px; background: linear-gradient(135deg, #ad1457, #ec407a);"></div>
                    <div class="chart-label">${type}</div>
                </div>
            `).join('');
        }

        function showCampaignRequestModal() {
            document.getElementById('campaignModalTitle').textContent = '🎯 New Campaign Request';
            document.getElementById('campaignId').value = '';
            document.getElementById('campaignName').value = '';
            document.getElementById('campaignType').value = '';
            document.getElementById('campaignBudget').value = '';
            document.getElementById('campaignStartDate').value = '';
            document.getElementById('campaignEndDate').value = '';
            document.getElementById('campaignRoi').value = '';
            document.getElementById('campaignTarget').value = '';
            document.getElementById('campaignDescription').value = '';
            openModal('campaignModal');
        }

        function saveCampaignRequest(event) {
            event.preventDefault();
            
            const campaignId = document.getElementById('campaignId').value;
            const name = document.getElementById('campaignName').value.trim();
            const type = document.getElementById('campaignType').value;
            const budget = parseFloat(document.getElementById('campaignBudget').value) || 0;
            const startDate = document.getElementById('campaignStartDate').value;
            const endDate = document.getElementById('campaignEndDate').value;
            const expectedRoi = parseFloat(document.getElementById('campaignRoi').value) || null;
            const targetAudience = document.getElementById('campaignTarget').value.trim();
            const description = document.getElementById('campaignDescription').value.trim();
            
            if (!name || !type || !budget || !startDate || !endDate || !description) {
                Utils.showToast('Please fill in all required fields', true);
                return;
            }
            
            const campaign = {
                id: campaignId ? parseInt(campaignId) : Utils.generateId(AppState.campaigns),
                name,
                type,
                budget,
                startDate,
                endDate,
                expectedRoi,
                targetAudience,
                description,
                status: 'pending',
                submittedBy: AppState.currentUser.id,
                submitterName: AppState.currentUser.name,
                submittedAt: new Date().toISOString()
            };
            
            if (campaignId) {
                // Update existing campaign
                const index = AppState.campaigns.findIndex(c => c.id === parseInt(campaignId));
                if (index !== -1) {
                    AppState.campaigns[index] = { ...AppState.campaigns[index], ...campaign };
                }
            } else {
                // Create new campaign
                AppState.campaigns.push(campaign);
            }
            
            AppState.campaigns = [...AppState.campaigns];
            closeModal('campaignModal');
            loadSalesDashboard();
            Utils.showToast('Campaign request submitted successfully!');
        }

        function viewCampaign(campaignId) {
            const campaign = AppState.campaigns.find(c => c.id === campaignId);
            if (!campaign) return;
            
            const details = `
                <div style="line-height: 1.8;">
                    <p><strong>Campaign:</strong> ${Utils.escapeHTML(campaign.name)}</p>
                    <p><strong>Type:</strong> ${campaign.type}</p>
                    <p><strong>Budget:</strong> ${Utils.formatCurrency(campaign.budget)}</p>
                    <p><strong>Period:</strong> ${Utils.formatDate(campaign.startDate)} - ${Utils.formatDate(campaign.endDate)}</p>
                    <p><strong>Expected ROI:</strong> ${campaign.expectedRoi ? campaign.expectedRoi + '%' : 'N/A'}</p>
                    <p><strong>Target Audience:</strong> ${campaign.targetAudience || 'N/A'}</p>
                    <p><strong>Status:</strong> <span class="badge badge-${campaign.status}">${campaign.status.toUpperCase()}</span></p>
                    <p><strong>Submitted by:</strong> ${campaign.submitterName}</p>
                    <p><strong>Submitted at:</strong> ${Utils.formatDate(campaign.submittedAt, 'long')}</p>
                    <hr>
                    <p><strong>Description:</strong></p>
                    <p style="background: #f5f5f5; padding: 15px; border-radius: 8px;">${Utils.escapeHTML(campaign.description)}</p>
                </div>
            `;
            
            document.getElementById('financialDetailContent').innerHTML = details;
            document.getElementById('financialModalTitle').textContent = '📊 Campaign Details';
            openModal('financialModal');
        }

        function approveCampaign(campaignId) {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can approve campaigns', true);
                return;
            }
            const campaign = AppState.campaigns.find(c => c.id === campaignId);
            if (campaign && campaign.status === 'pending') {
                campaign.status = 'approved';
                campaign.reviewedAt = new Date().toISOString();
                campaign.reviewedBy = AppState.currentUser.name;
                AppState.campaigns = [...AppState.campaigns];
                loadSalesDashboard();
                Utils.showToast('Campaign approved!');
            }
        }

        function rejectCampaign(campaignId) {
            if (!Utils.isAdmin()) {
                Utils.showToast('Only admin can reject campaigns', true);
                return;
            }
            const campaign = AppState.campaigns.find(c => c.id === campaignId);
            if (campaign && campaign.status === 'pending') {
                campaign.status = 'rejected';
                campaign.reviewedAt = new Date().toISOString();
                campaign.reviewedBy = AppState.currentUser.name;
                AppState.campaigns = [...AppState.campaigns];
                loadSalesDashboard();
                Utils.showToast('Campaign rejected');
            }
        }

        // ==================== GOOGLE SHEETS SYNC FUNCTIONS ====================
        let autoSyncInterval = null;

        function setSyncStatus(state, text) {
            const el = document.getElementById('syncStatus');
            const tx = document.getElementById('syncStatusText');
            if (!el || !tx) return;
            el.className = `sync-status ${state}`;
            tx.textContent = text;
        }

        function updateLastSyncLabel() {
            const ts = DataService.getLastSync();
            const el = document.getElementById('lastSyncTime');
            if (!el) return;
            el.textContent = ts ? `Last synced: ${Utils.formatDate(ts, 'long')}` : '';
        }

        function validateSheetsUrl(input) {
            const val = input.value.trim();
            const fb  = document.getElementById('sheetsUrlFeedback');
            if (!val) {
                input.className = 'sheet-url-input';
                fb.textContent  = '';
                return false;
            }
            const valid = val.startsWith('https://script.google.com/macros/s/') && val.endsWith('/exec');
            input.className = `sheet-url-input ${valid ? 'valid' : 'invalid'}`;
            fb.textContent  = valid ? '✅ URL looks correct' : '❌ Should start with https://script.google.com/macros/s/ and end with /exec';
            fb.style.color  = valid ? '#2e7d32' : '#c62828';
            return valid;
        }

        function saveSheetsUrl() {
            const input = document.getElementById('sheetsUrlInput');
            const url   = input.value.trim();
            if (!url) { Utils.showToast('Please enter a URL', true); return; }
            if (!validateSheetsUrl(input)) { Utils.showToast('Invalid URL format', true); return; }
            DataService.setSheetsUrl(url);
            document.getElementById('syncActions').style.display = 'flex';
            setSyncStatus('syncing', 'Connecting…');
            Utils.showToast('URL saved! Testing connection…');
            testSheetsConnection();
        }

        async function testSheetsConnection() {
            const url = DataService.getSheetsUrl();
            if (!url) { Utils.showToast('No URL configured', true); return; }
            setSyncStatus('syncing', 'Testing…');
            try {
                const ok = await DataService.ping();
                if (ok) {
                    setSyncStatus('connected', 'Connected');
                    Utils.showToast('✅ Connection successful!');
                } else {
                    setSyncStatus('offline', 'Error');
                    Utils.showToast('Connection failed — check your URL', true);
                }
            } catch (e) {
                setSyncStatus('offline', 'Unreachable');
                Utils.showToast(`Connection failed: ${e.message}`, true);
            }
        }

        function disconnectSheets() {
            if (!confirm('Disconnect Google Sheets? Your local data will not be deleted.')) return;
            DataService.clearSheetsUrl();
            document.getElementById('sheetsUrlInput').value = '';
            document.getElementById('sheetsUrlInput').className = 'sheet-url-input';
            document.getElementById('sheetsUrlFeedback').textContent = '';
            document.getElementById('syncActions').style.display = 'none';
            document.getElementById('lastSyncTime').textContent = '';
            setSyncStatus('not-linked', 'Not linked');
            if (autoSyncInterval) { clearInterval(autoSyncInterval); autoSyncInterval = null; }
            document.getElementById('autoSyncToggle').checked = false;
            updateAutoSyncSlider(false);
            Utils.showToast('Google Sheets disconnected');
        }

        async function syncFromSheets() {
            if (!Utils.isAdmin()) return;
            if (!DataService.isLinked()) { Utils.showToast('No Google Sheets URL configured', true); return; }
            setSyncStatus('syncing', 'Pulling…');
            try {
                const counts = await DataService.pullFromSheets();
                // AppState.data is already updated by pullFromSheets
                setSyncStatus('connected', 'Synced');
                updateLastSyncLabel();
                Utils.showToast(`✅ Pulled from Sheets: ${counts.users} users, ${counts.reports} reports, ${counts.tickets||0} tickets`);
                if (AppState.currentUser) loadInterface();
            } catch (e) {
                setSyncStatus('offline', 'Sync failed');
                Utils.showToast(`Pull failed: ${e.message}`, true);
            }
        }

        async function syncToSheets() {
            if (!Utils.isAdmin()) return;
            if (!DataService.isLinked()) { Utils.showToast('No Google Sheets URL configured', true); return; }
            setSyncStatus('syncing', 'Pushing…');
            try {
                const result = await DataService.pushToSheets();
                setSyncStatus('connected', 'Synced');
                updateLastSyncLabel();
                Utils.showToast(`✅ All data pushed to Google Sheets`);
            } catch (e) {
                setSyncStatus('offline', 'Sync failed');
                Utils.showToast(`Push failed: ${e.message}`, true);
            }
        }

        function toggleAutoSync(enabled) {
            updateAutoSyncSlider(enabled);
            localStorage.setItem('rihlatiAutoSync', enabled ? '1' : '0');
            
            if (enabled) {
                if (!DataService.isLinked()) {
                    Utils.showToast('Please connect Google Sheets first', true);
                    document.getElementById('autoSyncToggle').checked = false;
                    updateAutoSyncSlider(false);
                    return;
                }
                
                // Clear existing interval if any
                if (autoSyncInterval) clearInterval(autoSyncInterval);
                
                // Set up interval for ALL users (sync every 2 minutes for real-time updates)
                autoSyncInterval = setInterval(async () => {
                    // Only sync if user is logged in
                    if (AppState.currentUser) {
                        await syncDataFromSheets();
                    }
                }, 2 * 60 * 1000); // 2 minutes for real-time feel
                
                Utils.showToast('Auto-sync enabled (every 2 minutes)');
            } else {
                if (autoSyncInterval) {
                    clearInterval(autoSyncInterval);
                    autoSyncInterval = null;
                }
            }
        }

        function updateAutoSyncSlider(on) {
            const slider = document.getElementById('autoSyncSlider');
            const thumb  = document.getElementById('autoSyncThumb');
            if (!slider) return;
            slider.style.background = on ? '#1a237e' : '#ccc';
            thumb.style.transform   = on ? 'translateX(22px)' : 'translateX(0)';
        }

        function initSheetsUI() {
            const url = DataService.getSheetsUrl();
            if (url) {
                document.getElementById('sheetsUrlInput').value = url;
                validateSheetsUrl(document.getElementById('sheetsUrlInput'));
                document.getElementById('syncActions').style.display = 'flex';
                
                // Show connected status for all users if Sheets is linked
                setSyncStatus('connected', 'Connected');
                
                // Test connection in background
                testSheetsConnection().catch(() => {
                    setSyncStatus('offline', 'Unreachable');
                });
            } else {
                setSyncStatus('not-linked', 'Not linked');
            }
            
            updateLastSyncLabel();
            const autoOn = localStorage.getItem('rihlatiAutoSync') === '1';
            document.getElementById('autoSyncToggle').checked = autoOn;
            updateAutoSyncSlider(autoOn);
            
            if (autoOn && url) {
                // Set up auto-sync for current user (if logged in) - 2 minutes interval
                autoSyncInterval = setInterval(async () => {
                    if (AppState.currentUser) {
                        await syncDataFromSheets();
                    }
                }, 2 * 60 * 1000);
            }
            
            updatePinStatusDisplay();
            const codeEl = document.getElementById('appsScriptCode');
            if (codeEl) codeEl.value = getAppsScriptCode();
        }

        const APPS_SCRIPT_CODE = `// ============================================================
// Rihlati — Google Apps Script Backend
// Paste this ENTIRE script into script.google.com
// Deploy as Web App: Execute as Me, Access: Anyone
// ============================================================

const SPREADSHEET_ID = ''; // Leave blank to auto-create, OR paste your Sheet ID here

function getSpreadsheet() {
  if (SPREADSHEET_ID) return SpreadsheetApp.openById(SPREADSHEET_ID);
  const files = DriveApp.getFilesByName('Rihlati Data');
  if (files.hasNext()) return SpreadsheetApp.open(files.next());
  const ss = SpreadsheetApp.create('Rihlati Data');
  ['Users','Reports','Tickets','Vehicles','Campaigns'].forEach(name => {
    if (!ss.getSheetByName(name)) ss.insertSheet(name);
  });
  ss.getSheets().forEach(s => { if (!['Users','Reports','Tickets','Vehicles','Campaigns'].includes(s.getName())) ss.deleteSheet(s); });
  return ss;
}

function sheetData(ss, name) {
  const sheet = ss.getSheetByName(name);
  if (!sheet || sheet.getLastRow() < 2) return [];
  const [headers, ...rows] = sheet.getDataRange().getValues();
  return rows.map(r => Object.fromEntries(headers.map((h,i) => [h, r[i]])));
}

function writeSheet(ss, name, data) {
  let sheet = ss.getSheetByName(name);
  if (!sheet) sheet = ss.insertSheet(name);
  sheet.clearContents();
  if (!data.length) return;
  const headers = Object.keys(data[0]);
  sheet.appendRow(headers);
  data.forEach(row => sheet.appendRow(headers.map(h => {
    const v = row[h];
    return (typeof v === 'object' && v !== null) ? JSON.stringify(v) : (v ?? '');
  })));
}

function doGet(e) {
  const action = e.parameter.action;
  const ss = getSpreadsheet();
  if (action === 'ping') return json({ ok: true, spreadsheetId: ss.getId() });
  if (action === 'getAll') return json({
    users:     sheetData(ss, 'Users'),
    reports:   sheetData(ss, 'Reports'),
    tickets:   sheetData(ss, 'Tickets'),
    vehicles:  sheetData(ss, 'Vehicles'),
    campaigns: sheetData(ss, 'Campaigns')
  });
  return json({ error: 'Unknown action: ' + action });
}

function doPost(e) {
  try {
    const body = JSON.parse(e.postData.contents);
    const ss = getSpreadsheet();
    if (body.action === 'saveAll') {
      if (body.users)     writeSheet(ss, 'Users',     body.users);
      if (body.reports)   writeSheet(ss, 'Reports',   body.reports);
      if (body.tickets)   writeSheet(ss, 'Tickets',   body.tickets);
      if (body.vehicles)  writeSheet(ss, 'Vehicles',  body.vehicles);
      if (body.campaigns) writeSheet(ss, 'Campaigns', body.campaigns);
      return json({ ok: true, saved: {
        users:     (body.users||[]).length,
        reports:   (body.reports||[]).length,
        tickets:   (body.tickets||[]).length,
        vehicles:  (body.vehicles||[]).length,
        campaigns: (body.campaigns||[]).length
      }});
    }
    return json({ error: 'Unknown action' });
  } catch(err) {
    return json({ error: err.message });
  }
}

function json(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}`;

        function getAppsScriptCode() { return APPS_SCRIPT_CODE; }

        function copyAppsScript() {
            const code = getAppsScriptCode();
            navigator.clipboard.writeText(code).then(() => {
                Utils.showToast('📋 Apps Script code copied to clipboard!');
            }).catch(() => {
                // Fallback
                const el = document.getElementById('appsScriptCode');
                el.select();
                document.execCommand('copy');
                Utils.showToast('📋 Apps Script code copied!');
            });
        }

        // ==================== PASSWORD RECOVERY ====================
        // ==================== FORGOT PASSWORD (Firebase) ====================
        function openForgotPassword() {
            document.getElementById('fpStep1').style.display = '';
            document.getElementById('fpStep2').style.display = 'none';
            document.getElementById('fpError').style.display = 'none';
            document.getElementById('fpError').textContent = '';
            // Pre-fill email if already typed
            const loginEmail = document.getElementById('loginEmail');
            const fpEmail = document.getElementById('fpEmail');
            if (loginEmail && fpEmail) fpEmail.value = loginEmail.value || '';
            document.getElementById('forgotPasswordModal').classList.add('show');
            setTimeout(() => document.getElementById('fpEmail').focus(), 100);
        }

        function closeForgotPassword() {
            document.getElementById('forgotPasswordModal').classList.remove('show');
        }

        async function sendPasswordReset() {
            const email = document.getElementById('fpEmail').value.trim();
            const errEl = document.getElementById('fpError');

            if (!email) {
                errEl.textContent = '❌ Please enter your email address.';
                errEl.style.display = 'block';
                return;
            }

            if (!window.firebaseFns || !window.auth) {
                errEl.textContent = '❌ Firebase not ready. Please wait and try again.';
                errEl.style.display = 'block';
                return;
            }

            const btn = document.querySelector('#forgotPasswordModal .btn-primary');
            btn.disabled = true;
            btn.innerHTML = '⏳ Sending…';

            try {
                // Import sendPasswordResetEmail dynamically
                const { sendPasswordResetEmail } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js');
                await sendPasswordResetEmail(window.auth, email);

                // Show success step
                document.getElementById('fpEmailSent').textContent = email;
                document.getElementById('fpStep1').style.display = 'none';
                document.getElementById('fpStep2').style.display = '';
            } catch (error) {
                let msg = 'Failed to send reset email.';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
                    msg = '❌ No account found with that email address.';
                } else if (error.code === 'auth/too-many-requests') {
                    msg = '❌ Too many requests. Please wait a few minutes and try again.';
                } else if (error.code === 'auth/network-request-failed') {
                    msg = '❌ Network error. Check your connection.';
                }
                errEl.textContent = msg;
                errEl.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '📧 Send Reset Link';
            }
        }

        // ==================== FIREBASE SETUP HELPERS ====================
        function copyFirestoreRules() {
            const code = document.getElementById('firestoreRulesCode').value;
            navigator.clipboard.writeText(code).then(() => {
                Utils.showToast('📋 Firestore rules copied!');
            }).catch(() => {
                document.getElementById('firestoreRulesCode').select();
                document.execCommand('copy');
                Utils.showToast('📋 Copied!');
            });
        }

        function checkFirebaseStatus() {
            const authInd = document.getElementById('fbAuthIndicator');
            const dbInd   = document.getElementById('fbDbIndicator');
            const userInd = document.getElementById('fbUserIndicator');
            if (!authInd) return;

            const ok  = s => `<span style="color:#2e7d32;font-weight:700;">✅ ${s}</span>`;
            const err = s => `<span style="color:#c62828;font-weight:700;">❌ ${s}</span>`;

            authInd.innerHTML = window.auth ? ok('Ready') : err('Not init');
            dbInd.innerHTML   = window.db   ? ok('Ready') : err('Not init');

            if (window.auth && window.auth.currentUser) {
                userInd.innerHTML = ok(window.auth.currentUser.email || 'Yes');
            } else {
                userInd.innerHTML = AppState.currentUser
                    ? ok(AppState.currentUser.email || AppState.currentUser.name)
                    : err('Not signed in');
            }
        }

        function openFirebaseSetup() {
            openModal('firebaseSetupModal');
            setTimeout(checkFirebaseStatus, 300);
        }

        function openRecoveryModal() {
            // Reset to step 1
            document.getElementById('recStep1').classList.add('active');
            document.getElementById('recStep2').classList.remove('active');
            document.getElementById('pinError').style.display = 'none';
            document.querySelectorAll('#pinInputs input').forEach(i => i.value = '');
            document.getElementById('recoveryModal').classList.add('show');
            setTimeout(() => document.querySelector('#pinInputs input').focus(), 100);
        }

        function closeRecoveryModal() {
            document.getElementById('recoveryModal').classList.remove('show');
        }

        function pinDigit(el, idx) {
            // Keep only last digit
            const v = el.value.toString().slice(-1);
            el.value = v;
            if (v) {
                const inputs = document.querySelectorAll('#pinInputs input');
                if (idx < 5) inputs[idx + 1].focus();
                else el.blur();
            }
        }

        function pinKey(e, idx) {
            const inputs = document.querySelectorAll('#pinInputs input');
            if (e.key === 'Backspace' && !inputs[idx].value && idx > 0) {
                inputs[idx - 1].focus();
            }
            if (e.key === 'Enter') verifyRecoveryPin();
        }

        function verifyRecoveryPin() {
            const entered = Array.from(document.querySelectorAll('#pinInputs input')).map(i => i.value).join('');
            if (entered.length < 6) {
                document.getElementById('pinError').textContent = '❌ Please enter all 6 digits.';
                document.getElementById('pinError').style.display = 'block';
                return;
            }
            const savedPin = localStorage.getItem('rihlatiRecoveryPin');
            if (!savedPin) {
                document.getElementById('pinError').textContent = '❌ No recovery PIN has been set. Contact your system administrator.';
                document.getElementById('pinError').style.display = 'block';
                return;
            }
            if (entered !== savedPin) {
                document.getElementById('pinError').textContent = '❌ Incorrect PIN. Please try again.';
                document.getElementById('pinError').style.display = 'block';
                document.querySelectorAll('#pinInputs input').forEach(i => i.value = '');
                document.querySelector('#pinInputs input').focus();
                return;
            }
            // Correct PIN — move to step 2
            const admin = AppState.users.find(u => u.role === 'admin');
            document.getElementById('recAdminUsername').textContent = admin ? admin.username : 'admin';
            document.getElementById('pinError').style.display = 'none';
            document.getElementById('recStep1').classList.remove('active');
            document.getElementById('recStep2').classList.add('active');
            document.getElementById('recNewPassword').value = '';
            document.getElementById('recConfirmPassword').value = '';
            document.getElementById('recPassError').style.display = 'none';
            setTimeout(() => document.getElementById('recNewPassword').focus(), 100);
        }

        async function resetAdminPassword() {
            const np = document.getElementById('recNewPassword').value;
            const cp = document.getElementById('recConfirmPassword').value;
            const errEl = document.getElementById('recPassError');
            if (np.length < 6) {
                errEl.textContent = 'Password must be at least 6 characters.';
                errEl.style.display = 'block'; return;
            }
            if (np !== cp) {
                errEl.textContent = 'Passwords do not match.';
                errEl.style.display = 'block'; return;
            }
            errEl.style.display = 'none';
            const hashed = await Utils.hashPassword(np);
            const admin = AppState.users.find(u => u.role === 'admin');
            if (!admin) { errEl.textContent = 'Admin user not found.'; errEl.style.display = 'block'; return; }
            admin.password = hashed;
            AppState.users = [...AppState.users];
            closeRecoveryModal();
            Utils.showToast('✅ Admin password reset successfully! Please log in with your new password.');
        }

        function saveRecoveryPin() {
            const pin = document.getElementById('newRecoveryPin')?.value?.toString().trim();
            if (!pin || pin.length !== 6 || !/^\d{6}$/.test(pin)) {
                Utils.showToast('Please enter exactly 6 digits', true); return;
            }
            localStorage.setItem('rihlatiRecoveryPin', pin);
            document.getElementById('newRecoveryPin').value = '';
            updatePinStatusDisplay();
            Utils.showToast('🔐 Recovery PIN saved! Write it down and keep it safe.');
        }

        function clearRecoveryPin() {
            if (!confirm('Remove the recovery PIN? You will not be able to recover the admin account without it.')) return;
            localStorage.removeItem('rihlatiRecoveryPin');
            updatePinStatusDisplay();
            Utils.showToast('Recovery PIN removed');
        }

        function updatePinStatusDisplay() {
            const el = document.getElementById('currentPinStatus');
            if (!el) return;
            const pin = localStorage.getItem('rihlatiRecoveryPin');
            el.innerHTML = pin
                ? `<span style="background:#e8f5e9;color:#2e7d32;padding:4px 12px;border-radius:8px;font-weight:700;font-size:13px;">✅ Recovery PIN is set (ends in …${pin.slice(-2)})</span>`
                : `<span style="background:#ffebee;color:#c62828;padding:4px 12px;border-radius:8px;font-weight:700;font-size:13px;">⚠️ No Recovery PIN set — set one now!</span>`;
            const cb = document.getElementById('clearPinBtn');
            if (cb) cb.style.display = pin ? '' : 'none';
        }

        // ==================== PERMISSION MANAGEMENT ====================

        // Current state of the modal toggles (key → true=allow, false=deny)
        let _permState = {};

        function loadPermissionsPanel() {
            if (!Utils.isAdmin()) return;
            const nonAdmins = AppState.users.filter(u => u.role !== 'admin');

            // Stats bar
            const customCount = nonAdmins.filter(u => u.customPermissions && Object.keys(u.customPermissions).length).length;
            document.getElementById('permStatsBar').innerHTML = `
                <div style="background:white;border-radius:10px;padding:10px 16px;box-shadow:var(--shadow);display:flex;gap:8px;align-items:center;">
                    <span style="font-size:22px;">👥</span>
                    <div><div style="font-size:18px;font-weight:700;color:var(--primary-color);">${nonAdmins.length}</div><div style="font-size:11px;color:#888;">Total Users</div></div>
                </div>
                <div style="background:white;border-radius:10px;padding:10px 16px;box-shadow:var(--shadow);display:flex;gap:8px;align-items:center;">
                    <span style="font-size:22px;">🔧</span>
                    <div><div style="font-size:18px;font-weight:700;color:#e65100;">${customCount}</div><div style="font-size:11px;color:#888;">Custom Permissions</div></div>
                </div>
                <div style="background:white;border-radius:10px;padding:10px 16px;box-shadow:var(--shadow);display:flex;gap:8px;align-items:center;">
                    <span style="font-size:22px;">✅</span>
                    <div><div style="font-size:18px;font-weight:700;color:#2e7d32;">${nonAdmins.length - customCount}</div><div style="font-size:11px;color:#888;">Role Defaults</div></div>
                </div>`;

            if (!nonAdmins.length) {
                document.getElementById('permUsersGrid').innerHTML = `<div class="empty-state"><div class="empty-state-icon">👥</div><h3>No users found</h3></div>`;
                return;
            }

            document.getElementById('permUsersGrid').innerHTML = nonAdmins.map(u => {
                const role = getRoleInfo(u.role);
                const effectivePerms = getEffectivePermissions(u);
                const hasCustom = u.customPermissions && Object.keys(u.customPermissions).length > 0;

                // Build permission chips (only show allowed ones, max 5 then "+N more")
                const allowedPerms = Object.entries(PERM_DEFS).filter(([k]) => effectivePerms[k]);
                const shown = allowedPerms.slice(0, 4);
                const extra = allowedPerms.length - shown.length;
                const chips = shown.map(([, d]) =>
                    `<span class="perm-chip allow">✅ ${d.label}</span>`
                ).join('') + (extra > 0 ? `<span class="perm-chip" style="background:#e8eaf6;color:#3949ab;border:1px solid #c5cae9;">+${extra} more</span>` : '');

                return `
                <div class="perm-user-card" data-username="${u.username.toLowerCase()} ${u.name.toLowerCase()}" data-role="${u.role}" data-hascustom="${hasCustom}">
                    <div class="perm-card-header">
                        <div class="perm-avatar" style="background:linear-gradient(135deg,${role.color},${role.color}99);">${u.name.charAt(0).toUpperCase()}</div>
                        <div style="flex:1;min-width:0;">
                            <div class="perm-user-name">${Utils.escapeHTML(u.name)}${hasCustom ? ' <span class="custom-badge">CUSTOM</span>' : ''}</div>
                            <div class="perm-user-meta">
                                @${Utils.escapeHTML(u.username)} ·
                                <span style="background:${role.bg};color:${role.color};padding:1px 8px;border-radius:10px;font-size:11px;font-weight:700;">${role.icon} ${Utils.escapeHTML(role.label)}</span>
                                · <span style="font-size:11px;color:${u.status === 'active' ? '#2e7d32' : '#c62828'};">${u.status === 'active' ? '🟢 Active' : '🔴 Inactive'}</span>
                            </div>
                        </div>
                        <div class="perm-card-actions">
                            <button class="btn btn-primary" style="padding:9px 16px;font-size:13px;min-height:40px;" onclick="showPermissionsModal(${u.id})">🔐 Manage</button>
                            ${hasCustom ? `<button class="btn btn-secondary" style="padding:9px 14px;font-size:13px;min-height:40px;" onclick="confirmResetPermissions('${u.id}')" title="Reset to role defaults">↺ Reset</button>` : ''}
                        </div>
                    </div>
                    <div class="perm-chips-row">
                        ${chips || '<span style="font-size:12px;color:#aaa;font-style:italic;">No permissions granted</span>'}
                    </div>
                </div>`;
            }).join('');
        }

        function filterPermUsers(term) {
            const roleFilter = document.getElementById('permRoleFilter')?.value || '';
            const statusFilter = document.getElementById('permStatusFilter')?.value || '';
            const search = (term || document.getElementById('permSearchBox')?.value || '').toLowerCase().trim();

            document.querySelectorAll('.perm-user-card').forEach(card => {
                const nameMatch = !search || card.dataset.username.includes(search);
                const roleMatch = !roleFilter || card.dataset.role === roleFilter;
                const customMatch = !statusFilter ||
                    (statusFilter === 'custom' && card.dataset.hascustom === 'true') ||
                    (statusFilter === 'default' && card.dataset.hascustom === 'false');
                card.style.display = (nameMatch && roleMatch && customMatch) ? '' : 'none';
            });
        }

        function showPermissionsModal(userId) {
            if (!Utils.isAdmin()) return;
            const user = AppState.users.find(u => String(u.id) === String(userId));
            if (!user || user.role === 'admin') return;

            const role = getRoleInfo(user.role);
            const custom = user.customPermissions || {};
            const roleDefaults = ROLES[user.role] || {};

            // Build state: each perm key → true/false (effective value)
            _permState = {};
            Object.keys(PERM_DEFS).forEach(key => {
                _permState[key] = key in custom ? custom[key] : (roleDefaults[key] || false);
            });

            document.getElementById('permModalUserId').value = userId;
            document.getElementById('permModalTitle').textContent = `🔐 ${Utils.escapeHTML(user.name)}`;
            document.getElementById('permModalSubtitle').textContent = `@${user.username} · ${role.label}`;
            document.getElementById('permModalUserInfo').innerHTML = `
                <div class="perm-avatar" style="background:linear-gradient(135deg,${role.color},${role.color}99);">${user.name.charAt(0).toUpperCase()}</div>
                <div style="flex:1;">
                    <div style="font-weight:700;font-size:15px;color:var(--primary-color);">${Utils.escapeHTML(user.name)}</div>
                    <div style="font-size:12px;color:#888;margin-top:2px;">
                        <span style="background:${role.bg};color:${role.color};padding:2px 10px;border-radius:10px;font-size:11px;font-weight:700;">${role.icon} ${Utils.escapeHTML(role.label)}</span>
                        &nbsp; ${Object.keys(custom).length ? `<span class="custom-badge">CUSTOM PERMISSIONS ACTIVE</span>` : '<span style="color:#888;">Role defaults active</span>'}
                    </div>
                </div>`;

            // Render rows per group
            [1, 2, 3].forEach(g => {
                const rows = Object.entries(PERM_DEFS).filter(([, d]) => d.group === g);
                document.getElementById(`permRows${g}`).innerHTML = rows.map(([key, def]) => {
                    const val = _permState[key];
                    const isCustom = key in custom && custom[key] !== (roleDefaults[key] || false);
                    return `
                    <div class="perm-row" id="permrow-${key}">
                        <div class="perm-row-info">
                            <div class="perm-row-label">
                                ${def.label}
                                ${isCustom ? '<span class="custom-badge">CUSTOM</span>' : ''}
                            </div>
                            <div class="perm-row-desc">${def.desc}</div>
                        </div>
                        <div class="perm-toggle-pill" id="pill-${key}">
                            <button class="perm-pill-btn allow-btn ${val ? 'selected' : ''}"
                                    onclick="setPerm('${key}', true)" id="allow-${key}" aria-label="Allow ${def.label}">
                                ✅ Allow
                            </button>
                            <div class="perm-pill-sep"></div>
                            <button class="perm-pill-btn deny-btn ${!val ? 'selected' : ''}"
                                    onclick="setPerm('${key}', false)" id="deny-${key}" aria-label="Deny ${def.label}">
                                ❌ Deny
                            </button>
                        </div>
                    </div>`;
                }).join('');
            });

            openModal('permissionModal');
        }

        function setPerm(key, value) {
            _permState[key] = value;
            const allowBtn = document.getElementById(`allow-${key}`);
            const denyBtn  = document.getElementById(`deny-${key}`);
            if (allowBtn) allowBtn.classList.toggle('selected', value === true);
            if (denyBtn)  denyBtn.classList.toggle('selected',  value === false);

            // Update custom badge visibility
            const userId = document.getElementById('permModalUserId').value;
            const user = AppState.users.find(u => String(u.id) === String(userId));
            if (!user) return;
            const roleDefault = (ROLES[user.role] || {})[key] || false;
            const row = document.getElementById(`permrow-${key}`);
            if (row) {
                const label = row.querySelector('.perm-row-label');
                const existing = label.querySelector('.custom-badge');
                const isCustomNow = value !== roleDefault;
                if (isCustomNow && !existing) {
                    label.insertAdjacentHTML('beforeend', '<span class="custom-badge">CUSTOM</span>');
                } else if (!isCustomNow && existing) {
                    existing.remove();
                }
            }
        }

        function quickPermAll(value) {
            Object.keys(PERM_DEFS).forEach(key => setPerm(key, value));
        }

        function saveUserPermissions() {
            const userId = document.getElementById('permModalUserId').value;
            const user = AppState.users.find(u => String(u.id) === String(userId));
            if (!user) return;

            const roleDefaults = ROLES[user.role] || {};
            const newCustom = {};

            // Only store overrides that differ from role default
            Object.keys(PERM_DEFS).forEach(key => {
                const val = _permState[key];
                if (val !== (roleDefaults[key] || false)) {
                    newCustom[key] = val;
                }
            });

            user.customPermissions = Object.keys(newCustom).length ? newCustom : undefined;
            AppState.users = [...AppState.users];

            closeModal('permissionModal');
            loadPermissionsPanel();
            if (document.getElementById('usersTableContainer')?.children.length) loadUsersTable();

            const grantedCount = Object.values(_permState).filter(Boolean).length;
            Utils.showToast(`✅ Permissions saved for ${user.name} — ${grantedCount} granted`);
        }

        function resetUserPermissions() {
            const userId = document.getElementById('permModalUserId').value;
            const user = AppState.users.find(u => String(u.id) === String(userId));
            if (!user) return;

            // Rebuild state from role defaults
            const roleDefaults = ROLES[user.role] || {};
            Object.keys(PERM_DEFS).forEach(key => {
                setPerm(key, roleDefaults[key] || false);
            });
            Utils.showToast('↺ Reset to role defaults — click Save to apply');
        }

        function confirmResetPermissions(userId) {
            const user = AppState.users.find(u => String(u.id) === String(userId));
            if (!user) return;
            if (!confirm(`Reset all custom permissions for ${user.name} back to their role defaults?`)) return;
            user.customPermissions = undefined;
            AppState.users = [...AppState.users];
            loadPermissionsPanel();
            Utils.showToast(`↺ ${user.name}'s permissions reset to role defaults`);
        }

        // ==================== ROLE-BASED REPORT FORMS ====================

        const ROLE_FORM_SCHEMAS = {
            driver: {
                title: '🚗 Driver Daily Report',
                color: '#f57f17', bg: '#fffde7',
                fields: `
                <div class="form-group"><label>Report Date <span class="required">*</span></label><input type="date" id="rf-date" required><div class="error-message" id="err-rf-date"></div></div>
                <div class="form-group"><label>Report Type <span class="required">*</span></label>
                    <select id="rf-type" required><option value="">Select Type</option><option value="daily">Daily Report</option><option value="incident">Incident</option><option value="fuel">Fuel Report</option></select>
                    <div class="error-message" id="err-rf-type"></div>
                </div>
                <div class="form-group"><label>Vehicle Number <span class="required">*</span></label><input type="text" id="rf-vehicle" placeholder="e.g. ABC-1234" required><div class="error-message" id="err-rf-vehicle"></div></div>
                <div class="form-group"><label>Odometer Reading (km) <span class="required">*</span></label><input type="number" id="rf-odometer" min="0" placeholder="Current reading" required><div class="error-message" id="err-rf-odometer"></div></div>
                <div class="form-group"><label>Fuel Amount (liters)</label><input type="number" id="rf-fuel" min="0" step="0.1" placeholder="Fuel consumed"></div>
                <div class="form-group"><label>Expenses (SAR)</label><input type="number" id="rf-expenses" min="0" step="0.01" placeholder="Total expenses"></div>
                <div class="form-group full-width"><label>Route / Location</label><input type="text" id="rf-route" placeholder="e.g. Riyadh → Jeddah"></div>
                <div class="form-group full-width"><label>Notes <span class="required">*</span></label><textarea id="rf-notes" placeholder="Describe your trip details..." required></textarea><div class="error-message" id="err-rf-notes"></div></div>`
            },
            maintenance_supervisor: {
                title: '🔩 Maintenance Report',
                color: '#4e342e', bg: '#efebe9',
                fields: `
                <div class="form-group"><label>Report Date <span class="required">*</span></label><input type="date" id="rf-date" required><div class="error-message" id="err-rf-date"></div></div>
                <div class="form-group"><label>Vehicle Number <span class="required">*</span></label><input type="text" id="rf-vehicle" placeholder="e.g. ABC-1234" required><div class="error-message" id="err-rf-vehicle"></div></div>
                <div class="form-section-divider">Maintenance Details</div>
                <div class="form-group"><label>Maintenance Type <span class="required">*</span></label>
                    <select id="rf-type" required><option value="">Select</option><option value="oil_change">Oil Change</option><option value="tire_change">Tire Change</option><option value="brake_service">Brake Service</option><option value="engine_repair">Engine Repair</option><option value="ac_repair">A/C Repair</option><option value="electrical">Electrical</option><option value="body_repair">Body Repair</option><option value="periodic_service">Periodic Service</option><option value="other">Other</option></select>
                </div>
                <div class="form-group"><label>Assigned Technician</label><input type="text" id="rf-tech" placeholder="Technician name"></div>
                <div class="form-group"><label>Estimated Cost (SAR) <span class="required">*</span></label><input type="number" id="rf-expenses" min="0" step="0.01" placeholder="0.00" required></div>
                <div class="form-group"><label>Priority</label>
                    <select id="rf-priority"><option value="low">🟢 Low</option><option value="medium" selected>🟡 Medium</option><option value="high">🟠 High</option><option value="urgent">🔴 Urgent</option></select>
                </div>
                <div class="form-group"><label>Next Service Date</label><input type="date" id="rf-next-service"></div>
                <div class="form-group"><label>Odometer Reading (km)</label><input type="number" id="rf-odometer" min="0" placeholder="Current reading"></div>
                <div class="form-group full-width"><label>Work Performed <span class="required">*</span></label><textarea id="rf-notes" placeholder="Describe maintenance work done, parts replaced..." required></textarea><div class="error-message" id="err-rf-notes"></div></div>
                <div class="form-group full-width"><label>Recommendations</label><textarea id="rf-route" placeholder="Any additional recommendations or observations..."></textarea></div>`
            },
            vehicle_engineer: {
                title: '🔧 Vehicle Inspection Report',
                color: '#37474f', bg: '#eceff1',
                fields: `
                <div class="form-group"><label>Report Date <span class="required">*</span></label><input type="date" id="rf-date" required><div class="error-message" id="err-rf-date"></div></div>
                <div class="form-group"><label>Vehicle Number <span class="required">*</span></label><input type="text" id="rf-vehicle" placeholder="e.g. ABC-1234" required><div class="error-message" id="err-rf-vehicle"></div></div>
                <div class="form-section-divider">Inspection Details</div>
                <div class="form-group"><label>Inspection Type <span class="required">*</span></label>
                    <select id="rf-type" required><option value="">Select</option><option value="routine">Routine Inspection</option><option value="safety">Safety Check</option><option value="pre_trip">Pre-Trip</option><option value="post_trip">Post-Trip</option><option value="annual">Annual Inspection</option></select>
                </div>
                <div class="form-group"><label>Overall Condition (1-10) <span class="required">*</span></label><input type="number" id="rf-odometer" min="1" max="10" placeholder="Rate 1-10" required></div>
                <div class="form-group"><label>Estimated Repair Cost (SAR)</label><input type="number" id="rf-expenses" min="0" step="0.01" placeholder="0.00"></div>
                <div class="form-group"><label>Fuel Level (%)</label><input type="number" id="rf-fuel" min="0" max="100" placeholder="e.g. 75"></div>
                <div class="form-group full-width"><label>Issues Found <span class="required">*</span></label><textarea id="rf-notes" placeholder="List all faults and defects found..." required></textarea><div class="error-message" id="err-rf-notes"></div></div>
                <div class="form-group full-width"><label>Recommendations</label><textarea id="rf-route" placeholder="Actions required, parts to order, next inspection date..."></textarea></div>`
            },
            driver_supervisor: {
                title: '🚦 Driver Supervisor Report',
                color: '#1565c0', bg: '#e3f2fd',
                fields: `
                <div class="form-group"><label>Report Date <span class="required">*</span></label><input type="date" id="rf-date" required><div class="error-message" id="err-rf-date"></div></div>
                <div class="form-group"><label>Report Period <span class="required">*</span></label>
                    <select id="rf-type" required><option value="">Select</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select>
                </div>
                <div class="form-section-divider">Team Overview</div>
                <div class="form-group"><label>Active Drivers on Duty</label><input type="number" id="rf-odometer" min="0" placeholder="Count"></div>
                <div class="form-group"><label>Total Fuel Used (liters)</label><input type="number" id="rf-fuel" min="0" step="0.1" placeholder="0.0"></div>
                <div class="form-group"><label>Total Expenses (SAR)</label><input type="number" id="rf-expenses" min="0" step="0.01" placeholder="0.00"></div>
                <div class="form-group full-width"><label>Routes Covered</label><input type="text" id="rf-vehicle" placeholder="e.g. Riyadh Hub, Jeddah Zone, Dammam Route"></div>
                <div class="form-group full-width"><label>Incidents / Issues <span class="required">*</span></label><textarea id="rf-notes" placeholder="Describe any incidents, driver issues, or notable events..." required></textarea><div class="error-message" id="err-rf-notes"></div></div>
                <div class="form-group full-width"><label>Actions Taken / Recommendations</label><textarea id="rf-route" placeholder="What actions were taken or are recommended..."></textarea></div>`
            },
            hr: {
                title: '🧑‍💼 HR Report',
                color: '#00695c', bg: '#e0f2f1',
                fields: `
                <div class="form-group"><label>Report Date <span class="required">*</span></label><input type="date" id="rf-date" required><div class="error-message" id="err-rf-date"></div></div>
                <div class="form-group"><label>Report Type <span class="required">*</span></label>
                    <select id="rf-type" required><option value="">Select</option><option value="headcount">Headcount Report</option><option value="attendance">Attendance Summary</option><option value="recruitment">Recruitment Update</option><option value="training">Training Report</option><option value="performance">Performance Summary</option></select>
                </div>
                <div class="form-section-divider">Workforce Data</div>
                <div class="form-group"><label>Total Employees</label><input type="number" id="rf-odometer" min="0" placeholder="Total headcount"></div>
                <div class="form-group"><label>Department</label><input type="text" id="rf-vehicle" placeholder="e.g. Operations, Fleet, Admin"></div>
                <div class="form-group"><label>New Joiners</label><input type="number" id="rf-fuel" min="0" placeholder="This period"></div>
                <div class="form-group"><label>Departures</label><input type="number" id="rf-expenses" min="0" placeholder="This period"></div>
                <div class="form-group full-width"><label>Summary <span class="required">*</span></label><textarea id="rf-notes" placeholder="Key HR activities, challenges, and highlights..." required></textarea><div class="error-message" id="err-rf-notes"></div></div>
                <div class="form-group full-width"><label>Action Items / Recommendations</label><textarea id="rf-route" placeholder="Planned actions or recommendations..."></textarea></div>`
            },
            accountant: {
                title: '🧾 Financial Report',
                color: '#2e7d32', bg: '#e8f5e9',
                fields: `
                <div class="form-group"><label>Report Date <span class="required">*</span></label><input type="date" id="rf-date" required><div class="error-message" id="err-rf-date"></div></div>
                <div class="form-group"><label>Report Type <span class="required">*</span></label>
                    <select id="rf-type" required><option value="">Select</option><option value="expense">Expense Report</option><option value="revenue">Revenue Report</option><option value="budget">Budget Review</option><option value="audit">Audit Summary</option><option value="monthly">Monthly Close</option></select>
                </div>
                <div class="form-section-divider">Financial Summary</div>
                <div class="form-group"><label>Reference Number</label><input type="text" id="rf-vehicle" placeholder="e.g. INV-2026-001"></div>
                <div class="form-group"><label>Total Amount (SAR) <span class="required">*</span></label><input type="number" id="rf-expenses" min="0" step="0.01" placeholder="0.00" required></div>
                <div class="form-group"><label>Department / Cost Center</label><input type="text" id="rf-route" placeholder="Department name"></div>
                <div class="form-group"><label>Period Covered</label><input type="text" id="rf-odometer" placeholder="e.g. Jan 2026 – Mar 2026"></div>
                <div class="form-group full-width"><label>Summary <span class="required">*</span></label><textarea id="rf-notes" placeholder="Financial summary, key variances, and observations..." required></textarea><div class="error-message" id="err-rf-notes"></div></div>`
            },
            sales_marketing: {
                title: '📣 Marketing Report',
                color: '#ad1457', bg: '#fce4ec',
                fields: `
                <div class="form-group"><label>Report Date <span class="required">*</span></label><input type="date" id="rf-date" required><div class="error-message" id="err-rf-date"></div></div>
                <div class="form-group"><label>Report Type <span class="required">*</span></label>
                    <select id="rf-type" required><option value="">Select</option><option value="campaign">Campaign Report</option><option value="event">Event Report</option><option value="monthly">Monthly Sales</option><option value="roi">ROI Analysis</option></select>
                </div>
                <div class="form-section-divider">Campaign / Activity Details</div>
                <div class="form-group full-width"><label>Campaign / Event Name <span class="required">*</span></label><input type="text" id="rf-vehicle" placeholder="Campaign or event name" required></div>
                <div class="form-group"><label>Target Audience</label><input type="text" id="rf-route" placeholder="e.g. Corporate, SME, Retail"></div>
                <div class="form-group"><label>Budget Used (SAR)</label><input type="number" id="rf-expenses" min="0" step="0.01" placeholder="0.00"></div>
                <div class="form-group"><label>Expected Revenue (SAR)</label><input type="number" id="rf-fuel" min="0" step="0.01" placeholder="0.00"></div>
                <div class="form-group"><label>ROI (%)</label><input type="number" id="rf-odometer" min="0" step="0.1" placeholder="e.g. 150"></div>
                <div class="form-group full-width"><label>Results & Summary <span class="required">*</span></label><textarea id="rf-notes" placeholder="Describe campaign results, KPIs achieved, and learnings..." required></textarea><div class="error-message" id="err-rf-notes"></div></div>`
            },
            supervisor: {
                title: '👷 Supervisor Report',
                color: '#e65100', bg: '#fff3e0',
                fields: `
                <div class="form-group"><label>Report Date <span class="required">*</span></label><input type="date" id="rf-date" required><div class="error-message" id="err-rf-date"></div></div>
                <div class="form-group"><label>Report Type <span class="required">*</span></label>
                    <select id="rf-type" required><option value="">Select</option><option value="daily">Daily Summary</option><option value="incident">Incident Report</option><option value="weekly">Weekly Overview</option></select>
                </div>
                <div class="form-section-divider">Operations Details</div>
                <div class="form-group full-width"><label>Area / Zone Covered</label><input type="text" id="rf-vehicle" placeholder="e.g. Northern Zone, Warehouse B"></div>
                <div class="form-group"><label>Team Members Present</label><input type="number" id="rf-odometer" min="0" placeholder="Count"></div>
                <div class="form-group"><label>Vehicles Supervised</label><input type="number" id="rf-fuel" min="0" placeholder="Count"></div>
                <div class="form-group"><label>Operational Cost (SAR)</label><input type="number" id="rf-expenses" min="0" step="0.01" placeholder="0.00"></div>
                <div class="form-group full-width"><label>Incidents / Key Events <span class="required">*</span></label><textarea id="rf-notes" placeholder="Report any incidents, achievements, or observations..." required></textarea><div class="error-message" id="err-rf-notes"></div></div>
                <div class="form-group full-width"><label>Recommendations</label><textarea id="rf-route" placeholder="Suggestions or actions required..."></textarea></div>`
            }
        };

        function loadRoleReportForm() {
            const user = AppState.currentUser;
            if (!user || user.role === 'admin') return;
            
            const schema = ROLE_FORM_SCHEMAS[user.role] || ROLE_FORM_SCHEMAS['driver'];
            const role = getRoleInfo(user.role);
            const container = document.getElementById('roleReportFormContainer');
            
            container.innerHTML = `
                <div class="role-form-header" style="background:${schema.bg}; color:${schema.color}; border-left:4px solid ${schema.color};">
                    <span style="font-size:22px;">${role.icon}</span>
                    <div>
                        <div>${schema.title}</div>
                        <div style="font-size:12px; font-weight:400; opacity:0.8;">${currentLang === 'ar' ? 'أرسل تقريرك لمراجعة الإدارة' : 'Submit your report for admin review'}</div>
                    </div>
                </div>
                <form id="reportForm" onsubmit="return false;">
                    <div class="form-grid">${schema.fields}</div>
                    <div style="display:flex; gap:15px; margin-top:25px;">
                        <button type="button" class="btn btn-primary" style="flex:1;" onclick="submitRoleReport()">${t('submitReportBtn')}</button>
                        <button type="button" class="btn btn-secondary" onclick="loadRoleReportForm()">${t('resetForm')}</button>
                    </div>
                </form>`;
            
            // Set today's date
            const dateField = document.getElementById('rf-date');
            if (dateField) dateField.valueAsDate = new Date();
        }

        function submitRoleReport() {
            const user = AppState.currentUser;
            const schema = ROLE_FORM_SCHEMAS[user.role] || ROLE_FORM_SCHEMAS['driver'];
            
            // Validate required fields
            let valid = true;
            document.querySelectorAll('#reportForm [required]').forEach(el => {
                const errId = `err-${el.id}`;
                const errEl = document.getElementById(errId);
                if (!el.value.trim()) {
                    el.classList.add('error');
                    if (errEl) { errEl.textContent = 'This field is required'; errEl.classList.add('show'); }
                    valid = false;
                } else {
                    el.classList.remove('error');
                    if (errEl) errEl.classList.remove('show');
                }
            });
            if (!valid) { Utils.showToast(t('fillRequired'), true); return; }
            
            // Build report object from available fields
            const getVal = id => { const el = document.getElementById(id); return el ? el.value : ''; };
            const newReport = {
                id: Utils.generateId(AppState.reports),
                userId: user.id,
                driverName: user.name,
                date: getVal('rf-date'),
                type: getVal('rf-type') || 'report',
                vehicleNumber: getVal('rf-vehicle') || 'N/A',
                odometer: parseInt(getVal('rf-odometer')) || 0,
                fuel: parseFloat(getVal('rf-fuel')) || 0,
                expenses: parseFloat(getVal('rf-expenses')) || 0,
                route: getVal('rf-route') || '',
                notes: getVal('rf-notes'),
                roleType: user.role,
                status: 'pending',
                submittedAt: new Date().toISOString(),
                reviewedAt: null
            };
            
            AppState.reports = [...AppState.reports, newReport];
            Utils.showToast(t('reportSubmitted'));
            loadRoleReportForm(); // Reset form
            
            setTimeout(() => {
                const nav = document.querySelector('.nav-item[onclick*="myReports"]');
                if (nav) nav.click();
            }, 1500);
        }

        // ==================== VEHICLE MANAGEMENT ====================

        function loadVehiclesTable() {
            const vehicles = AppState.vehicles || [];
            const statusFilter = (document.getElementById('vehicleStatusFilter')?.value || '').toLowerCase();
            const ar = currentLang === 'ar';

            // Summary cards
            const total     = vehicles.length;
            const active    = vehicles.filter(v => v.status === 'active').length;
            const inMaint   = vehicles.filter(v => v.status === 'maintenance').length;
            const totalCost = vehicles.reduce((s, v) => s + (parseFloat(v.purchasePrice) || 0), 0);

            const summaryEl = document.getElementById('vehicleSummaryCards');
            if (summaryEl) {
                summaryEl.innerHTML = `
                    <div class="stat-card"><div class="stat-header"><div><div class="stat-value">${total}</div><div class="stat-label">${ar ? 'إجمالي المركبات' : 'Total Vehicles'}</div></div><div class="stat-icon" style="background:linear-gradient(135deg,#1a237e,#3949ab);">🚗</div></div></div>
                    <div class="stat-card"><div class="stat-header"><div><div class="stat-value">${active}</div><div class="stat-label">${ar ? 'نشطة' : 'Active'}</div></div><div class="stat-icon" style="background:linear-gradient(135deg,#2e7d32,#43a047);">✅</div></div></div>
                    <div class="stat-card"><div class="stat-header"><div><div class="stat-value">${inMaint}</div><div class="stat-label">${ar ? 'تحت الصيانة' : 'In Maintenance'}</div></div><div class="stat-icon" style="background:linear-gradient(135deg,#e65100,#f57c00);">🔧</div></div></div>
                    <div class="stat-card"><div class="stat-header"><div><div class="stat-value">${Utils.formatCurrency(totalCost)}</div><div class="stat-label">${ar ? 'تكلفة الأسطول' : 'Total Fleet Cost'}</div></div><div class="stat-icon" style="background:linear-gradient(135deg,#6a1b9a,#8e24aa);">💰</div></div></div>
                `;
            }

            const filtered = statusFilter ? vehicles.filter(v => v.status === statusFilter) : vehicles;
            const container = document.getElementById('vehiclesTableContainer');
            if (!container) return;

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">🚗</div>
                        <h3>${ar ? 'لا توجد مركبات' : 'No vehicles found'}</h3>
                        <p>${ar ? 'انقر على "إضافة مركبة" لتسجيل أول مركبة' : 'Click "Add Vehicle" to register your first vehicle'}</p>
                    </div>`;
                return;
            }

            const statusBadge = (s) => {
                const map = {
                    active:      ['badge-approved', ar ? 'نشطة'        : 'Active'],
                    maintenance: ['badge-pending',  ar ? 'تحت الصيانة' : 'Maintenance'],
                    retired:     ['badge-rejected', ar ? 'متقاعدة'     : 'Retired'],
                };
                const [cls, lbl] = map[s] || ['badge-pending', s];
                return `<span class="badge ${cls}">${lbl}</span>`;
            };

            container.innerHTML = `
                <table id="vehiclesTable">
                    <thead><tr>
                        <th>${ar ? 'رقم اللوحة' : 'Plate'}</th>
                        <th>${ar ? 'الصانع / الموديل' : 'Make / Model'}</th>
                        <th>${ar ? 'السنة' : 'Year'}</th>
                        <th>${ar ? 'سعر الشراء' : 'Purchase Price'}</th>
                        <th>${ar ? 'المورد / البائع' : 'Purchased From'}</th>
                        <th>${ar ? 'تاريخ الشراء' : 'Purchase Date'}</th>
                        <th>${ar ? 'الحالة' : 'Status'}</th>
                        <th>${ar ? 'الإجراءات' : 'Actions'}</th>
                    </tr></thead>
                    <tbody id="vehiclesTableBody">
                        ${filtered.map(v => `
                        <tr data-search="${Utils.escapeHTML((v.plate||'').toLowerCase())} ${Utils.escapeHTML((v.make||'').toLowerCase())} ${Utils.escapeHTML((v.model||'').toLowerCase())} ${Utils.escapeHTML((v.purchasedFrom||'').toLowerCase())}">
                            <td><strong>${Utils.escapeHTML(v.plate || 'N/A')}</strong></td>
                            <td>${Utils.escapeHTML(v.make || '')} ${Utils.escapeHTML(v.model || '')}</td>
                            <td>${v.year || '—'}</td>
                            <td>${v.purchasePrice ? Utils.formatCurrency(parseFloat(v.purchasePrice)) : '—'}</td>
                            <td>${Utils.escapeHTML(v.purchasedFrom || '—')}</td>
                            <td>${v.purchaseDate ? Utils.formatDate(v.purchaseDate) : '—'}</td>
                            <td>${statusBadge(v.status || 'active')}</td>
                            <td class="action-buttons">
                                <button class="btn-icon" style="background:#e3f2fd;color:#1976d2;" onclick="viewVehicle('${v.id}')" title="${ar ? 'عرض' : 'View Details'}">👁️</button>
                                <button class="btn-icon" style="background:#e8f5e9;color:#388e3c;" onclick="editVehicle('${v.id}')" title="${ar ? 'تعديل' : 'Edit'}">✏️</button>
                                <button class="btn-icon" style="background:#ffebee;color:#c62828;" onclick="deleteVehicle('${v.id}')" title="${ar ? 'حذف' : 'Delete'}">🗑️</button>
                            </td>
                        </tr>`).join('')}
                    </tbody>
                </table>`;
        }

        function filterVehicles(term) {
            const rows = document.querySelectorAll('#vehiclesTableBody tr');
            const t = term.toLowerCase();
            rows.forEach(row => {
                row.style.display = (row.getAttribute('data-search') || '').includes(t) ? '' : 'none';
            });
        }

        function showAddVehicleModal() {
            document.getElementById('vehicleModalTitle').textContent = '➕ Add Vehicle';
            document.getElementById('editVehicleId').value = '';
            document.getElementById('vehicleForm').reset();
            document.getElementById('vehicleSaveError').style.display = 'none';
            // Populate driver dropdown
            _populateDriverDropdown('');
            openModal('vehicleModal');
        }

        function _populateDriverDropdown(selectedId) {
            const sel = document.getElementById('vAssignedDriver');
            const drivers = (AppState.users || []).filter(u => u.role === 'driver' && u.status === 'active');
            sel.innerHTML = `<option value="">— Unassigned —</option>` +
                drivers.map(d => `<option value="${d.id}" ${String(d.id) === String(selectedId) ? 'selected' : ''}>${Utils.escapeHTML(d.name)}</option>`).join('');
        }

        function editVehicle(vehicleId) {
            const v = (AppState.vehicles || []).find(v => String(v.id) === String(vehicleId));
            if (!v) return;
            document.getElementById('vehicleModalTitle').textContent = '✏️ Edit Vehicle';
            document.getElementById('editVehicleId').value = v.id;
            document.getElementById('vPlate').value         = v.plate || '';
            document.getElementById('vMake').value          = v.make || '';
            document.getElementById('vModel').value         = v.model || '';
            document.getElementById('vYear').value          = v.year || '';
            document.getElementById('vColor').value         = v.color || '';
            document.getElementById('vVin').value           = v.vin || '';
            document.getElementById('vFuelType').value      = v.fuelType || 'petrol';
            document.getElementById('vStatus').value        = v.status || 'active';
            document.getElementById('vOdometer').value      = v.odometer || '';
            document.getElementById('vPurchaseDate').value  = v.purchaseDate || '';
            document.getElementById('vPurchasePrice').value = v.purchasePrice || '';
            document.getElementById('vPurchasedFrom').value = v.purchasedFrom || '';
            document.getElementById('vDealerCity').value    = v.dealerCity || '';
            document.getElementById('vWarrantyExpiry').value= v.warrantyExpiry || '';
            document.getElementById('vRegExpiry').value     = v.regExpiry || '';
            document.getElementById('vInsExpiry').value     = v.insExpiry || '';
            document.getElementById('vNotes').value         = v.notes || '';
            document.getElementById('vehicleSaveError').style.display = 'none';
            _populateDriverDropdown(v.assignedDriver || '');
            openModal('vehicleModal');
        }

        function saveVehicle() {
            const errEl  = document.getElementById('vehicleSaveError');
            const showErr = (msg) => { errEl.textContent = msg; errEl.style.display = 'block'; };
            errEl.style.display = 'none';

            const plate = document.getElementById('vPlate').value.trim();
            const make  = document.getElementById('vMake').value.trim();
            const model = document.getElementById('vModel').value.trim();
            const year  = document.getElementById('vYear').value.trim();

            if (!plate) return showErr('❌ Plate number is required.');
            if (!make)  return showErr('❌ Make / Brand is required.');
            if (!model) return showErr('❌ Model is required.');
            if (!year)  return showErr('❌ Year is required.');

            const editId = document.getElementById('editVehicleId').value;
            const vehicles = AppState.vehicles || [];

            // Check duplicate plate
            const dupPlate = vehicles.find(v => v.plate.toLowerCase() === plate.toLowerCase() && String(v.id) !== String(editId));
            if (dupPlate) return showErr('❌ A vehicle with this plate number already exists.');

            const vehicleData = {
                plate:          plate,
                make:           make,
                model:          model,
                year:           parseInt(year),
                color:          document.getElementById('vColor').value.trim(),
                vin:            document.getElementById('vVin').value.trim(),
                fuelType:       document.getElementById('vFuelType').value,
                status:         document.getElementById('vStatus').value,
                odometer:       parseInt(document.getElementById('vOdometer').value) || 0,
                assignedDriver: document.getElementById('vAssignedDriver').value,
                purchaseDate:   document.getElementById('vPurchaseDate').value,
                purchasePrice:  parseFloat(document.getElementById('vPurchasePrice').value) || 0,
                purchasedFrom:  document.getElementById('vPurchasedFrom').value.trim(),
                dealerCity:     document.getElementById('vDealerCity').value.trim(),
                warrantyExpiry: document.getElementById('vWarrantyExpiry').value,
                regExpiry:      document.getElementById('vRegExpiry').value,
                insExpiry:      document.getElementById('vInsExpiry').value,
                notes:          document.getElementById('vNotes').value.trim(),
                updatedAt:      new Date().toISOString(),
            };

            if (editId) {
                const idx = vehicles.findIndex(v => String(v.id) === String(editId));
                if (idx !== -1) {
                    AppState.vehicles = vehicles.map((v, i) => i === idx ? { ...v, ...vehicleData } : v);
                }
            } else {
                vehicleData.id = Utils.generateId(vehicles);
                vehicleData.createdAt = new Date().toISOString();
                vehicleData.createdBy = AppState.currentUser?.name || 'Admin';
                AppState.vehicles = [...vehicles, vehicleData];
            }

            closeModal('vehicleModal');
            loadVehiclesTable();
            Utils.showToast(editId ? '✅ Vehicle updated!' : '✅ Vehicle added to fleet!');
        }

        function viewVehicle(vehicleId) {
            const v = (AppState.vehicles || []).find(v => String(v.id) === String(vehicleId));
            if (!v) return;

            const driver = v.assignedDriver
                ? (AppState.users || []).find(u => String(u.id) === String(v.assignedDriver))
                : null;
            const ar = currentLang === 'ar';
            const statusMap = {
                active:      ['✅', ar ? 'نشطة'        : 'Active',          '#4caf50'],
                maintenance: ['🔧', ar ? 'تحت الصيانة' : 'In Maintenance',  '#ff9800'],
                retired:     ['❌', ar ? 'متقاعدة'     : 'Retired',         '#f44336'],
            };
            const [sIcon, sLabel, sColor] = statusMap[v.status] || ['❓', v.status, '#999'];

            const row = (label, val) => val ? `<div style="display:flex;padding:10px 0;border-bottom:1px solid #f0f0f0;gap:12px;${ar ? 'flex-direction:row-reverse;' : ''}">
                <div style="width:160px;color:#888;font-size:13px;flex-shrink:0;${ar ? 'text-align:right;' : ''}">${label}</div>
                <div style="font-weight:500;flex:1;${ar ? 'text-align:right;' : ''}">${val}</div></div>` : '';

            document.getElementById('vehicleDetailContent').innerHTML = `
                <div style="display:flex;align-items:center;gap:16px;padding:16px;background:linear-gradient(135deg,#1a237e,#3949ab);border-radius:12px;color:white;margin-bottom:20px;${ar ? 'flex-direction:row-reverse;text-align:right;' : ''}">
                    <div style="font-size:48px;">🚗</div>
                    <div>
                        <div style="font-size:22px;font-weight:700;">${Utils.escapeHTML(v.plate)}</div>
                        <div style="opacity:0.85;">${Utils.escapeHTML(v.make)} ${Utils.escapeHTML(v.model)} · ${v.year || ''}</div>
                        <div style="margin-top:6px;"><span style="background:${sColor};padding:3px 10px;border-radius:10px;font-size:12px;">${sIcon} ${sLabel}</span></div>
                    </div>
                </div>
                <div style="margin-bottom:8px;font-weight:700;color:var(--primary-color);font-size:13px;text-transform:uppercase;letter-spacing:.5px;${ar ? 'text-align:right;' : ''}">${ar ? 'معلومات المركبة' : 'Vehicle Info'}</div>
                ${row(ar ? 'اللون' : 'Color', Utils.escapeHTML(v.color || ''))}
                ${row(ar ? 'رقم الهيكل' : 'VIN / Chassis', Utils.escapeHTML(v.vin || ''))}
                ${row(ar ? 'نوع الوقود' : 'Fuel Type', (v.fuelType||'').charAt(0).toUpperCase()+(v.fuelType||'').slice(1))}
                ${row(ar ? 'عداد الكيلومتر' : 'Odometer', v.odometer ? `${v.odometer.toLocaleString()} km` : '')}
                ${row(ar ? 'السائق المخصص' : 'Assigned Driver', driver ? Utils.escapeHTML(driver.name) : (v.assignedDriver ? (ar ? 'غير معروف' : 'Unknown') : (ar ? 'غير محدد' : 'Unassigned')))}

                <div style="margin:16px 0 8px;font-weight:700;color:var(--primary-color);font-size:13px;text-transform:uppercase;letter-spacing:.5px;${ar ? 'text-align:right;' : ''}">${ar ? 'معلومات الشراء' : 'Purchase Details'}</div>
                ${row(ar ? 'تاريخ الشراء' : 'Purchase Date', v.purchaseDate ? Utils.formatDate(v.purchaseDate) : '')}
                ${row(ar ? 'سعر الشراء' : 'Purchase Price', v.purchasePrice ? Utils.formatCurrency(parseFloat(v.purchasePrice)) : '')}
                ${row(ar ? 'المورد / البائع' : 'Purchased From', Utils.escapeHTML(v.purchasedFrom || ''))}
                ${row(ar ? 'مدينة الموزع' : 'Dealer City', Utils.escapeHTML(v.dealerCity || ''))}
                ${row(ar ? 'انتهاء الضمان' : 'Warranty Expiry', v.warrantyExpiry ? Utils.formatDate(v.warrantyExpiry) : '')}

                <div style="margin:16px 0 8px;font-weight:700;color:var(--primary-color);font-size:13px;text-transform:uppercase;letter-spacing:.5px;${ar ? 'text-align:right;' : ''}">${ar ? 'التسجيل والتأمين' : 'Registration & Insurance'}</div>
                ${row(ar ? 'انتهاء التسجيل' : 'Registration Expiry', v.regExpiry ? Utils.formatDate(v.regExpiry) : '')}
                ${row(ar ? 'انتهاء التأمين' : 'Insurance Expiry', v.insExpiry ? Utils.formatDate(v.insExpiry) : '')}

                ${v.notes ? `<div style="margin:16px 0 8px;font-weight:700;color:var(--primary-color);font-size:13px;text-transform:uppercase;letter-spacing:.5px;${ar ? 'text-align:right;' : ''}">${ar ? 'ملاحظات' : 'Notes'}</div>
                <div style="background:#f5f5f5;padding:12px;border-radius:8px;font-size:14px;${ar ? 'text-align:right;' : ''}">${Utils.escapeHTML(v.notes)}</div>` : ''}
            `;
            openModal('vehicleDetailModal');
        }

        function deleteVehicle(vehicleId) {
            const v = (AppState.vehicles || []).find(v => String(v.id) === String(vehicleId));
            if (!v) return;
            const ar = currentLang === 'ar';
            const msg = ar
                ? `هل تريد حذف المركبة ${v.plate} (${v.make} ${v.model})؟ لا يمكن التراجع عن هذا الإجراء.`
                : `Delete vehicle ${v.plate} (${v.make} ${v.model})? This cannot be undone.`;
            if (!confirm(msg)) return;
            AppState.vehicles = (AppState.vehicles || []).filter(v => String(v.id) !== String(vehicleId));
            loadVehiclesTable();
            Utils.showToast(ar ? '🗑️ تم حذف المركبة من الأسطول.' : '🗑️ Vehicle removed from fleet.');
        }

        // ==================== BACKUP & RESTORE ====================

        function backupAllData() {
            try {
                const ar = currentLang === 'ar';
                const data = {
                    _meta: {
                        version: '2.0',
                        app: 'Rihlati',
                        exportedAt: new Date().toISOString(),
                        exportedBy: AppState.currentUser?.name || 'Admin',
                        collections: ['users','reports','tickets','vehicles','campaigns'],
                    },
                    users:     AppState.data.users     || [],
                    reports:   AppState.data.reports   || [],
                    tickets:   AppState.data.tickets   || [],
                    vehicles:  AppState.data.vehicles  || [],
                    campaigns: AppState.data.campaigns || [],
                    settings: {
                        recoveryPin: localStorage.getItem('rihlati_recovery_pin') || null,
                        lang:        localStorage.getItem('rihlatiLang')           || 'en',
                    }
                };

                const json     = JSON.stringify(data, null, 2);
                const blob     = new Blob([json], { type: 'application/json' });
                const url      = URL.createObjectURL(blob);
                const dateStr  = new Date().toISOString().slice(0,10);
                const filename = `rihlati-backup-${dateStr}.json`;

                const a  = document.createElement('a');
                a.href   = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // Save last backup timestamp
                const now = new Date().toLocaleString(ar ? 'ar-SA' : 'en-US');
                localStorage.setItem('rihlatiLastBackup', now);
                updateLastBackupInfo();

                const counts = `${data.users.length} users · ${data.reports.length} reports · ${data.vehicles.length} vehicles · ${data.tickets.length} tickets`;
                Utils.showToast(ar
                    ? `✅ تم تنزيل النسخة الاحتياطية — ${counts}`
                    : `✅ Backup downloaded — ${counts}`);
            } catch(e) {
                Utils.showToast(currentLang === 'ar'
                    ? '❌ فشل تنزيل النسخة الاحتياطية'
                    : '❌ Backup failed: ' + e.message, true);
            }
        }

        function updateLastBackupInfo() {
            const el   = document.getElementById('lastBackupInfo');
            const txt  = document.getElementById('lastBackupText');
            const last = localStorage.getItem('rihlatiLastBackup');
            const ar   = currentLang === 'ar';
            if (el && txt && last) {
                txt.textContent = (ar ? '🕒 آخر نسخة احتياطية: ' : '🕒 Last backup: ') + last;
                el.style.display = 'block';
            }
        }

        async function restoreFromBackup(input) {
            const ar     = currentLang === 'ar';
            const file   = input.files[0];
            const status = document.getElementById('restoreStatus');
            if (!file) return;

            // Reset file input so same file can be re-selected
            input.value = '';

            if (!file.name.endsWith('.json')) {
                showRestoreStatus(ar ? '❌ يرجى اختيار ملف JSON صالح' : '❌ Please select a valid .json backup file', 'error');
                return;
            }

            const confirmed = confirm(ar
                ? `⚠️ تحذير: ستُستبدل جميع البيانات الحالية بالبيانات من الملف:
"${file.name}"

هل أنت متأكد؟`
                : `⚠️ Warning: All current data will be replaced with data from:
"${file.name}"

Are you sure? This cannot be undone.`);
            if (!confirmed) return;

            showRestoreStatus(ar ? '⏳ جارٍ استعادة البيانات…' : '⏳ Restoring data…', 'loading');

            try {
                const text = await file.text();
                const data = JSON.parse(text);

                // Validate structure
                if (!data._meta || !data.users) {
                    throw new Error(ar ? 'ملف غير صالح — لا يبدو أنه نسخة احتياطية من رحلتي' : 'Invalid file — does not appear to be a Rihlati backup');
                }

                const meta = data._meta;

                // Restore all collections to Firestore
                const tasks = [];
                if (Array.isArray(data.users))     tasks.push(DataService.saveCollection('users',     data.users));
                if (Array.isArray(data.reports))   tasks.push(DataService.saveCollection('reports',   data.reports));
                if (Array.isArray(data.tickets))   tasks.push(DataService.saveCollection('tickets',   data.tickets));
                if (Array.isArray(data.vehicles))  tasks.push(DataService.saveCollection('vehicles',  data.vehicles));
                if (Array.isArray(data.campaigns)) tasks.push(DataService.saveCollection('campaigns', data.campaigns));
                await Promise.all(tasks);

                // Update in-memory state
                if (Array.isArray(data.users))     AppState.data.users     = data.users;
                if (Array.isArray(data.reports))   AppState.data.reports   = data.reports;
                if (Array.isArray(data.tickets))   AppState.data.tickets   = data.tickets;
                if (Array.isArray(data.vehicles))  AppState.data.vehicles  = data.vehicles;
                if (Array.isArray(data.campaigns)) AppState.data.campaigns = data.campaigns;

                // Restore settings if present
                if (data.settings?.recoveryPin) localStorage.setItem('rihlati_recovery_pin', data.settings.recoveryPin);

                // Refresh UI
                refreshAllSections();

                const exportedAt = meta.exportedAt ? new Date(meta.exportedAt).toLocaleDateString(ar ? 'ar-SA' : 'en-US') : '—';
                const counts = `${(data.users||[]).length} ${ar?'مستخدم':'users'} · ${(data.reports||[]).length} ${ar?'تقرير':'reports'} · ${(data.vehicles||[]).length} ${ar?'مركبة':'vehicles'}`;

                showRestoreStatus(
                    (ar ? `✅ تمت الاستعادة بنجاح!
من نسخة بتاريخ ${exportedAt}
${counts}`
                        : `✅ Restore successful!
From backup dated ${exportedAt}
${counts}`),
                    'success'
                );
                Utils.showToast(ar ? '✅ تمت استعادة البيانات بنجاح!' : '✅ Data restored successfully!');

            } catch(e) {
                showRestoreStatus((ar ? '❌ فشلت الاستعادة: ' : '❌ Restore failed: ') + e.message, 'error');
            }
        }

        function showRestoreStatus(msg, type) {
            const el = document.getElementById('restoreStatus');
            if (!el) return;
            const colors = {
                success: { bg: '#e8f5e9', color: '#2e7d32', border: '#a5d6a7' },
                error:   { bg: '#ffebee', color: '#c62828', border: '#ef9a9a' },
                loading: { bg: '#e3f2fd', color: '#1565c0', border: '#90caf9' },
            };
            const c = colors[type] || colors.loading;
            el.style.cssText = `display:block;background:${c.bg};color:${c.color};border:1.5px solid ${c.border};padding:12px 14px;border-radius:10px;font-size:13px;white-space:pre-line;line-height:1.7;margin-top:12px;`;
            el.textContent = msg;
        }

        // Call on settings modal open
        function onSettingsOpen() {
            updateLastBackupInfo();
            // Reset restore status
            const s = document.getElementById('restoreStatus');
            if (s) s.style.display = 'none';
        }

        // ==================== KEYBOARD NAVIGATION ====================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        });

        // Focus trap in modals
        document.querySelectorAll('.modal').forEach(modal => {
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            
            if (focusableElements.length > 0) {
                const firstFocusable = focusableElements[0];
                const lastFocusable = focusableElements[focusableElements.length - 1];
                
                modal.addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        if (e.shiftKey && document.activeElement === firstFocusable) {
                            e.preventDefault();
                            lastFocusable.focus();
                        } else if (!e.shiftKey && document.activeElement === lastFocusable) {
                            e.preventDefault();
                            firstFocusable.focus();
                        }
                    }
                });
            }
        });

        // ==================== CLOSE MODALS ON OUTSIDE CLICK ====================
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        });

        // ==================== REAL-TIME SYNC (Handled by Firestore listeners) ====================
        // Cross-tab and cross-device sync is automatic via onSnapshot listeners set up after login.

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('signupForm').addEventListener('submit', handleSignup);

            // Apply saved language
            applyLanguage();

            // Initialize Google Sheets UI (optional backup)
            initSheetsUI();

            // Firebase auth state observer — runs when Firebase module loads
            // We poll until window.firebaseFns is ready (module loads async)
            function waitForFirebase() {
                if (window.firebaseFns && window.auth) {
                    const { onAuthStateChanged } = window.firebaseFns;
                    onAuthStateChanged(window.auth, async (firebaseUser) => {
                        if (firebaseUser) {
                            Utils.showLoading(true);
                            try {
                                // Load all data from Firestore first
                                const [users, reports, tickets, vehicles, campaigns] = await Promise.all([
                                    DataService.loadCollection('users'),
                                    DataService.loadCollection('reports'),
                                    DataService.loadCollection('tickets'),
                                    DataService.loadCollection('vehicles'),
                                    DataService.loadCollection('campaigns'),
                                ]);

                                // If Firestore has no users yet, seed with defaults
                                if (users.length === 0) {
                                    const defaults = DataService.initializeDefaultData();
                                    await Promise.all([
                                        DataService.saveCollection('users',     defaults.users),
                                        DataService.saveCollection('reports',   defaults.reports),
                                        DataService.saveCollection('tickets',   defaults.tickets),
                                        DataService.saveCollection('vehicles',  defaults.vehicles),
                                        DataService.saveCollection('campaigns', defaults.campaigns),
                                    ]);
                                    AppState.data.users     = defaults.users;
                                    AppState.data.reports   = defaults.reports;
                                    AppState.data.tickets   = defaults.tickets;
                                    AppState.data.vehicles  = defaults.vehicles;
                                    AppState.data.campaigns = defaults.campaigns;
                                } else {
                                    AppState.data.users     = users;
                                    AppState.data.reports   = reports;
                                    AppState.data.tickets   = tickets;
                                    AppState.data.vehicles  = vehicles;
                                    AppState.data.campaigns = campaigns;
                                }

                                // Find user profile by Firebase UID or email
                                let user = AppState.data.users.find(u => u.uid === firebaseUser.uid || u.id === firebaseUser.uid);
                                if (!user) {
                                    user = AppState.data.users.find(u => u.email === firebaseUser.email);
                                }

                                if (user && user.status === 'active') {
                                    AppState.currentUser = user;
                                    document.getElementById('loginPage').style.display = 'none';
                                    document.getElementById('appContainer').classList.add('show');
                                    document.getElementById('userName').textContent = user.name;
                                    document.getElementById('sidebarUserRole').textContent = getRoleInfo(user.role).label;
                                    document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
                                    loadInterface();

                                    // Set up real-time Firestore listeners
                                    AppState._unsubscribers = DataService.setupListeners((col) => {
                                        // Refresh UI when data changes in Firestore
                                        if (AppState.currentUser) {
                                            refreshAllSections();
                                            updatePendingTicketsBadge();
                                        }
                                    });

                                    // Firebase sync badge
                                    setSyncStatus('connected', t('syncConnected'));
                                    Utils.showToast(t('welcomeBack', user.name));
                                } else if (user && user.status === 'inactive') {
                                    if (window.firebaseFns) await window.firebaseFns.signOut(window.auth);
                                    Utils.showToast('Your account is inactive. Contact admin.', true);
                                } else {
                                    // New Firebase user not yet in system — show login
                                    Utils.showToast('Account not found. Please sign up first.', true);
                                    if (window.firebaseFns) await window.firebaseFns.signOut(window.auth);
                                }
                            } catch(e) {
                                console.error('Auth load error:', e);
                                Utils.showToast('Failed to load account data: ' + e.message, true);
                            } finally {
                                Utils.showLoading(false);
                            }
                        } else {
                            // Not logged in
                            AppState.currentUser = null;
                            document.getElementById('loginPage').style.display = 'block';
                            document.getElementById('appContainer').classList.remove('show');
                        }
                    });
                } else {
                    setTimeout(waitForFirebase, 200);
                }
            }
            waitForFirebase();
        });
    </script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { 
    getAuth, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { 
    getFirestore, 
    doc, 
    getDoc, 
    setDoc,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyD_G8W1ORtcjZdnu0yz7F2GBN_dCofueRo",
    authDomain: "mange-ab6e6.firebaseapp.com",
    projectId: "mange-ab6e6",
    storageBucket: "mange-ab6e6.firebasestorage.app",
    messagingSenderId: "436486480522",
    appId: "1:436486480522:web:4eaccb31804d95280c0373",
    measurementId: "G-ZW7D5HCMFM"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Expose to global scope so non-module scripts can use them
  window.auth = auth;
  window.db = db;

  window.firebaseFns = {
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    doc,
    getDoc,
    setDoc,
    onSnapshot
  };

  console.log('🔥 Firebase initialized successfully — Project: mange-ab6e6');
</script>

</body>
</html>
